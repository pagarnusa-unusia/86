<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SISTEM KEUANGAN & IURAN - PAGARNUSA</title>
    <link rel="icon" href="logopn.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: { pnGreen: '#1B7548', pnDark: '#0b3d26', pnAccent: '#ffcc00' },
                    borderRadius: { '4xl': '2rem', '5xl': '3rem' }
                }
            }
        }
    </script>
    <style>
        body { font-family: 'Plus Jakarta Sans', sans-serif; background-color: #F8FAFC; }
        .glass { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(20px); border-bottom: 1px solid rgba(0,0,0,0.05); }
        .gradient-pn { background: linear-gradient(135deg, #1B7548 0%, #0b3d26 100%); }
        .card-shadow { box-shadow: 0 20px 50px -12px rgba(0,0,0,0.05); }
        .animate-slide { animation: slideUp 0.3s ease-out; }
        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .progress-bar { transition: width 1.5s cubic-bezier(0.4, 0, 0.2, 1); }
        tr { transition: all 0.2s ease; }
    </style>
</head>
<body class="min-h-screen">

    <header class="sticky top-0 z-50 glass px-6 py-4 lg:px-12 flex justify-between items-center">
        <div class="flex items-center gap-4">
            <div class="w-12 h-12 flex items-center justify-center p-1 bg-white rounded-xl shadow-sm border border-slate-100">
                <img src="logopn.png" class="w-full h-full object-contain" alt="Logo">
            </div>
            <div>
                <h1 class="text-xl font-extrabold text-pnDark tracking-tight leading-none uppercase" id="display-nama">BRANKAS IURAN</h1>
                <p class="text-[10px] font-bold text-pnGreen uppercase tracking-[0.2em] mt-1">PSNU PAGARNUSA UNUSIA</p>
            </div>
        </div>
        
        <div class="flex gap-2">
            <button onclick="logout()" class="bg-white text-red-500 border border-slate-200 p-3 rounded-2xl hover:bg-red-50 transition-all shadow-sm active:scale-90" title="Keluar">
                <i class="fas fa-sign-out-alt text-lg"></i>
            </button>
            <button onclick="generateMonthlyReport()" class="bg-white text-pnGreen border border-slate-200 p-3 rounded-2xl hover:bg-pnGreen/5 transition-all shadow-sm active:scale-90" title="Laporan PDF">
                <i class="fas fa-file-pdf text-lg"></i>
            </button>
            <button onclick="openModal()" class="gradient-pn text-white px-6 py-3 rounded-2xl flex items-center gap-2 shadow-xl shadow-pnGreen/30 hover:shadow-pnGreen/50 hover:-translate-y-0.5 active:translate-y-0 transition-all text-xs font-bold uppercase tracking-wider">
                <i class="fas fa-plus-circle"></i> Tambah
            </button>
        </div>
    </header>

    <main class="p-6 lg:p-12 max-w-7xl mx-auto space-y-10">
        
        <section class="grid grid-cols-1 md:grid-cols-3 gap-6">
            <div class="bg-white p-8 rounded-[2.5rem] card-shadow border border-slate-50 group hover:border-pnGreen/20 transition-all">
                <div class="flex justify-between items-start mb-4">
                    <p class="text-[10px] font-black text-slate-400 tracking-widest uppercase">Total Kas Terkumpul</p>
                    <span class="bg-green-50 text-green-600 p-2.5 rounded-xl text-xs"><i class="fas fa-vault"></i></span>
                </div>
                <h3 id="stat-TotalMasuk" class="text-3xl font-black text-pnDark tracking-tight">Rp 0</h3>
            </div>

            <div class="bg-white p-8 rounded-[2.5rem] card-shadow border border-slate-50 relative overflow-hidden group hover:border-pnGreen/20 transition-all">
                <div class="flex justify-between items-start mb-4">
                    <p class="text-[10px] font-black text-slate-400 tracking-widest uppercase">Pencapaian Bulan Ini</p>
                    <span id="target-percent" class="bg-pnGreen/10 text-pnGreen px-2.5 py-1 rounded-lg text-[10px] font-black tracking-tighter">0%</span>
                </div>
                <h3 id="stat-BulanIni" class="text-3xl font-black text-pnGreen mb-5 tracking-tight">Rp 0</h3>
                <div class="w-full bg-slate-100 h-2.5 rounded-full overflow-hidden">
                    <div id="progress-bar-inner" class="progress-bar h-full bg-pnAccent rounded-full w-0"></div>
                </div>
                <p class="text-[10px] mt-3 text-slate-400 font-bold">Basis: <span id="total-santri-target">0</span> Santri aktif x Rp 25k</p>
            </div>

            <div class="gradient-pn p-8 rounded-[2.5rem] shadow-2xl shadow-pnDark/30 text-white relative overflow-hidden group">
                <p class="text-[10px] font-black text-white/40 tracking-widest mb-4 uppercase">Saldo Bersih (Verified)</p>
                <h3 id="stat-Saldo" class="text-4xl font-black text-pnAccent tracking-tight">Rp 0</h3>
                <i class="fas fa-wallet absolute -right-4 -bottom-4 text-8xl opacity-10 group-hover:scale-110 group-hover:-rotate-12 transition-transform duration-500"></i>
            </div>
        </section>

        <section class="bg-white p-8 rounded-[2.5rem] card-shadow border border-slate-50">
            <div class="flex items-center gap-4 mb-8">
                <div class="w-1.5 h-8 bg-pnGreen rounded-full"></div>
                <h4 class="text-lg font-black text-pnDark tracking-tighter uppercase italic">Grafik Pertumbuhan Kas</h4>
            </div>
            <div class="h-72">
                <canvas id="pemasukanChart"></canvas>
            </div>
        </section>

        <div class="bg-white rounded-[3.5rem] card-shadow overflow-hidden border border-slate-100">
            <div class="p-8 md:p-10 flex flex-col md:flex-row justify-between items-center gap-6 bg-slate-50/50 border-b border-slate-100">
                <div class="flex items-center gap-4">
                    <div class="w-10 h-10 bg-pnAccent rounded-2xl flex items-center justify-center text-pnDark shadow-sm">
                        <i class="fas fa-list-ul"></i>
                    </div>
                    <div>
                        <h4 class="text-lg font-black text-pnDark tracking-tight">Data Riwayat Transaksi</h4>
                        <p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Sinkronisasi Cloud Aktif</p>
                    </div>
                </div>
                <div class="relative w-full md:w-96 group">
                    <i class="fas fa-search absolute left-5 top-1/2 -translate-y-1/2 text-slate-300 group-focus-within:text-pnGreen transition-colors"></i>
                    <input type="text" onkeyup="filterData(this.value)" placeholder="Cari nama atau bulan..." class="w-full pl-14 pr-6 py-4 bg-white rounded-2xl border border-slate-200 focus:ring-4 focus:ring-pnGreen/10 focus:border-pnGreen outline-none text-sm font-semibold transition-all">
                </div>
            </div>

            <div class="overflow-x-auto">
                <table class="w-full text-left" id="mainTable">
                    <thead class="text-[11px] font-black text-slate-400 tracking-widest uppercase bg-white">
                        <tr>
                            <th class="px-10 py-6">Nama Anggota</th>
                            <th class="px-10 py-6">Keterangan</th>
                            <th class="px-10 py-6">Nominal</th>
                            <th class="px-10 py-6">Waktu</th>
                            <th class="px-10 py-6">Lampiran</th>
                            <th class="px-10 py-6 text-center">Status</th>
                            <th class="px-10 py-6 text-right">Tindakan</th>
                        </tr>
                    </thead>
                    <tbody id="tBody" class="text-sm divide-y divide-slate-100"></tbody>
                </table>
            </div>
            <div class="p-8 bg-slate-50/30 text-center border-t border-slate-100">
                <p class="text-[10px] font-bold text-slate-400 uppercase tracking-[0.3em]">Akhir dari baris data</p>
            </div>
        </div>
    </main>

    <div id="modal" class="fixed inset-0 z-[60] hidden flex items-center justify-center p-6 bg-pnDark/90 backdrop-blur-md">
        <div class="bg-white w-full max-w-lg rounded-[3.5rem] shadow-2xl overflow-hidden animate-slide">
            <div class="p-10 border-b border-slate-50 flex justify-between items-center bg-slate-50/50">
                <div class="flex items-center gap-3">
                    <i class="fas fa-file-invoice-dollar text-pnGreen text-2xl"></i>
                    <h3 class="font-black text-pnDark uppercase tracking-tighter text-xl">Catat Pembayaran</h3>
                </div>
                <button onclick="closeModal()" class="w-10 h-10 flex items-center justify-center rounded-full bg-white shadow-sm text-slate-300 hover:text-red-500 hover:rotate-90 transition-all duration-300">
                    <i class="fas fa-times text-lg"></i>
                </button>
            </div>
            
            <form id="iuranForm" class="p-10 space-y-6">
                <div class="space-y-2">
                    <label class="text-[10px] font-black text-slate-400 uppercase ml-2 tracking-widest">Input Nama Santri</label>
                    <input type="text" id="f-nama" required placeholder="Contoh: Muhammad Ali" class="w-full p-5 bg-slate-50 rounded-3xl border border-transparent font-bold text-sm focus:bg-white focus:border-pnGreen focus:ring-4 focus:ring-pnGreen/5 outline-none transition-all">
                </div>
                
                <div class="grid grid-cols-2 gap-5">
                    <div class="space-y-2">
                        <label class="text-[10px] font-black text-slate-400 uppercase ml-2 tracking-widest">Bulan Tagihan</label>
                        <select id="f-bulan" class="w-full p-5 bg-slate-50 rounded-3xl border border-transparent font-bold text-sm outline-none focus:bg-white focus:border-pnGreen transition-all appearance-none">
                            <option>Januari</option><option>Februari</option><option>Maret</option><option>April</option>
                            <option>Mei</option><option>Juni</option><option>Juli</option><option>Agustus</option>
                            <option>September</option><option>Oktober</option><option>November</option><option>Desember</option>
                        </select>
                    </div>
                    <div class="space-y-2">
                        <label class="text-[10px] font-black text-slate-400 uppercase ml-2 tracking-widest">Tanggal Setor</label>
                        <input type="date" id="f-tgl" required class="w-full p-5 bg-slate-50 rounded-3xl border border-transparent font-bold text-sm outline-none focus:bg-white focus:border-pnGreen transition-all">
                    </div>
                </div>

                <div class="space-y-2">
                    <label class="text-[10px] font-black text-slate-400 uppercase ml-2 tracking-widest">Jumlah Setoran</label>
                    <div class="relative">
                        <span class="absolute left-6 top-1/2 -translate-y-1/2 font-black text-pnGreen">Rp</span>
                        <input type="number" id="f-nominal" value="25000" required class="w-full pl-14 pr-6 py-5 bg-slate-50 rounded-3xl border border-transparent font-black text-2xl text-pnDark focus:bg-white focus:border-pnGreen outline-none transition-all">
                    </div>
                </div>

                <button type="submit" id="submitBtn" class="w-full py-6 gradient-pn text-white rounded-3xl font-black text-xs uppercase tracking-[0.2em] shadow-2xl shadow-pnGreen/40 hover:shadow-pnGreen/60 hover:-translate-y-1 active:translate-y-0 active:scale-95 transition-all">
                    Konfirmasi & Simpan Transaksi
                </button>
            </form>
        </div>
    </div>
<script>
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzkOhlAKxKqRJWYgZ5ajptbx1J0QstJ4jdFcJEbcrA2lTdwgEZ63JTuBC8GHNP1nZkcyQ/exec";
    const TARGET_PER_BULAN = 20000;
    let allData = [];
    let listSantri = [];
    let myChart;
    

    // 1. Validasi Sesi (KONSISTEN)
    function validateSesi() {
        const profil = localStorage.getItem('currentUserProfile');
        if (!profil) { window.location.href = 'login.html'; return; }
        const userObj = JSON.parse(profil);
        if(userObj.username) document.getElementById('display-nama').innerText = "BRANKAS " + userObj.username.toUpperCase();
    }
    validateSesi();

    function logout() { localStorage.clear(); window.location.href = 'login.html'; }

    // 2. Fetch Data (KONSISTEN)
    window.onload = fetchData;
    async function fetchData() {
        const body = document.getElementById('tBody');
        body.innerHTML = `<tr class="animate-pulse"><td colspan="7" class="p-10 text-center"><div class="flex flex-col items-center gap-2"><div class="h-4 bg-slate-100 rounded-full w-48"></div><div class="h-3 bg-slate-50 rounded-full w-32"></div></div></td></tr>`.repeat(4);

        try {
            const res = await fetch(SCRIPT_URL + "?action=read");
            const result = await res.json(); 
            allData = result.iuran || []; 
            listSantri = result.santri || []; 

            renderTable(); 
            updateStats();
            updateCharts();
        } catch (e) {
            Swal.fire('Koneksi Gagal', 'Gagal memuat data dari Cloud.', 'error');
        }
    }

    // 3. Render Table (KONSISTEN + Tampilan Baru)
    function renderTable() {
        const body = document.getElementById('tBody');
        body.innerHTML = '';
        
        allData.sort((a,b) => {
            const dateA = a.tanggal.split('/').reverse().join('-');
            const dateB = b.tanggal.split('/').reverse().join('-');
            return new Date(dateB) - new Date(dateA);
        }).forEach((item) => {
            const status = (item.status || "PENDING").toString().toUpperCase().trim();
            const isPending = status === "PENDING";
            
            let directLink = item.bukti;
            if (item.bukti && item.bukti.includes("id=")) {
                const fileId = item.bukti.split("id=")[1].split("&")[0];
                directLink = `https://lh3.googleusercontent.com/u/0/d/${fileId}`;
            }

            const tr = document.createElement('tr');
            tr.className = isPending ? "bg-amber-50/30" : "hover:bg-slate-50/50";
            
            tr.innerHTML = `
                <td class="px-10 py-5">
                    <button onclick="showDetailSantri('${item.nama}')" class="text-sm font-extrabold text-pnDark hover:text-pnGreen underline decoration-slate-200 decoration-2 underline-offset-4 transition-all">
                        ${item.nama}
                    </button>
                </td>
                <td class="px-10 py-5 text-xs font-bold text-slate-500 uppercase tracking-tighter">Iuran ${item.bulan}</td>
                <td class="px-10 py-5 text-sm font-black text-pnDark">
                    Rp ${Number(item.nominal).toLocaleString('id-ID')}
                </td>
                <td class="px-10 py-5 text-[10px] font-black text-slate-400">${item.tanggal}</td>
                <td class="px-10 py-5">
                    ${item.bukti && item.bukti.includes("http") ? 
                        `<a href="${directLink}" target="_blank" class="bg-blue-50 text-blue-600 px-3 py-1.5 rounded-lg text-[9px] font-black uppercase flex items-center gap-2 w-fit border border-blue-100 hover:bg-blue-600 hover:text-white transition-all">
                            <i class="fas fa-paperclip"></i> Lihat Bukti
                        </a>` : `<span class="text-slate-300 italic text-[10px] font-bold">Tanpa Berkas</span>`
                    }
                </td>
                <td class="px-10 py-5 text-center">
                    <span class="px-3 py-1.5 rounded-lg text-[9px] font-black tracking-widest ${isPending ? 'bg-orange-100 text-orange-600' : 'bg-green-100 text-green-700'} border ${isPending ? 'border-orange-200':'border-green-200'}">
                        ${status}
                    </span>
                </td>
                <td class="px-10 py-5 text-right space-x-2">
                    ${isPending ? 
                        `<button onclick="verifikasiIuranOtomatis('${item.id}', '${item.nama}', '${item.bulan}', '${item.nominal}', '${item.tanggal}')" class="bg-pnGreen text-white px-4 py-2 rounded-xl text-[10px] font-black hover:bg-pnDark shadow-lg shadow-pnGreen/20 transition-all uppercase">Konfirmasi</button>` :
                        `<button onclick="prosesKwitansi('${item.nama}', '${item.bulan}', '${item.nominal}', '${item.tanggal}')" title="Kirim Kwitansi" class="w-10 h-10 rounded-xl bg-slate-100 text-pnGreen hover:bg-pnGreen hover:text-white transition-all"><i class="fas fa-print"></i></button>`
                    }
                    <button onclick="hapusData('${item.id}')" title="Hapus Data" class="w-10 h-10 rounded-xl text-slate-200 hover:text-red-500 hover:bg-red-50 transition-all"><i class="fas fa-trash-alt"></i></button>
                </td>
            `;
            body.appendChild(tr);
        });
    }

    // 4. Update Stats & Target (KONSISTEN)
    function updateStats() {
        const dataValid = allData.filter(x => (x.status || "").toUpperCase() === "SUCCESS");
        const totalTerkumpul = dataValid.reduce((acc, curr) => acc + (Number(curr.nominal) || 0), 0);
        
        const d = new Date();
        const currentMonth = d.getMonth() + 1;
        const currentYear = d.getFullYear();
        
        const nominalBulanIni = dataValid.filter(x => {
            const p = x.tanggal.split('/');
            return parseInt(p[1]) === currentMonth && parseInt(p[2]) === currentYear;
        }).reduce((acc, curr) => acc + (Number(curr.nominal) || 0), 0);

        const totalAnggota = listSantri.length || 0;
        const targetBulanIni = totalAnggota * TARGET_PER_BULAN;
        const percent = targetBulanIni > 0 ? Math.round((nominalBulanIni / targetBulanIni) * 100) : 0;

        document.getElementById('stat-TotalMasuk').innerText = 'Rp ' + totalTerkumpul.toLocaleString('id-ID');
        document.getElementById('stat-BulanIni').innerText = 'Rp ' + nominalBulanIni.toLocaleString('id-ID');
        document.getElementById('stat-Saldo').innerText = 'Rp ' + totalTerkumpul.toLocaleString('id-ID');
        document.getElementById('total-santri-target').innerText = totalAnggota;
        document.getElementById('target-percent').innerText = percent + '%';
        
        // Animasi progress bar
        setTimeout(() => {
            document.getElementById('progress-bar-inner').style.width = Math.min(percent, 100) + '%';
        }, 300);
    }

    // 5. Chart Pertumbuhan (KONSISTEN)
    function updateCharts() {
        const ctx = document.getElementById('pemasukanChart').getContext('2d');
        const bulanIndo = ["Jan", "Feb", "Mar", "Apr", "Mei", "Jun", "Jul", "Ags", "Sep", "Okt", "Nov", "Des"];
        const labels = [];
        const dataValues = [];
        const d = new Date();

        for (let i = 5; i >= 0; i--) {
            let m = d.getMonth() - i;
            let y = d.getFullYear();
            if (m < 0) { m += 12; y -= 1; }
            labels.push(bulanIndo[m]);
            const total = allData.filter(x => {
                const p = x.tanggal.split('/');
                return parseInt(p[1]) === (m + 1) && parseInt(p[2]) === y && x.status === "SUCCESS";
            }).reduce((acc, curr) => acc + (Number(curr.nominal) || 0), 0);
            dataValues.push(total);
        }

        if (myChart) myChart.destroy();
        myChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Pemasukan Kas',
                    data: dataValues,
                    borderColor: '#1B7548',
                    backgroundColor: 'rgba(27, 117, 72, 0.08)',
                    borderWidth: 5,
                    pointBackgroundColor: '#ffcc00',
                    pointBorderColor: '#fff',
                    pointRadius: 6,
                    pointHoverRadius: 8,
                    tension: 0.4,
                    fill: true
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false }, tooltip: { backgroundColor: '#0b3d26', padding: 12, titleFont: { size: 10 }, bodyFont: { weight: 'bold' } } },
                scales: {
                    y: { beginAtZero: true, grid: { borderDash: [5, 5], color: '#f1f5f9' }, ticks: { font: { size: 10, weight: 'bold' }, color: '#94a3b8' } },
                    x: { grid: { display: false }, ticks: { font: { size: 10, weight: 'bold' }, color: '#94a3b8' } }
                }
            }
        });
    }

    // 6. Kwitansi PDF & WA (KONSISTEN)
    async function prosesKwitansi(nama, bulan, nominal, tgl) {
        const profil = listSantri.find(s => s.nama.toLowerCase().trim() === nama.toLowerCase().trim());
        let noWA = profil ? profil.wa : "";

        const { jsPDF } = window.jspdf;
        const doc = new jsPDF({ orientation: 'p', unit: 'mm', format: [100, 150] });
        
        // Header Kwitansi
        // 1. Kotak Hijau: Dibuat tinggi 45mm agar muat Logo + Judul
        doc.setFillColor(27, 117, 72); 
        doc.rect(0, 0, 100, 45, 'F'); 

        // 2. Logo: Berada di atas (Y=5), Ukuran 20mm
        const logoUrl = "https://lh3.googleusercontent.com/d/1drM76LlU3sdqpwo-Urq7ZULoyORC0UMQ";
        try {
            doc.addImage(logoUrl, 'PNG', 40, 5, 20, 20);
        } catch (e) {
            console.error("Gagal memuat logo");
        }

        // 3. Teks Judul: Turun ke Y=35 (Tepat di bawah logo)
        doc.setTextColor(255, 255, 255); 
        doc.setFontSize(16); 
        doc.setFont("helvetica", "bold");
        doc.text("KWITANSI DIGITAL", 50, 35, { align: "center" });

        // 4. Sub-Judul Organisasi: Turun ke Y=52 (Di bawah kotak hijau)
        doc.setTextColor(40, 40, 40); 
        doc.setFontSize(9); 
        doc.setFont("helvetica", "bold");
        doc.text("PSNU PAGARNUSA UNUSIA", 50, 52, { align: "center" });

        // 5. Garis Pembatas: Turun ke Y=55 (Agar tidak menumpuk dengan teks)
        doc.setLineWidth(0.5); 
        doc.line(15, 55, 85, 55);

        // 6. Titik Awal Data (y dimulai dari 65 agar ada jarak dari garis)
        let y = 65;        
        const details = [
            ["Atas Nama", nama.toUpperCase()], 
            ["Jenis Bayar", "Iuran " + bulan], 
            ["Tanggal", tgl], 
            ["Nominal", "Rp " + Number(nominal).toLocaleString()], 
            ["Status", "TERVERIFIKASI"]
        ];
        
        details.forEach(row => { 
            doc.setFont("helvetica", "bold"); doc.setTextColor(120, 120, 120);
            doc.text(row[0], 15, y); 
            doc.setFont("helvetica", "bold"); doc.setTextColor(27, 117, 72);
            doc.text(": " + row[1], 40, y); 
            y += 10; 
        });

        doc.setTextColor(180, 180, 180); doc.setFontSize(7);
        doc.text("Kwitansi ini sah diterbitkan oleh bendahara rayon UNUSIA.", 50, 140, { align: "center" });

        doc.save(`Kwitansi_${nama.replace(/\s+/g, '_')}.pdf`);

        // Logika WhatsApp
        if(noWA) {
            let cleanWA = noWA.toString().replace(/\D/g, '');
            if (cleanWA.startsWith('0')) cleanWA = '62' + cleanWA.slice(1);
            const msg = `*BUKTI PEMBAYARAN IURAN*%0A%0AAtas Nama: *${nama}*%0ABulan: *${bulan}*%0ANominal: *Rp ${Number(nominal).toLocaleString()}*%0AStatus: *Ubah bagian ini (Contoh:Cicil/Lunas)*%0A%0A_Terima kasih sudah berkontribusi untuk organisasi._`;
            window.open(`https://wa.me/${cleanWA}?text=${msg}`, '_blank');
        }
    }

    // 7. CRUD Ops (KONSISTEN)
    async function verifikasiIuran(id) {
        const res = await Swal.fire({ title: 'Verifikasi?', text: "Konfirmasi uang sudah diterima.", icon: 'question', showCancelButton: true, confirmButtonColor: '#1B7548' });
        if(res.isConfirmed) {
            Swal.fire({ title: 'Menyimpan...', didOpen: () => Swal.showLoading() });
            await fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify({ action: 'updateStatus', id: id, status: 'SUCCESS' }) });
            fetchData(); Swal.fire('Berhasil', 'Status diperbarui.', 'success');
        }
    }

    // Fitur Otomatisasi (Verifikasi + Kwitansi Sekaligus)
    async function verifikasiIuranOtomatis(id, nama, bulan, nominal, tgl) {
        const res = await Swal.fire({ 
            title: 'Verifikasi?', 
            text: `Verifikasi pembayaran ${nama} dan kirim bukti?`, 
            icon: 'question', 
            showCancelButton: true, 
            confirmButtonText: 'Ya, Verifikasi & Kirim',
            confirmButtonColor: '#1B7548' 
        });
        
        if(res.isConfirmed) {
            Swal.fire({ title: 'Proses Verifikasi...', allowOutsideClick: false, didOpen: () => Swal.showLoading() });
            try {
                await fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify({ action: 'updateStatus', id: id, status: 'SUCCESS' }) });
                await fetchData();
                await prosesKwitansi(nama, bulan, nominal, tgl);
                Swal.fire('Sukses', 'Data terverifikasi & Kwitansi diproses.', 'success');
            } catch (e) {
                Swal.fire('Gagal', 'Terjadi kesalahan sistem.', 'error');
            }
        }
    }

    document.getElementById('iuranForm').onsubmit = async (e) => {
        e.preventDefault();
        const btn = document.getElementById('submitBtn');
        btn.disabled = true; btn.innerHTML = "<i class='fas fa-circle-notch animate-spin'></i> Menyimpan...";
        
        const payload = { 
            id: "TRX-" + Date.now(), 
            date: document.getElementById('f-tgl').value, 
            v1: document.getElementById('f-nama').value, 
            v2: document.getElementById('f-bulan').value, 
            v3: document.getElementById('f-nominal').value, 
            status: "SUCCESS" 
        };

        try {
            await fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify({ action: 'insert', data: payload }) });
            closeModal(); 
            fetchData(); 
            Swal.fire('Tersimpan', 'Data iuran berhasil ditambahkan.', 'success');
        } catch(e) {
            Swal.fire('Gagal', 'Cek koneksi internet.', 'error');
        } finally {
            btn.disabled = false; btn.innerHTML = "Konfirmasi & Simpan";
        }
    };

    async function hapusData(id) {
        const res = await Swal.fire({ title: 'Hapus?', text: "Data tidak bisa dikembalikan!", icon: 'warning', showCancelButton: true, confirmButtonColor: '#ef4444' });
        if(res.isConfirmed) {
            Swal.fire({ title: 'Menghapus...', didOpen: () => Swal.showLoading() });
            await fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify({ action: 'delete', id: id }) });
            fetchData();
            Swal.fire('Terhapus', '', 'success');
        }
    }

    function filterData(q) {
        const rows = document.querySelectorAll('#tBody tr');
        rows.forEach(r => {
            const match = r.innerText.toLowerCase().includes(q.toLowerCase());
            r.style.display = match ? '' : 'none';
        });
    }

    function openModal() { 
        document.getElementById('modal').classList.remove('hidden'); 
        document.getElementById('f-tgl').valueAsDate = new Date(); 
    }
    
    function closeModal() { 
        document.getElementById('modal').classList.add('hidden'); 
        document.getElementById('iuranForm').reset(); 
    }

    function showDetailSantri(nama) {
        const riwayat = allData.filter(x => x.nama.toLowerCase().trim() === nama.toLowerCase().trim() && x.status === "SUCCESS");
        const total = riwayat.reduce((acc, curr) => acc + (Number(curr.nominal) || 0), 0);
        Swal.fire({
            title: nama.toUpperCase(),
            html: `
                <div class="p-6 bg-slate-50 rounded-[2rem] text-left space-y-3">
                    <div class="flex justify-between border-b border-slate-200 pb-2">
                        <span class="text-xs font-bold text-slate-400 uppercase">Nominal</span>
                        <b class="text-pnGreen">Rp ${total.toLocaleString()}</b>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-xs font-bold text-slate-400 uppercase">Frekuensi Bayar</span>
                        <b class="text-pnDark">${riwayat.length} Transaksi</b>
                    </div>
                </div>`,
            confirmButtonColor: '#1B7548',
            confirmButtonText: 'Tutup'
        });
    }

    function generateMonthlyReport() {
        const { jsPDF } = window.jspdf; const doc = new jsPDF();
        const d = new Date(); const m = d.getMonth()+1; const y = d.getFullYear();
        
        doc.setFontSize(18); doc.setTextColor(27, 117, 72);
        doc.text("LAPORAN KEUANGAN PAGARNUSA", 105, 20, { align: "center" });
        doc.setFontSize(10); doc.setTextColor(100, 100, 100);
        doc.text(`Periode: ${m}/${y} | Dicetak pada: ${new Date().toLocaleString()}`, 105, 27, { align: "center" });
        
        const dataBulanIni = allData.filter(x => {
            const p = x.tanggal.split('/');
            return parseInt(p[1]) === m && parseInt(p[2]) === y && x.status === "SUCCESS";
        });
        
        const rows = dataBulanIni.map((item, i) => [i+1, item.nama, item.bulan, item.tanggal, `Rp ${Number(item.nominal).toLocaleString()}`]);
        
        doc.autoTable({ 
            head: [['No', 'Nama Santri', 'Bulan', 'Tanggal', 'Nominal']], 
            body: rows, 
            startY: 35, 
            headStyles: {fillColor: [27, 117, 72], fontStyle: 'bold'},
            foot: [['', '', '', 'TOTAL', `Rp ${dataBulanIni.reduce((a,b)=>a+Number(b.nominal),0).toLocaleString()}`]],
            footStyles: {fillColor: [240, 240, 240], textColor: [0, 0, 0], fontStyle: 'bold'}
        });
        
        doc.save(`Laporan_Kas_PN_${m}_${y}.pdf`);
    }
</script>
</body>
</html>