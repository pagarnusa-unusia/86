<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rekap Nilai | PAGARNUSA UNUSIA</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>body { font-family: 'Poppins', sans-serif; }</style><link rel="icon" href="https://lh3.googleusercontent.com/d/1drM76LlU3sdqpwo-Urq7ZULoyORC0UMQ ">
</head>
<body class="bg-slate-50 min-h-screen flex flex-col">

    <header class="bg-[#1B7548] text-white shadow-lg p-4 sticky top-0 z-50">
        <div class="container mx-auto flex justify-between items-center">
            <div class="flex items-center space-x-3">
                <h1 class="text-xs md:text-sm font-bold uppercase tracking-wider">Rekap Nilai<br>PAGARNUSA UNUSIA</h1>
            </div>
            <a href="penilaian.html" class="bg-[#145c38] px-4 py-2 rounded-lg text-xs hover:bg-emerald-800 transition">
                <i class="fas fa-plus mr-1"></i> Input Lagi
            </a>
        </div>
    </header>

    <main class="container mx-auto px-4 py-8 flex-1">
        <div class="bg-white rounded-xl shadow-md overflow-hidden">
            <div class="p-6 border-b border-slate-100 flex flex-wrap justify-between items-center gap-4">
                <h2 class="text-lg font-bold text-slate-700">Hasil Penilaian</h2>
                <div class="flex space-x-2">
                    <button onclick="downloadExcel()" class="bg-emerald-600 text-white px-4 py-2 rounded-lg text-xs font-semibold hover:bg-emerald-700 transition">
                        <i class="fas fa-file-excel mr-1"></i> XLSX
                    </button>
                    <button onclick="hapusSemua()" class="bg-red-50 text-red-600 px-4 py-2 rounded-lg text-xs font-semibold hover:bg-red-100 transition">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>
            
            <div class="overflow-x-auto">
                <table class="w-full text-left border-collapse">
                    <thead class="bg-slate-50 text-slate-500 text-[10px] uppercase">
                        <tr>
                            <th class="p-4 border-b">Peserta</th>
                            <th class="p-4 border-b">Kriteria</th>
                            <th class="p-4 border-b text-center">Skor</th>
                            <th class="p-4 border-b text-center">Aksi</th>
                        </tr>
                    </thead>
                    <tbody id="tabelRekap" class="text-sm text-slate-600"></tbody>
                </table>
            </div>
        </div>
    </main>

    <script>
        // Peringatan Refresh
        window.addEventListener('beforeunload', (e) => {
            e.preventDefault();
            e.returnValue = '';
        });

        function tampilkanData() {
            const rekapNilai = JSON.parse(localStorage.getItem('rekapNilaiPagarNusa')) || [];
            const tabel = document.getElementById('tabelRekap');
            
            if (rekapNilai.length === 0) {
                tabel.innerHTML = `<tr><td colspan="4" class="p-10 text-center text-slate-400 italic">Kosong</td></tr>`;
                return;
            }

            // Tampilkan data terbaru di atas
            const sortedData = [...rekapNilai].reverse();

            tabel.innerHTML = sortedData.map(data => `
                <tr class="border-b border-slate-50 hover:bg-emerald-50/30 transition">
                    <td class="p-4">
                        <div class="font-bold text-slate-800">${data.nama}</div>
                        <div class="text-[10px] text-slate-400">Klp ${data.kelompok} â€¢ ${data.tanggal}</div>
                    </td>
                    <td class="p-4 text-xs font-medium uppercase text-slate-500">${data.kriteria}</td>
                    <td class="p-4 text-center">
                        <span class="inline-block px-3 py-1 rounded-full font-bold ${data.skor >= 75 ? 'bg-emerald-100 text-emerald-700' : 'bg-amber-100 text-amber-700'}">
                            ${data.skor}
                        </span>
                    </td>
                    <td class="p-4 text-center">
                        <button onclick="editSkor(${data.id})" class="text-blue-500 hover:text-blue-700 p-2">
                            <i class="fas fa-edit"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        // --- FITUR EDIT SKOR ---
        function editSkor(id) {
            let rekapNilai = JSON.parse(localStorage.getItem('rekapNilaiPagarNusa')) || [];
            const index = rekapNilai.findIndex(item => item.id === id);
            
            if (index !== -1) {
                const skorBaru = prompt(`Ubah skor untuk ${rekapNilai[index].nama}:`, rekapNilai[index].skor);
                
                if (skorBaru !== null && skorBaru !== "") {
                    // Validasi KKM lagi saat edit
                    if (parseInt(skorBaru) <= 75) {
                        const yakin = confirm("Apa anda yakin memberikan Nilai dibawah KKM?");
                        if (!yakin) return;
                    }
                    
                    rekapNilai[index].skor = skorBaru;
                    localStorage.setItem('rekapNilaiPagarNusa', JSON.stringify(rekapNilai));
                    tampilkanData();
                }
            }
        }

        function downloadExcel() {
            const rekapNilai = JSON.parse(localStorage.getItem('rekapNilaiPagarNusa')) || [];
            const worksheet = XLSX.utils.json_to_sheet(rekapNilai);
            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, "Nilai");
            XLSX.writeFile(workbook, "Rekap_Nilai.xlsx");
        }



        window.onload = tampilkanData;
    </script>
</body>

</html>
