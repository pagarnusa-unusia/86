<!DOCTYPE html>
<html lang="id" class="scroll-smooth">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Dashboard Admin | PAGARNUSA UNUSIA</title>
    <link rel="icon" href="logopn.png">

    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: { 
                extend: { 
                    colors: { 
                        primary: '#1B7548', 
                        primaryDark: '#145c38' 
                    } 
                } 
            }
        }
    </script>

    <style>
        body { font-family: 'Poppins', sans-serif; }
        .sidebar-link.active { background: #145c38; color: white; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
        .modal-active { display: flex !important; }
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade { animation: fadeInUp 0.4s ease-out; }
        #signature-pad { touch-action: none; cursor: crosshair; }
    </style>
</head>

<body class="min-h-screen bg-slate-50 dark:bg-slate-900 dark:text-slate-100">

    <header class="sticky top-0 z-50 bg-primary text-white shadow-md">
        <div class="max-w-7xl mx-auto px-4 py-3 flex justify-between items-center">
            <div class="flex items-center gap-3">
                <img src="logopn.png" class="h-10" alt="Logo">
                <div class="leading-tight">
                    <p class="text-[10px] uppercase tracking-widest opacity-80">Sistem Database</p>
                    <p class="font-bold">ADMIN PAGARNUSA</p>
                </div>
            </div>
            <div class="flex items-center gap-3">
                <button id="darkToggle" class="p-2 rounded-lg bg-white/10 hover:bg-white/20 transition-all">üåô</button>
                <a href="login.html" class="px-4 py-2 rounded-lg bg-red-600 hover:bg-red-700 text-sm font-bold transition-all">Logout</a>
            </div>
        </div>
    </header>

    <div class="max-w-7xl mx-auto px-4 py-6 flex flex-col md:flex-row gap-6">
        <aside class="md:w-64 space-y-4">
            <nav class="bg-white dark:bg-slate-800 rounded-2xl shadow-sm p-4 border border-slate-200 dark:border-slate-700">
                <p class="text-[10px] font-bold text-slate-400 uppercase mb-4 px-3">Menu Utama</p>
                <ul class="space-y-2">
                    <li><a class="sidebar-link active block px-4 py-3 rounded-xl cursor-pointer transition-all" data-target="ringkasan"><i class="fas fa-th-large mr-3 text-sm"></i>Ringkasan</a></li>
                    <li><a class="sidebar-link block px-4 py-3 rounded-xl hover:bg-emerald-50 dark:hover:bg-slate-700 cursor-pointer transition-all" data-target="peserta"><i class="fas fa-users mr-3 text-sm"></i>Kelola Peserta</a></li>
                    <li><a class="sidebar-link block px-4 py-3 rounded-xl hover:bg-emerald-50 dark:hover:bg-slate-700 cursor-pointer transition-all" data-target="statistik"><i class="fas fa-chart-line mr-3 text-sm"></i>Statistik</a></li>
                    <li><a class="sidebar-link block px-4 py-3 rounded-xl hover:bg-emerald-50 dark:hover:bg-slate-700 cursor-pointer transition-all" data-target="buat_ttd"><i class="fas fa-signature mr-3 text-sm"></i>Buat TTD</a></li>
                </ul>
            </nav>

            <div class="bg-emerald-900 text-white p-5 rounded-2xl shadow-lg relative overflow-hidden group">
                <div class="relative z-10">
                    <p class="text-[10px] uppercase opacity-70 font-bold mb-1">Status Database</p>
                    <p class="text-xs font-mono break-all" id="db_filename">Menghubungkan...</p>
                    <div class="mt-3 flex items-center gap-2">
                        <span class="w-2 h-2 bg-emerald-400 rounded-full animate-pulse"></span>
                        <span class="text-[10px] font-bold uppercase tracking-wider">Terhubung</span>
                    </div>
                </div>
                <i class="fas fa-database absolute -bottom-4 -right-4 text-6xl opacity-10 group-hover:scale-110 transition-transform"></i>
            </div>
        </aside>

        <main class="flex-1 space-y-6">
            <section id="ringkasan" class="animate-fade">
                <div class="grid grid-cols-1 sm:grid-cols-3 gap-6">
                    <div class="bg-white dark:bg-slate-800 p-6 rounded-2xl shadow-sm border-b-4 border-blue-500">
                        <p class="text-xs text-slate-500 uppercase font-bold">Total Peserta</p>
                        <p id="total" class="text-4xl font-bold mt-1">0</p>
                    </div>
                    <div class="bg-white dark:bg-slate-800 p-6 rounded-2xl shadow-sm border-b-4 border-yellow-500">
                        <p class="text-xs text-slate-500 uppercase font-bold">Pending</p>
                        <p id="panding" class="text-4xl font-bold mt-1 text-yellow-600">0</p>
                    </div>
                    <div class="bg-white dark:bg-slate-800 p-6 rounded-2xl shadow-sm border-b-4 border-emerald-500">
                        <p class="text-xs text-slate-500 uppercase font-bold">Kualifikasi</p>
                        <p id="lulus" class="text-4xl font-bold mt-1 text-emerald-600">0</p>
                    </div>
                </div>
            </section>

            <section id="peserta" class="hidden animate-fade">
                <div class="bg-white dark:bg-slate-800 rounded-2xl shadow-sm border border-slate-200 dark:border-slate-700 overflow-hidden">
                    <div class="p-4 border-b dark:border-slate-700 flex justify-between items-center bg-slate-50/50 dark:bg-slate-800/50">
                        <h2 class="font-bold text-slate-700 dark:text-slate-200">Database Peserta</h2>
                        <span class="text-[10px] bg-emerald-100 text-emerald-700 px-2 py-1 rounded-md font-bold uppercase">Live Excel Data</span>
                    </div>

                    <div class="p-4 bg-slate-50/50 dark:bg-slate-900/50 border-b dark:border-slate-700 flex flex-col md:flex-row gap-4 justify-between items-center">
                        <div class="relative w-full md:w-72">
                            <i class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 text-xs"></i>
                            <input type="text" id="searchInput" oninput="searchData()" placeholder="Cari nama peserta..." 
                                class="w-full pl-9 pr-4 py-2 rounded-xl border border-slate-200 dark:border-slate-600 bg-white dark:bg-slate-700 text-sm focus:ring-2 focus:ring-primary outline-none transition-all">
                        </div>
                        <div class="flex gap-2 w-full md:w-auto">
                            <button onclick="openTambahModal()" class="bg-primary text-white px-4 py-2 rounded-lg text-[10px] font-bold hover:bg-primaryDark transition-all">
                                <i class="fas fa-plus mr-1"></i> TAMBAH
                            </button>
                            <button onclick="exportToExcel()" class="bg-blue-600 text-white px-4 py-2 rounded-lg text-[10px] font-bold hover:bg-blue-700 transition-all">
                                <i class="fas fa-file-export mr-1"></i> EXPORT
                            </button>
                            <select id="filterStatus" onchange="searchData()" class="text-[10px] font-bold p-2 rounded-lg border border-slate-200 dark:border-slate-600 bg-white dark:bg-slate-700 outline-none">
                                <option value="">Semua Status</option>
                                <option value="Kualifikasi">Kualifikasi</option>
                                <option value="Pending">Pending</option>
                                <option value="Diskualifikasi">Diskualifikasi</option>
                            </select>
                        </div>
                    </div>

                    <div class="overflow-x-auto">
                        <table class="w-full text-sm text-left">
                            <thead class="bg-slate-50 dark:bg-slate-900 text-slate-500 uppercase text-[11px] font-bold">
                                <tr>
                                    <th class="p-4">Nama Lengkap</th>
                                    <th class="p-4 text-center">Angkatan</th>
                                    <th class="p-4 text-center">Ujian</th>
                                    <th class="p-4 text-center">Status</th>
                                    <th class="p-4 text-center">Aksi</th>
                                </tr>
                            </thead>
                            <tbody id="pesertaBody" class="divide-y dark:divide-slate-700">
                                <tr><td colspan="5" class="p-10 text-center text-slate-400 italic">Menyelaraskan data...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>

            <section id="statistik" class="hidden animate-fade">
                <div class="bg-white dark:bg-slate-800 p-8 rounded-2xl shadow-sm border border-slate-200 dark:border-slate-700">
                    <h2 class="text-center font-bold text-slate-700 dark:text-slate-200 mb-6">Persentase Status Kelulusan</h2>
                    <div class="max-w-xs mx-auto">
                        <canvas id="chartPeserta"></canvas>
                    </div>
                </div>
            </section>

            <section id="buat_ttd" class="hidden animate-fade">
                <div class="max-w-xl mx-auto">
                    <div id="main-card-ttd" class="bg-white dark:bg-slate-800 p-8 rounded-2xl shadow-sm border border-slate-200 dark:border-slate-700">
                        <div class="text-center mb-8">
                            <h2 class="text-2xl font-extrabold text-primary mb-1">Tanda Tangan Digital</h2>
                            <p class="text-xs font-bold text-slate-400 tracking-widest uppercase">PSNU PAGARNUSA UNUSIA</p>
                        </div>
                        <form id="formData" onsubmit="handleFormSubmit(event)">
                            <div class="mb-4">
                                <label class="block text-sm font-bold text-slate-700 dark:text-slate-200 mb-2">Nama Lengkap *</label>
                                <input type="text" id="nama" required class="w-full rounded-xl border border-slate-200 dark:bg-slate-700 px-4 py-3 text-sm focus:ring-4 focus:ring-primary/10 outline-none">
                            </div>
                            <div class="mb-4">
                                <label class="block text-sm font-bold text-slate-700 dark:text-slate-200 mb-2">Jabatan *</label>
                                <input type="text" id="jabatan" required class="w-full rounded-xl border border-slate-200 dark:bg-slate-700 px-4 py-3 text-sm focus:ring-4 focus:ring-primary/10 outline-none">
                            </div>
                            <div class="mb-6">
                                <label class="block text-sm font-bold text-slate-700 dark:text-slate-200 mb-2">Goreskan Tanda Tangan *</label>
                                <div class="relative bg-slate-50 dark:bg-slate-900 border-2 border-dashed border-slate-200 dark:border-slate-600 rounded-xl overflow-hidden">
                                    <canvas id="signature-pad" class="w-full h-40"></canvas>
                                    <button type="button" onclick="clearSignature()" class="absolute top-2 right-2 bg-red-100 text-red-600 text-[10px] px-2 py-1 rounded-md">Hapus</button>
                                </div>
                            </div>
                            <div class="grid grid-cols-2 gap-4 mb-6">
                                <div>
                                    <label class="block text-sm font-bold text-slate-700 dark:text-slate-200 mb-2">Tanggal *</label>
                                    <input type="date" id="tanggal" required class="w-full rounded-xl border border-slate-200 dark:bg-slate-700 px-4 py-3 text-sm outline-none">
                                </div>
                                <div>
                                    <label class="block text-sm font-bold text-slate-700 dark:text-slate-200 mb-2">Pukul *</label>
                                    <input type="time" id="pukul" required class="w-full rounded-xl border border-slate-200 dark:bg-slate-700 px-4 py-3 text-sm outline-none">
                                </div>
                            </div>
                            <button type="submit" class="w-full bg-primary text-white font-bold py-4 rounded-2xl shadow-lg hover:bg-primaryDark transition-all">Daftar & Buat QR</button>
                        </form>
                    </div>

                    <div id="download-section" class="hidden bg-white dark:bg-slate-800 rounded-2xl shadow-sm p-8 border border-slate-200 text-center">
                        <h2 class="text-xl font-bold text-primary mb-4">QR Tanda Tangan Berhasil!</h2>
                        <div id="qr-container" class="mb-6 flex justify-center"></div>
                        <button onclick="downloadQR()" class="w-full bg-primary text-white font-bold py-3 rounded-xl hover:bg-primaryDark transition-all">Unduh QR</button>
                        <button onclick="location.reload()" class="mt-4 text-xs text-slate-400 underline">Buat Baru</button>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <div id="modalTambah" class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm z-[100] hidden items-center justify-center p-4">
        <div class="bg-white dark:bg-slate-800 w-full max-w-sm rounded-3xl shadow-2xl overflow-hidden">
            <div class="p-6">
                <h3 class="text-xl font-bold text-slate-800 dark:text-white mb-4 text-center">Tambah Peserta Baru</h3>
                <div class="space-y-4">
                    <input type="text" id="addNama" placeholder="Nama Lengkap" class="w-full p-3 rounded-xl border border-slate-200 dark:bg-slate-700 text-sm outline-none">
                    <input type="text" id="addAngkatan" placeholder="Angkatan (Contoh: 2024)" class="w-full p-3 rounded-xl border border-slate-200 dark:bg-slate-700 text-sm outline-none">
                    <input type="text" id="addUjian" placeholder="Warna Sabuk / Jenis Ujian" class="w-full p-3 rounded-xl border border-slate-200 dark:bg-slate-700 text-sm outline-none">
                    <input type="email" id="addEmail" placeholder="Alamat Email (penerima notifikasi)" class="w-full p-3 rounded-xl border border-slate-200 dark:bg-slate-700 text-sm outline-none">
                    <div class="flex gap-2 pt-2">
                        <button onclick="document.getElementById('modalTambah').classList.add('hidden')" class="flex-1 py-3 text-sm font-bold text-slate-400">Batal</button>
                        <button id="btnSimpanPeserta" onclick="submitTambahPeserta()" class="flex-1 py-3 bg-primary text-white rounded-xl text-sm font-bold shadow-lg">Simpan</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="modalEdit" class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm z-[100] hidden items-center justify-center p-4">
        <div class="bg-white dark:bg-slate-800 w-full max-w-sm rounded-3xl shadow-2xl overflow-hidden animate-fade">
            <div class="p-6 text-center">
                <div class="w-16 h-16 bg-emerald-100 text-emerald-600 rounded-2xl flex items-center justify-center mx-auto mb-4">
                    <i class="fas fa-user-check text-2xl"></i>
                </div>
                <h3 class="text-xl font-bold text-slate-800 dark:text-white mb-1">Update Status</h3>
                <p id="editNama" class="text-sm text-slate-500 mb-6 font-medium italic"></p>
                
                <select id="selectStatus" class="w-full p-4 rounded-2xl border-2 border-slate-100 dark:border-slate-700 bg-slate-50 dark:bg-slate-900 font-bold text-slate-700 dark:text-slate-200 focus:border-primary outline-none transition-all mb-6">
                    <option value="Pending">üïí Pending</option>
                    <option value="Kualifikasi">‚úÖ Kualifikasi</option>
                    <option value="Diskualifikasi">‚ùå Diskualifikasi</option>
                </select>
                
                <div class="flex gap-3">
                    <button onclick="closeModal()" class="flex-1 py-4 text-sm font-bold text-slate-400 hover:text-slate-600">Batal</button>
                    <button id="btnSaveStatus" onclick="saveStatus()" class="flex-1 py-4 bg-primary text-white rounded-2xl text-sm font-bold shadow-lg">Simpan</button>
                </div>
                <p class="text-[9px] text-slate-400 mt-4 uppercase">Email kelulusan akan dikirim otomatis jika status "Kualifikasi"</p>
            </div>
        </div>
    </div>

    <footer class="text-center py-6 text-slate-400 text-[10px] tracking-widest font-bold uppercase">
        ¬© 2025 PAGARNUSA UNUSIA ‚Ä¢ Hak Cipta Dilindungi
    </footer>

    <script>
        let globalData = [];
        let myChart = null;
        let currentEditIndex = null;

        // PASTI KAN URL INI ADALAH URL WEB APP HASIL DEPLOY TERBARU ANDA
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyXQV49K1NwwHheIbI5Bl9sbEFUtrlpSlyF3NSkGJ2_CddLx-QvG7Tear6XwT1pVKeT4Q/exec";

        // Dark Mode Controller
        const html = document.documentElement;
        if (localStorage.getItem('theme') === 'dark') html.classList.add('dark');
        document.getElementById('darkToggle').onclick = () => {
            html.classList.toggle('dark');
            localStorage.setItem('theme', html.classList.contains('dark') ? 'dark' : 'light');
            if (myChart) renderChart(); 
        };

        // Navigation System
        document.querySelectorAll('.sidebar-link').forEach(link => {
            link.onclick = () => {
                document.querySelectorAll('.sidebar-link').forEach(l => l.classList.remove('active'));
                link.classList.add('active');
                document.querySelectorAll('main section').forEach(s => s.classList.add('hidden'));
                const target = link.dataset.target;
                document.getElementById(target).classList.remove('hidden');
                if (target === 'statistik') renderChart();
                if (target === 'buat_ttd') setTimeout(resizeCanvas, 100);
            };
        });

        // Data Loader
        async function loadExcelData() {
            try {
                const response = await fetch(`${SCRIPT_URL}?type=admin&nocache=${new Date().getTime()}`);
                const data = await response.json();
                if (Array.isArray(data)) {
                    globalData = data;
                    document.getElementById('db_filename').textContent = "Database Terhubung";
                    refreshUI();
                }
            } catch (err) {
                document.getElementById('pesertaBody').innerHTML = `<tr><td colspan="5" class="p-10 text-center text-red-500 italic">Gagal Sinkron Data. Periksa koneksi atau URL Script.</td></tr>`;
            }
        }

        function refreshUI() {
            searchData();
            let cPending = 0, cLulus = 0;
            globalData.forEach(p => {
                const sRaw = (p.status || p.Status || "Pending").toString().toLowerCase();
                if (sRaw.includes('pend')) cPending++;
                else if (sRaw.includes('kuali') || sRaw.includes('lulus')) cLulus++;
            });
            document.getElementById('total').textContent = globalData.length;
            document.getElementById('panding').textContent = cPending;
            document.getElementById('lulus').textContent = cLulus;
        }

        function searchData() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const filterStatus = document.getElementById('filterStatus').value.toLowerCase();
            const tbody = document.getElementById('pesertaBody');
            tbody.innerHTML = '';

            const filtered = globalData.filter(p => {
                const nama = (p.nama || p.Nama || "").toLowerCase();
                const status = (p.status || p.Status || "").toLowerCase();
                return nama.includes(searchTerm) && (filterStatus === "" || status.includes(filterStatus));
            });

            if (filtered.length === 0) {
                tbody.innerHTML = `<tr><td colspan="5" class="p-10 text-center text-slate-400 italic">Data tidak ditemukan</td></tr>`;
                return;
            }

            filtered.forEach((p) => {
                const sRaw = p.status || p.Status || "Pending";
                const sLow = sRaw.toString().toLowerCase();
                const originalIdx = globalData.indexOf(p);

                tbody.innerHTML += `
                    <tr class="hover:bg-slate-50 dark:hover:bg-slate-700/30">
                        <td class="p-4 font-bold">${p.nama || p.Nama}</td>
                        <td class="p-4 text-center text-slate-500">${p.angkatan || p.Angkatan || "-"}</td>
                        <td class="p-4 text-center"><span class="px-2 py-1 bg-slate-100 dark:bg-slate-700 rounded-md text-[10px] uppercase font-bold text-slate-600 dark:text-slate-300">${p.ujian || p.Ujian || "-"}</span></td>
                        <td class="p-4 text-center"><span class="px-3 py-1 rounded-full text-[9px] font-bold border ${getStatusStyle(sLow)}">${sRaw}</span></td>
                        <td class="p-4 text-center"><button onclick="openEditModal(${originalIdx})" class="bg-primary/10 text-primary px-3 py-1 rounded-md text-xs font-bold hover:bg-primary hover:text-white transition-all">Edit</button></td>
                    </tr>`;
            });
        }

        function getStatusStyle(s) {
            if (s.includes('pend')) return 'bg-yellow-50 text-yellow-600 border-yellow-200';
            if (s.includes('kuali') || s.includes('lulus')) return 'bg-emerald-50 text-emerald-600 border-emerald-200';
            return 'bg-red-50 text-red-600 border-red-200';
        }

        function openTambahModal() { document.getElementById('modalTambah').classList.remove('hidden'); }
        
        async function submitTambahPeserta() {
            const btn = document.getElementById('btnSimpanPeserta');
            const data = {
                tambahPeserta: true,
                nama: document.getElementById('addNama').value,
                angkatan: document.getElementById('addAngkatan').value,
                ujian: document.getElementById('addUjian').value,
                email: document.getElementById('addEmail').value
            };

            if(!data.nama || !data.email) return alert("Wajib isi Nama dan Email!");
            
            btn.innerText = "Memproses..."; btn.disabled = true;
            try {
                await fetch(SCRIPT_URL, { method: "POST", mode: "no-cors", body: JSON.stringify(data) });
                alert("Peserta berhasil ditambahkan ke database!");
                location.reload();
            } catch (e) { alert("Terjadi gangguan koneksi."); btn.disabled = false; btn.innerText = "Simpan"; }
        }

        function openEditModal(idx) {
            currentEditIndex = idx;
            const p = globalData[idx];
            document.getElementById('editNama').textContent = p.nama || p.Nama;
            document.getElementById('selectStatus').value = p.status || p.Status || "Pending";
            document.getElementById('modalEdit').classList.add('modal-active');
        }
        function closeModal() { document.getElementById('modalEdit').classList.remove('modal-active'); }

        async function saveStatus() {
            const btn = document.getElementById('btnSaveStatus');
            const newVal = document.getElementById('selectStatus').value;
            const p = globalData[currentEditIndex];
            
            btn.innerText = "Menyimpan..."; btn.disabled = true;
            try {
                // Mengirim perintah update ke AppScript
                await fetch(SCRIPT_URL, { 
                    method: "POST", 
                    mode: "no-cors", 
                    body: JSON.stringify({ 
                        updateStatus: true, 
                        nama: p.nama || p.Nama, 
                        newStatus: newVal 
                    }) 
                });
                
                // Jika berhasil (no-cors tidak bisa baca response, jadi kita asumsikan sukses jika tidak masuk catch)
                alert(`Status ${p.nama || p.Nama} diperbarui ke ${newVal}. Email akan terkirim jika Kualifikasi.`);
                location.reload();
            } catch (e) { 
                alert("Gagal memperbarui status. Silakan coba lagi."); 
                btn.disabled = false; 
                btn.innerText = "Simpan"; 
            }
        }

        function exportToExcel() {
            const ws = XLSX.utils.json_to_sheet(globalData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Data_Peserta");
            XLSX.writeFile(wb, "Data_PagarNusa_Unusia.xlsx");
        }

        function renderChart() {
            let l = 0, p = 0, d = 0;
            globalData.forEach(i => {
                const s = (i.status || i.Status || "").toString().toLowerCase();
                if (s.includes('pend')) p++; else if (s.includes('kuali') || s.includes('lulus')) l++; else d++;
            });
            const ctx = document.getElementById('chartPeserta').getContext('2d');
            if (myChart) myChart.destroy();
            myChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Kualifikasi', 'Pending', 'Diskualifikasi'],
                    datasets: [{ data: [l, p, d], backgroundColor: ['#1B7548', '#EAB308', '#EF4444'] }]
                },
                options: { plugins: { legend: { labels: { color: html.classList.contains('dark') ? '#fff' : '#333' } } } }
            });
        }

        // Signature Pad Core
        const canvas = document.getElementById('signature-pad');
        const ctx = canvas.getContext('2d');
        let writingMode = false;

        function resizeCanvas() {
            const ratio = Math.max(window.devicePixelRatio || 1, 1);
            const rect = canvas.getBoundingClientRect();
            canvas.width = rect.width * ratio; canvas.height = rect.height * ratio;
            ctx.scale(ratio, ratio);
            ctx.lineWidth = 3; ctx.strokeStyle = "#1B7548"; ctx.lineCap = "round";
        }

        const getCursorPosition = (e) => {
            const rect = canvas.getBoundingClientRect();
            const clientX = e.touches ? e.touches[0].clientX : e.clientX;
            const clientY = e.touches ? e.touches[0].clientY : e.clientY;
            return [clientX - rect.left, clientY - rect.top];
        };
        const startDrawing = (e) => { writingMode = true; ctx.beginPath(); const [x,y] = getCursorPosition(e); ctx.moveTo(x,y); };
        const draw = (e) => { if(!writingMode) return; e.preventDefault(); const [x,y] = getCursorPosition(e); ctx.lineTo(x,y); ctx.stroke(); };
        const stopDrawing = () => writingMode = false;

        canvas.addEventListener('mousedown', startDrawing); canvas.addEventListener('mousemove', draw); window.addEventListener('mouseup', stopDrawing);
        canvas.addEventListener('touchstart', startDrawing, {passive: false}); canvas.addEventListener('touchmove', draw, {passive: false}); canvas.addEventListener('touchend', stopDrawing);

        function clearSignature() { ctx.clearRect(0, 0, canvas.width, canvas.height); }

        async function handleFormSubmit(e) {
            e.preventDefault();
            const btn = e.target.querySelector('button[type="submit"]');
            btn.innerHTML = "Mengirim..."; btn.disabled = true;
            const data = {
                nama: document.getElementById('nama').value,
                jabatan: document.getElementById('jabatan').value,
                tanggal: document.getElementById('tanggal').value,
                pukul: document.getElementById('pukul').value,
                image: canvas.toDataURL("image/png")
            };
            try {
                await fetch(SCRIPT_URL, { method: "POST", mode: "no-cors", body: JSON.stringify(data) });
                document.getElementById('main-card-ttd').classList.add('hidden');
                document.getElementById('download-section').classList.remove('hidden');
                const qrUrl = `https://quickchart.io/qr?text=${encodeURIComponent('VERIFIKASI_TTD_'+data.nama)}&size=400`;
                document.getElementById('qr-container').innerHTML = `<img src="${qrUrl}" class="w-48 mx-auto shadow-md rounded-lg">`;
            } catch (err) { alert("Terjadi kesalahan sistem."); }
            finally { btn.disabled = false; btn.innerHTML = "Daftar & Buat QR"; }
        }

        function downloadQR() {
            const qrImg = document.querySelector('#qr-container img');
            const a = document.createElement('a'); a.href = qrImg.src; a.download = `QR_Signature_PN.png`; a.click();
        }

        window.onload = loadExcelData;
    </script>
</body>
</html>
