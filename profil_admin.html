<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Dashboard Admin | PAGARNUSA UNUSIA</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#1B7548',
                        primaryDark: '#145c38'
                    }
                }
            }
        }
    </script>

    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    
    <style>
        body { 
            font-family: 'Poppins', sans-serif;
        }
        /* Style tambahan untuk sidebar */
        .sidebar-link.active {
            background-color: #145c38; /* primaryDark */
            color: white !important; /* Memastikan teks putih */
        }
        /* Style untuk modal */
        .modal-overlay {
            background-color: rgba(0, 0, 0, 0.5);
        }
        .modal-content {
            max-height: 90vh;
            overflow-y: auto;
        }
    </style>
</head>
<body class="min-h-screen flex flex-col bg-gradient-to-b from-emerald-50 to-slate-50 text-slate-80um">

    <header id="main-header" class="sticky top-0 z-50 bg-primary text-white shadow-lg">
        <div class="container mx-auto px-4 py-3 flex justify-between items-center">
            
            <div class="flex items-center space-x-3">
                <img src="logopn.png" alt="Logo PAGARNUSA" class="h-10">
                <h1 class="text-sm font-bold tracking-wide leading-tight uppercase">
                    DASHBOARD<br>ADMIN
                </h1>
            </div>
            
            <div class="flex items-center space-x-4">
                <span id="admin-name-display" class="text-sm hidden sm:inline">Selamat Datang, Admin!</span>
                <a href="#" id="logout-button" class="bg-red-600 hover:bg-red-700 px-3 py-1 rounded-lg text-sm transition">
                    <i class="fas fa-sign-out-alt mr-1"></i> Logout
                </a>
            </div>
        </div>
    </header>

    <main class="flex-1 container mx-auto px-4 py-8">
        <div class="flex flex-col md:flex-row gap-6">

            <nav id="sidebar" class="w-full md:w-64 bg-white rounded-xl shadow-lg p-4 md:sticky md:top-20 h-fit">
                <h3 class="text-lg font-bold text-primary mb-4 border-b pb-2">Menu</h3>
                <ul class="space-y-2">
                    <li>
                        <a href="#ringkasan" class="sidebar-link active block px-3 py-2 rounded-lg text-sm text-white transition hover:bg-primaryDark/80" data-content-id="content-ringkasan">
                            <i class="fas fa-chart-line w-5 mr-2"></i> Ringkasan
                        </a>
                    </li>
                    <li>
                        <a href="#kelola-peserta" class="sidebar-link block px-3 py-2 rounded-lg text-sm text-slate-700 hover:bg-emerald-50 transition" data-content-id="content-kelola-peserta">
                            <i class="fas fa-users w-5 mr-2"></i> Kelola Peserta
                        </a>
                    </li>
                    <li>
                        <a href="#pengumuman" class="sidebar-link block px-3 py-2 rounded-lg text-sm text-slate-700 hover:bg-emerald-50 transition" data-content-id="content-pengumuman">
                            <i class="fas fa-bell w-5 mr-2"></i> Pengumuman
                        </a>
                    </li>
                    <li>
                        <a href="#pengaturan" class="sidebar-link block px-3 py-2 rounded-lg text-sm text-slate-700 hover:bg-emerald-50 transition" data-content-id="content-pengaturan">
                            <i class="fas fa-cog w-5 mr-2"></i> Pengaturan
                        </a>
                    </li>
                </ul>
            </nav>

            <section id="dashboard-content" class="flex-1">
                <div id="content-ringkasan">
                    <h2 class="text-3xl font-extrabold text-primary mb-6">Ringkasan Dashboard</h2>
                    
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                        <div class="bg-white p-6 rounded-xl shadow-md border-l-4 border-primary">
                            <p class="text-sm text-slate-500 font-medium">Total Pendaftar</p>
                            <p id="total-pendaftar" class="text-3xl font-bold text-slate-800 mt-1">...</p>
                        </div>
                        <div class="bg-white p-6 rounded-xl shadow-md border-l-4 border-yellow-500">
                            <p class="text-sm text-slate-500 font-medium">Status Panding</p>
                            <p id="pending-verifikasi" class="text-3xl font-bold text-slate-800 mt-1">...</p>
                        </div>
                        <div class="bg-white p-6 rounded-xl shadow-md border-l-4 border-green-500">
                            <p class="text-sm text-slate-500 font-medium">Peserta Kualifikasi</p>
                            <p id="peserta-diverifikasi" class="text-3xl font-bold text-slate-800 mt-1">...</p>
                        </div>
                    </div>

                    <div class="bg-white rounded-xl shadow-lg p-6">
                        <h3 class="text-xl font-bold text-primaryDark mb-4">Data Peserta Terdaftar</h3>
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-slate-200">
                                <thead class="bg-slate-50">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Nama</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Angkatan</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Tingkat Ujian</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Status</th>
                                    </tr>
                                </thead>
                                <tbody id="latest-applicants-body" class="bg-white divide-y divide-slate-200 text-sm">
                                </tbody>
                            </table>
                        </div>
                        <div class="mt-4 text-right">
                            <a href="#" id="download-data-link" class="text-sm text-primary hover:underline font-medium transition hover:text-primaryDark">
                                <i class="fas fa-download mr-1"></i> Data Lengkap
                            </a>
                        </div>
                    </div>
                </div>

                <div id="content-kelola-peserta" class="hidden">
                    <h2 class="text-3xl font-extrabold text-primary mb-6">Kelola Peserta</h2>
                    <div class="bg-white p-6 rounded-xl shadow-lg">
                        
                        <div class="flex flex-col sm:flex-row justify-between items-center mb-4 space-y-3 sm:space-y-0 sm:space-x-4">
                            <input type="text" id="participant-search" placeholder="Cari Nama atau Angkatan..."
                                class="w-full sm:w-1/2 p-2 border rounded-lg focus:ring-primary focus:border-primary">
                            <select id="status-filter" class="w-full sm:w-1/4 p-2 border rounded-lg focus:ring-primary focus:border-primary">
                                <option value="all">Semua Status</option>
                                <option value="Kualifikasi">Kualifikasi</option>
                                <option value="Panding">Panding</option>
                                <option value="Diskualifikasi">Diskualifikasi</option>
                            </select>
                        </div>

                        <div class="overflow-x-auto mt-6">
                            <table class="min-w-full divide-y divide-slate-200">
                                <thead class="bg-primary/10">
                                    <tr>
                                        <th class="px-4 py-2 text-left text-xs font-semibold text-primary uppercase tracking-wider">Nama</th>
                                        <th class="px-4 py-2 text-left text-xs font-semibold text-primary uppercase tracking-wider hidden sm:table-cell">Angkatan</th>
                                        <th class="px-4 py-2 text-left text-xs font-semibold text-primary uppercase tracking-wider hidden md:table-cell">Ujian</th>
                                        <th class="px-4 py-2 text-left text-xs font-semibold text-primary uppercase tracking-wider">Status</th>
                                        <th class="px-4 py-2 text-center text-xs font-semibold text-primary uppercase tracking-wider">Aksi</th>
                                    </tr>
                                </thead>
                                <tbody id="participants-table-body" class="bg-white divide-y divide-slate-200 text-sm">
                                    </tbody>
                            </table>
                        </div>
                        
                        <p id="no-data-message" class="text-center text-slate-500 mt-4 hidden">Tidak ada data yang cocok ditemukan.</p>
                    </div>
                </div>

                <div id="content-pengumuman" class="hidden">
                    <h2 class="text-3xl font-extrabold text-primary mb-6">Pengumuman & Notifikasi</h2>
                    <div class="bg-white p-6 rounded-xl shadow-lg">
                        <h4 class="text-xl font-bold mb-3 text-primaryDark">Buat Pengumuman Baru</h4>
                        <textarea rows="4" class="w-full p-3 border rounded-lg focus:ring-primary focus:border-primary" placeholder="Tulis pengumuman penting di sini..."></textarea>
                        <button class="mt-3 bg-primary hover:bg-primaryDark text-white font-semibold py-2 px-4 rounded-lg transition">
                            <i class="fas fa-paper-plane mr-2"></i> Publikasikan
                        </button>
                    </div>
                </div>
                
                <div id="content-pengaturan" class="hidden">
                    <h2 class="text-3xl font-extrabold text-primary mb-6">Pengaturan Umum</h2>
                    <div class="bg-white p-6 rounded-xl shadow-lg">
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-semibold mb-1">Status Pendaftaran</label>
                                <select class="w-full p-2 border rounded-lg">
                                    <option>Buka</option>
                                    <option>Tutup</option>
                                </select>
                            </div>
                            <p class="text-sm text-slate-500">Kelola pengaturan sistem dasar.</p>
                        </div>
                    </div>
                </div>
            </section>
        </div>

        <div id="modal-container">
            </div>

    </main>

    <footer class="bg-primary text-white text-center py-3 mt-auto">
        <p class="text-xs opacity-90">© 2025 PAGARNUSA UNUSIA. Semua hak cipta dilindungi.</p>
    </footer>

    <script>
        const twoDigits = (num) => String(num).padStart(2, '0');
        let students = []; // Variabel global untuk data siswa (mutable, hasil filter/search)
        let originalStudents = []; // Salinan data asli (sumber kebenaran)

        // --- FUNGSI UTILITY & MODAL ---
        
        // Fungsi untuk menyimpan perubahan ke localStorage (PENTING untuk sinkronisasi siswa)
        function saveStudentsData() {
            const dataToSave = originalStudents.map(user => {
                const { is_admin, role, ...rest } = user;
                return rest;
            }).filter(user => user.nama); 
            
            localStorage.setItem('allStudentsData', JSON.stringify(dataToSave));
        }

        function getStatusBadge(status) {
            let badgeClass = '';
            let statusText = '';

            if (status.includes('Kualifikasi') || status.includes('Diverifikasi')) {
                badgeClass = 'bg-green-100 text-green-800';
                statusText = 'Kualifikasi';
            } else if (status.includes('Panding') || status.includes('Menunggu Verifikasi')) {
                badgeClass = 'bg-yellow-100 text-yellow-800';
                statusText = 'Panding';
            } else if (status.includes('Diskualifikasi') || status.includes('Ditolak')) {
                badgeClass = 'bg-red-100 text-red-800';
                statusText = 'Diskualifikasi';
            } else {
                badgeClass = 'bg-slate-100 text-slate-800';
                statusText = 'Tidak Diketahui';
            }
            
            return `<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${badgeClass}">${statusText}</span>`;
        }


        // ----------------------------------------------------
        // ------------------ CRUD FUNCTIONS ------------------
        // ----------------------------------------------------

        // U (Update): Fungsi Kualifikasi Peserta
        window.verifyParticipant = function(index) {
            const student = students[index];
            if (confirm(`Kualifikasi peserta ${student.nama}?`)) {
                const originalIndex = originalStudents.findIndex(s => s.email === student.email); 

                if (originalIndex !== -1) {
                    originalStudents[originalIndex].status = 'Kualifikasi✅️';
                    saveStudentsData(); // Simpan perubahan
                    renderParticipantsTable(); // Render ulang tabel Kelola Peserta
                    renderRingkasan(); // Render ulang ringkasan
                    alert(`Peserta ${student.nama} berhasil di Kualifikasi.`);
                }
            }
        }
        
        // U (Update): Fungsi Tolak/Diskualifikasi Peserta
        window.rejectParticipant = function(index) {
            const student = students[index];
            if (confirm(`Diskualifikasi pendaftaran peserta ${student.nama}? Tindakan ini akan mengubah statusnya menjadi Diskualifikasi.`)) {
                const originalIndex = originalStudents.findIndex(s => s.email === student.email); 

                if (originalIndex !== -1) {
                    originalStudents[originalIndex].status = 'Diskualifikasi❌️';
                    saveStudentsData(); // Simpan perubahan
                    renderParticipantsTable(); 
                    renderRingkasan(); 
                    alert(`Pendaftaran ${student.nama} berhasil di Diskualifikasi.`);
                }
            }
        }
        
        // U (Update): Fungsi Ubah ke Panding (untuk status yang sudah final)
        window.setPanding = function(index) {
            const student = students[index];
            if (confirm(`Ubah status peserta ${student.nama} kembali ke Panding (Menunggu Verifikasi)?`)) {
                const originalIndex = originalStudents.findIndex(s => s.email === student.email); 

                if (originalIndex !== -1) {
                    originalStudents[originalIndex].status = 'Panding⏳️';
                    saveStudentsData(); // Simpan perubahan
                    renderParticipantsTable(); 
                    renderRingkasan(); 
                    alert(`Status ${student.nama} berhasil diubah menjadi Panding.`);
                }
            }
        }


        // U (Update) / D (Delete): Membuka Modal (SAMA)
        window.openModal = function(action, index) {
            const modalContainer = document.getElementById('modal-container');
            const student = students[index];
            modalContainer.innerHTML = '';
            
            if (action === 'edit') {
                modalContainer.innerHTML = createEditModal(student);
                document.getElementById('editForm').addEventListener('submit', handleEditSubmit);
            } else if (action === 'delete') {
                modalContainer.innerHTML = createDeleteModal(student);
                document.getElementById('delete-confirm-button').addEventListener('click', handleDeleteConfirm);
            }
            document.getElementById('modal-overlay').classList.remove('hidden');
        }

        window.closeModal = function() {
            document.getElementById('modal-overlay').classList.add('hidden');
            document.getElementById('modal-container').innerHTML = '';
        }

        // U (Update): Membuat Modal Edit
        function createEditModal(student) {
            const currentStatus = student.status.includes('Kualifikasi') || student.status.includes('Diverifikasi') ? 'Kualifikasi' :
                                student.status.includes('Panding') || student.status.includes('Menunggu Verifikasi') ? 'Panding' :
                                'Diskualifikasi';

            return `
                <div id="modal-overlay" class="fixed inset-0 z-50 flex items-center justify-center transition-opacity modal-overlay">
                    <div class="absolute inset-0 bg-black opacity-50" onclick="closeModal()"></div>
                    <div class="bg-white rounded-xl shadow-2xl p-6 w-11/12 max-w-lg z-50 modal-content">
                        <h3 class="text-xl font-bold text-primary border-b pb-2 mb-4">Edit Data Peserta: ${student.nama}</h3>
                        <form id="editForm" data-student-email="${student.email}" class="space-y-4">
                            <input type="hidden" name="oldEmail" value="${student.email}">
                            
                            <div>
                                <label for="edit_nama" class="block text-sm font-semibold mb-1">Nama</label>
                                <input type="text" id="edit_nama" name="nama" value="${student.nama}" required
                                    class="w-full p-2 border rounded-lg focus:ring-primary focus:border-primary">
                            </div>
                            <div>
                                <label for="edit_email" class="block text-sm font-semibold mb-1">Email</label>
                                <input type="email" id="edit_email" name="email" value="${student.email}" required
                                    class="w-full p-2 border rounded-lg focus:ring-primary focus:border-primary">
                            </div>
                            <div>
                                <label for="edit_angkatan" class="block text-sm font-semibold mb-1">Angkatan</label>
                                <input type="number" id="edit_angkatan" name="angkatan" value="${student.angkatan}" required
                                    class="w-full p-2 border rounded-lg focus:ring-primary focus:border-primary">
                            </div>
                            <div>
                                <label for="edit_ujian" class="block text-sm font-semibold mb-1">Tingkat Ujian</label>
                                <input type="text" id="edit_ujian" name="ujian" value="${student.ujian}" required
                                    class="w-full p-2 border rounded-lg focus:ring-primary focus:border-primary">
                            </div>
                            <div>
                                <label for="edit_status" class="block text-sm font-semibold mb-1">Status Verifikasi</label>
                                <select id="edit_status" name="status" class="w-full p-2 border rounded-lg focus:ring-primary focus:border-primary">
                                    <option value="Kualifikasi✅️" ${currentStatus === 'Kualifikasi' ? 'selected' : ''}>Kualifikasi</option>
                                    <option value="Panding⏳️" ${currentStatus === 'Panding' ? 'selected' : ''}>Panding</option>
                                    <option value="Diskualifikasi❌️" ${currentStatus === 'Diskualifikasi' ? 'selected' : ''}>Diskualifikasi</option>
                                </select>
                            </div>
                            
                            <div class="flex justify-end space-x-3 mt-6">
                                <button type="button" onclick="closeModal()" class="bg-slate-300 hover:bg-slate-400 text-slate-800 font-semibold py-2 px-4 rounded-lg transition">Batal</button>
                                <button type="submit" class="bg-primary hover:bg-primaryDark text-white font-semibold py-2 px-4 rounded-lg transition">Simpan Perubahan</button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
        }

        // U (Update): Menangani Submit Form Edit
        function handleEditSubmit(e) {
            e.preventDefault();
            const form = e.target;
            const oldEmail = form.elements['oldEmail'].value;
            
            const formData = {
                nama: form.elements['nama'].value,
                email: form.elements['email'].value,
                angkatan: form.elements['angkatan'].value,
                ujian: form.elements['ujian'].value,
                status: form.elements['status'].value,
            };

            const studentIndex = students.findIndex(s => s.email === oldEmail);
            if (studentIndex !== -1) {
                Object.assign(students[studentIndex], formData);
            }

            const originalIndex = originalStudents.findIndex(s => s.email === oldEmail);
            if (originalIndex !== -1) {
                Object.assign(originalStudents[originalIndex], formData);
            }
            
            saveStudentsData(); // PENTING: Update localStorage
            renderParticipantsTable();
            renderRingkasan();
            closeModal();
            alert(`Data ${formData.nama} berhasil diperbarui.`);
        }

        // D (Delete): Membuat Modal Delete (SAMA)
        function createDeleteModal(student) {
            return `
                <div id="modal-overlay" class="fixed inset-0 z-50 flex items-center justify-center transition-opacity modal-overlay">
                    <div class="absolute inset-0 bg-black opacity-50" onclick="closeModal()"></div>
                    <div class="bg-white rounded-xl shadow-2xl p-6 w-11/12 max-w-sm z-50">
                        <h3 class="text-xl font-bold text-red-600 border-b pb-2 mb-4">Hapus Peserta</h3>
                        <p class="text-slate-700">Apakah Anda yakin ingin menghapus data peserta <strong>${student.nama}</strong> secara permanen?</p>
                        <p class="text-sm text-red-500 mt-2">Tindakan ini tidak dapat dibatalkan!</p>
                        
                        <div class="flex justify-end space-x-3 mt-6">
                            <button type="button" onclick="closeModal()" class="bg-slate-300 hover:bg-slate-400 text-slate-800 font-semibold py-2 px-4 rounded-lg transition">Batal</button>
                            <button type="button" id="delete-confirm-button" data-student-email="${student.email}" class="bg-red-600 hover:bg-red-700 text-white font-semibold py-2 px-4 rounded-lg transition">Hapus</button>
                        </div>
                    </div>
                </div>
            `;
        }

        // D (Delete): Menangani Konfirmasi Hapus
        function handleDeleteConfirm(e) {
            const emailToDelete = e.target.getAttribute('data-student-email');

            const originalIndex = originalStudents.findIndex(s => s.email === emailToDelete);
            if (originalIndex !== -1) {
                originalStudents.splice(originalIndex, 1);
            }
            
            const studentIndex = students.findIndex(s => s.email === emailToDelete);
            if (studentIndex !== -1) {
                students.splice(studentIndex, 1);
            }

            saveStudentsData(); // PENTING: Update localStorage
            renderParticipantsTable();
            renderRingkasan();
            closeModal();
            alert(`Peserta berhasil dihapus.`);
        }


        // ----------------------------------------------------
        // ------------------ RENDER FUNCTIONS ----------------
        // ----------------------------------------------------

        // R (Read): Render Tabel Kelola Peserta
        function renderParticipantsTable() {
            const tableBody = document.getElementById('participants-table-body');
            const searchKeyword = document.getElementById('participant-search').value.toLowerCase();
            const filterStatus = document.getElementById('status-filter').value;
            const noDataMessage = document.getElementById('no-data-message');
            
            students = originalStudents.filter(student => {
                const nameMatch = student.nama.toLowerCase().includes(searchKeyword);
                const angkatanMatch = student.angkatan.toString().includes(searchKeyword);
                
                let normalizedStatus = student.status.includes('Kualifikasi') ? 'Kualifikasi' :
                                    student.status.includes('Panding') ? 'Panding' :
                                    student.status.includes('Diskualifikasi') ? 'Diskualifikasi' : '';

                const statusMatch = filterStatus === 'all' || normalizedStatus.includes(filterStatus);
                
                return (nameMatch || angkatanMatch) && statusMatch;
            });

            tableBody.innerHTML = '';
            
            if (students.length === 0) {
                noDataMessage.classList.remove('hidden');
                return;
            } else {
                noDataMessage.classList.add('hidden');
            }

            students.forEach((student, index) => {
                const statusBadge = getStatusBadge(student.status);
                
                let actionButtons;
                let currentStatus = student.status.includes('Kualifikasi') ? 'Kualifikasi' :
                                    student.status.includes('Panding') ? 'Panding' :
                                    'Diskualifikasi';

                if (currentStatus === 'Panding') {
                    actionButtons = `
                        <button onclick="verifyParticipant(${index})" class="text-green-600 hover:text-green-800 transition p-1" title="Kualifikasi"><i class="fas fa-check"></i></button>
                        <button onclick="rejectParticipant(${index})" class="text-red-600 hover:text-red-800 transition p-1" title="Diskualifikasi"><i class="fas fa-times"></i></button>
                    `;
                } else {
                    // Jika sudah Kualifikasi atau Diskualifikasi, sediakan tombol untuk reset ke Panding
                    actionButtons = `
                        <button onclick="setPanding(${index})" class="text-yellow-600 hover:text-yellow-800 transition p-1" title="Ubah ke Panding"><i class="fas fa-undo"></i></button>
                    `;
                }
                
                const row = `
                    <tr>
                        <td class="px-4 py-3 whitespace-nowrap font-medium">${student.nama}</td>
                        <td class="px-4 py-3 whitespace-nowrap hidden sm:table-cell">${student.angkatan}</td>
                        <td class="px-4 py-3 whitespace-nowrap hidden md:table-cell">${student.ujian}</td>
                        <td class="px-4 py-3 whitespace-nowrap">${statusBadge}</td>
                        <td class="px-4 py-3 whitespace-nowrap text-center space-x-2">
                            ${actionButtons}
                            <button onclick="openModal('edit', ${index})" class="text-blue-600 hover:text-blue-800 transition p-1" title="Edit"><i class="fas fa-edit"></i></button>
                            <button onclick="openModal('delete', ${index})" class="text-red-600 hover:text-red-800 transition p-1" title="Hapus"><i class="fas fa-trash-alt"></i></button>
                        </td>
                    </tr>
                `;
                tableBody.innerHTML += row;
            });
        }
        
        // R (Read): Render Tabel Ringkasan (untuk data 5 teratas)
        function renderRingkasan() {
            const applicantsBody = document.getElementById('latest-applicants-body');
            
            if (originalStudents.length === 0) {
                document.getElementById('total-pendaftar').textContent = 0;
                document.getElementById('pending-verifikasi').textContent = 0;
                document.getElementById('peserta-diverifikasi').textContent = 0;
                applicantsBody.innerHTML = '<tr><td colspan="4" class="px-6 py-4 text-center text-slate-500">Tidak ada data peserta ditemukan.</td></tr>';
                return;
            }

            const total = originalStudents.length;
            const pending = originalStudents.filter(s => s.status.includes('Panding')).length;
            const verified = originalStudents.filter(s => s.status.includes('Kualifikasi')).length; 
            const recentStudents = originalStudents.slice(0, 5); // Tampilkan 5 teratas

            document.getElementById('total-pendaftar').textContent = total;
            document.getElementById('pending-verifikasi').textContent = pending;
            document.getElementById('peserta-diverifikasi').textContent = verified; 

            applicantsBody.innerHTML = ''; // Bersihkan tabel

            if (recentStudents.length === 0) {
                applicantsBody.innerHTML = '<tr><td colspan="4" class="px-6 py-4 text-center text-slate-500">Tidak ada data peserta ditemukan.</td></tr>';
                return;
            }
            
            recentStudents.forEach(student => {
                const statusBadge = getStatusBadge(student.status);
                
                const row = `
                    <tr>
                        <td class="px-6 py-4 whitespace-nowrap font-medium">${student.nama}</td>
                        <td class="px-6 py-4 whitespace-nowrap">${student.angkatan}</td>
                        <td class="px-6 py-4 whitespace-nowrap">${student.ujian}</td>
                        <td class="px-6 py-4 whitespace-nowrap">${statusBadge}</td>
                    </tr>
                `;
                applicantsBody.innerHTML += row;
            });
        }


        // ----------------------------------------------------
        // ------------------ MAIN LOGIC (DOM LOAD) -----------
        // ----------------------------------------------------

        document.addEventListener('DOMContentLoaded', () => {
            const adminNameDisplay = document.getElementById('admin-name-display');
            const logoutButton = document.getElementById('logout-button');
            const downloadLink = document.getElementById('download-data-link');
            const sidebarLinks = document.querySelectorAll('.sidebar-link');
            const contentSections = document.querySelectorAll('#dashboard-content > div');

            // Kontrol Kelola Peserta
            const participantSearch = document.getElementById('participant-search');
            const statusFilter = document.getElementById('status-filter');

            // 1. Cek Sesi Keamanan Dasar & Ambil Profil Admin
            const profileDataString = localStorage.getItem('currentUserProfile');
            
            if (!profileDataString) {
                alert("Sesi berakhir atau tidak valid. Silakan login kembali.");
                window.location.href = 'login.html';
                return;
            }
            
            let adminName = 'Admin'; 
            try {
                const profile = JSON.parse(profileDataString);
                if (profile.role !== 'Admin') {
                    alert("Akses ditolak. Anda bukan Admin.");
                    localStorage.removeItem('currentUserProfile');
                    window.location.href = 'login.html';
                    return;
                }
                adminName = profile.nama ? profile.nama.split(' ')[0] : 'Admin';
            } catch (e) {
                console.error("Gagal parsing LocalStorage:", e);
            }
            adminNameDisplay.textContent = `Selamat Datang, ${adminName}!`;


            // 2. Ambil & Siapkan Data Semua Siswa (Data yang akan diubah Admin)
            const studentsDataString = localStorage.getItem('allStudentsData');
            if (studentsDataString) {
                try {
                    originalStudents = JSON.parse(studentsDataString);
                    students = [...originalStudents]; 
                } catch (e) {
                    console.error("Gagal parsing data siswa:", e);
                }
            } else {
                 // Jika allStudentsData kosong (error atau login pertama), arahkan ke login
                alert("Data peserta tidak ditemukan. Silakan login ulang.");
                window.location.href = 'login.html';
                return;
            }

            // Panggil renderRingkasan saat halaman dimuat (untuk menu default)
            renderRingkasan(); 


            // 3. Setup Event Listeners Kelola Peserta
            participantSearch.addEventListener('input', renderParticipantsTable);
            statusFilter.addEventListener('change', renderParticipantsTable);

            // 4. Fungsi Sidebar & Navigasi Dinamis
            sidebarLinks.forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    
                    sidebarLinks.forEach(l => l.classList.remove('active', 'text-white'));
                    sidebarLinks.forEach(l => l.classList.add('text-slate-700', 'hover:bg-emerald-50'));
                    
                    link.classList.add('active');
                    link.classList.remove('text-slate-700', 'hover:bg-emerald-50');
                    link.classList.add('text-white');

                    contentSections.forEach(content => content.classList.add('hidden'));

                    const contentId = link.getAttribute('data-content-id');
                    const targetContent = document.getElementById(contentId);
                    if (targetContent) {
                        targetContent.classList.remove('hidden');
                        
                        if (contentId === 'content-kelola-peserta') {
                            renderParticipantsTable();
                        }
                        if (contentId === 'content-ringkasan') {
                            renderRingkasan();
                        }
                    }
                });
            });


            // 5. Fungsi Konversi & Download ke CSV
            function convertToCSV(data) {
                if (data.length === 0) return '';
                const downloadData = originalStudents.map(user => {
                    let statusClean = user.status;
                    statusClean = statusClean.includes('Panding') ? 'Panding' : statusClean;
                    statusClean = statusClean.includes('Kualifikasi') ? 'Kualifikasi' : statusClean;
                    statusClean = statusClean.includes('Diskualifikasi') ? 'Diskualifikasi' : statusClean;


                    return {
                        nama: user.nama,
                        angkatan: user.angkatan,
                        ujian: user.ujian,
                        email: user.email,
                        ttl: user.ttl,
                        alamat: user.alamat,
                        whatsapp: user.whatsapp,
                        status: statusClean.replace(/[^\w\s]/gi, '').trim() 
                    };
                });
                
                const keys = Object.keys(downloadData[0]);
                const header = keys.map(key => key.toUpperCase()).join(';');
                const rows = downloadData.map(obj => {
                    return keys.map(key => `"${obj[key] || ''}"`).join(';');
                });
                return [header, ...rows].join('\n');
            }

            downloadLink.addEventListener('click', (e) => {
                e.preventDefault();
                if (originalStudents.length === 0) {
                    alert("Tidak ada data peserta untuk diunduh.");
                    return;
                }
                const now = new Date();
                const dd = twoDigits(now.getDate());
                const mm = twoDigits(now.getMonth() + 1);
                const yyyy = now.getFullYear();
                const h = twoDigits(now.getHours());
                const min = twoDigits(now.getMinutes());
                const timestamp = `${dd}-${mm}-${yyyy}_${h}-${min}`;
                const filename = `Data_Peserta_${timestamp}.csv`;

                const csvContent = convertToCSV(originalStudents);
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                
                const tempLink = document.createElement('a');
                tempLink.href = url;
                tempLink.setAttribute('download', filename);
                
                document.body.appendChild(tempLink);
                tempLink.click();
                document.body.removeChild(tempLink);
                URL.revokeObjectURL(url);
                
                alert(`Data ${originalStudents.length} peserta telah diunduh sebagai file:\n${filename}`);
            });


            // 6. Fungsikan Logout 
            logoutButton.addEventListener('click', (e) => {
                e.preventDefault();
                localStorage.removeItem('currentUserProfile'); 
                // Biarkan allStudentsData tetap ada, tapi hapus sesi admin
                logoutButton.innerHTML = '<i class="fas fa-spinner fa-spin mr-1"></i> Keluar...';

                setTimeout(() => {
                    window.location.href = 'login.html';
                }, 300); 
            });
        });
    </script>
</body>
</html>

