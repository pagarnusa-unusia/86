<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>Absensi Latihan | PSNU PAGARNUSA UNUSIA</title>
    <link rel="icon" type="image/png" href="logopn.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        :root { 
            --primary: #1B7548; 
            --primary-dark: #0f4d2f; 
            --accent: #fbbf24; 
            --bg-dark: #0f172a;
        }
        
        body { 
            font-family: 'Plus Jakarta Sans', sans-serif; 
            background-color: var(--bg-dark);
            background-image: radial-gradient(circle at top right, #1e293b, #0f172a);
            color: #f8fafc; 
            min-height: 100vh;
            user-select: none;
            overflow-x: hidden;
        }

        .glass { 
            background: rgba(30, 41, 59, 0.7); 
            backdrop-filter: blur(12px); 
            border: 1px solid rgba(255, 255, 255, 0.1); 
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.3);
        }

        .page { 
            display: none; 
            width: 100%; 
            max-width: 450px; 
            margin: auto; 
            padding: 1rem;
            animation: fadeIn 0.4s cubic-bezier(0.4, 0, 0.2, 1); 
        }

        .page.active { display: block; }

        @keyframes fadeIn { 
            from { opacity: 0; transform: translateY(10px); } 
            to { opacity: 1; transform: translateY(0); } 
        }

        .opt-btn { 
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.2s ease;
        }

        .opt-btn:active { 
            transform: scale(0.97);
            background: rgba(27, 117, 72, 0.2);
            border-color: var(--primary);
        }

        /* Checkbox Styling */
        .check-card input:checked + .card-content { 
            background: rgba(27, 117, 72, 0.15); 
            border-color: var(--primary); 
            box-shadow: 0 0 15px rgba(27, 117, 72, 0.3);
        }

        .check-card input:checked + .card-content .check-icon { 
            background-color: var(--primary); 
            border-color: var(--primary); 
            color: white;
        }

        .loading-bar {
            height: 3px;
            width: 100%;
            background: linear-gradient(to right, transparent, var(--primary), transparent);
            background-size: 200% 100%;
            animation: loading 1.5s infinite linear;
        }

        @keyframes loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 10px; }
    </style>
</head>
<body class="flex flex-col items-center">

    <div id="page-kampus" class="page active">
        <div class="text-center mt-8 mb-12">
            <div class="relative inline-block">
                <div class="absolute inset-0 bg-emerald-500 blur-3xl opacity-20 rounded-full"></div>
                <img src="logopn.png" alt="Logo" class="w-24 h-24 mx-auto relative z-10 drop-shadow-2xl">
            </div>
            <h1 class="text-3xl font-extrabold text-white mt-6 tracking-tight">E-ABSENSI</h1>
            <p class="text-emerald-500 font-bold text-[11px] tracking-[0.4em] uppercase opacity-80">PSNU PAGARNUSA UNUSIA</p>
        </div>

        <p class="text-slate-400 text-sm font-semibold mb-4 ml-2">Pilih Wilayah Latihan</p>
        <div class="grid grid-cols-1 gap-4">
            <button onclick="navToPelet('Jakarta')" class="opt-btn w-full p-5 rounded-3xl flex items-center gap-5 group">
                <div class="w-14 h-14 bg-emerald-500/10 rounded-2xl flex items-center justify-center text-emerald-500 text-2xl group-active:scale-90 transition-transform">
                    <i class="fas fa-city"></i>
                </div>
                <div class="text-left">
                    <span class="block text-lg font-bold text-white leading-none">JAKARTA</span>
                    <span class="text-[10px] text-slate-500 font-bold uppercase tracking-widest">Pusat & Matraman</span>
                </div>
                <i class="fas fa-chevron-right ml-auto text-slate-600"></i>
            </button>

            <button onclick="navToPelet('Bogor')" class="opt-btn w-full p-5 rounded-3xl flex items-center gap-5 group">
                <div class="w-14 h-14 bg-sky-500/10 rounded-2xl flex items-center justify-center text-sky-500 text-2xl group-active:scale-90 transition-transform">
                    <i class="fas fa-mountain-sun"></i>
                </div>
                <div class="text-left">
                    <span class="block text-lg font-bold text-white leading-none">BOGOR</span>
                    <span class="text-[10px] text-slate-500 font-bold uppercase tracking-widest">Kampus Parung Kuripan</span>
                </div>
                <i class="fas fa-chevron-right ml-auto text-slate-600"></i>
            </button>
        </div>
    </div>

    <div id="page-pelet" class="page">
        <div class="flex items-center gap-4 my-6">
            <button onclick="showPage('page-kampus')" class="w-10 h-10 glass rounded-xl flex items-center justify-center text-slate-400">
                <i class="fas fa-arrow-left text-sm"></i>
            </button>
            <div>
                <h2 id="display-kampus" class="text-xl font-bold text-white">KAMPUS</h2>
                <p class="text-[10px] text-emerald-500 font-bold uppercase tracking-widest">Pilih Tingkatan Sabuk</p>
            </div>
        </div>
        <div id="pelet-list" class="space-y-6"></div>
    </div>

    <div id="page-daftar" class="page">
        <div class="sticky top-0 z-50 bg-slate-900/80 backdrop-blur-md pt-4 pb-2">
            <div class="flex items-center justify-between mb-4">
                <div class="flex items-center gap-3">
                    <button onclick="showPage('page-pelet')" class="w-10 h-10 glass rounded-xl flex items-center justify-center text-slate-400">
                        <i class="fas fa-arrow-left"></i>
                    </button>
                    <div>
                        <p id="display-info" class="text-[9px] font-bold text-emerald-500 uppercase tracking-tighter">Memuat...</p>
                        <h2 class="font-bold text-white leading-none">Kehadiran</h2>
                    </div>
                </div>
                <div class="text-right">
                    <div class="text-2xl font-black text-white leading-none"><span id="check-count">0</span></div>
                    <button onclick="toggleSelectAll()" class="text-[10px] font-bold text-emerald-500 uppercase tracking-widest">Pilih Semua</button>
                </div>
            </div>

            <div class="relative group">
                <i class="fas fa-search absolute left-4 top-1/2 -translate-y-1/2 text-slate-500 text-sm"></i>
                <input type="text" id="search-input" onkeyup="filterSantri()" placeholder="Cari nama santri..." 
                    class="w-full pl-11 pr-4 py-3 rounded-2xl glass border-none text-white focus:ring-2 focus:ring-emerald-500 outline-none text-sm">
            </div>
        </div>

        <div id="loading" class="hidden py-10 text-center">
            <div class="loading-bar mb-4"></div>
            <p class="text-[10px] font-bold text-slate-500 uppercase tracking-widest animate-pulse">Menghubungkan ke Server...</p>
        </div>

        <div id="santri-grid" class="grid grid-cols-1 gap-2 mt-4 mb-32"></div>

        <div class="fixed bottom-0 left-0 w-full p-6 bg-gradient-to-t from-slate-950 to-transparent">
            <button id="btn-submit" onclick="confirmSubmit()" class="w-full max-w-[402px] mx-auto py-4 bg-emerald-600 hover:bg-emerald-500 text-white font-bold rounded-2xl shadow-[0_10px_30px_-10px_rgba(16,185,129,0.5)] transition-all active:scale-95 flex items-center justify-center gap-3">
                <span id="btn-text" class="uppercase text-sm tracking-wider font-extrabold">Simpan Absensi</span>
                <i class="fas fa-paper-plane text-xs opacity-50"></i>
            </button>
        </div>
    </div>

    <script>
        // SCRIPT LOGIKA TETAP SAMA AGAR TIDAK ERROR
        const CONFIG = {
            API: "https://script.google.com/macros/s/AKfycbw4JRpC7MC_j6_grznsTCXJfTDYXDHB5mM24ArR4hnQmA_O-D_pwmAw0agM0whwmk2N/exec",
            MENU: { 
                "MUDA (PELET)": ["Putih", "Kuning", "Merah"], 
                "MADYA (PELET)": ["Biru", "Coklat", "Hitam"] 
            }
        };

        let state = { kampus: '', tingkat: '', pelet: '', data: [] };

        function showPage(id) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            window.scrollTo(0, 0);
        }

        function navToPelet(k) {
            state.kampus = k;
            document.getElementById('display-kampus').innerText = k;
            renderPeletMenu();
            showPage('page-pelet');
        }

        function renderPeletMenu() {
            const container = document.getElementById('pelet-list');
            container.innerHTML = '';
            for (const [tingkat, warnaList] of Object.entries(CONFIG.MENU)) {
                let html = `<div class="mb-4"><h3 class="text-[10px] font-bold text-slate-500 tracking-[0.2em] mb-3 ml-2 uppercase">${tingkat}</h3>`;
                warnaList.forEach(warna => {
                    const colorMap = {
                        'Putih': 'bg-slate-100', 'Kuning': 'bg-yellow-400', 'Merah': 'bg-red-500',
                        'Biru': 'bg-blue-500', 'Coklat': 'bg-amber-800', 'Hitam': 'bg-slate-800'
                    };
                    html += `
                        <button onclick="navToDaftar('${tingkat}', '${warna}')" class="opt-btn w-full p-4 rounded-2xl flex items-center justify-between mb-2 group">
                            <div class="flex items-center gap-4">
                                <div class="w-3 h-10 rounded-full ${colorMap[warna] || 'bg-emerald-500'} shadow-lg"></div>
                                <span class="font-bold text-white text-md tracking-tight">Pelet ${warna}</span>
                            </div>
                            <i class="fas fa-chevron-right text-slate-700"></i>
                        </button>`;
                });
                container.innerHTML += html + `</div>`;
            }
        }

        async function navToDaftar(t, p) {
            state.tingkat = t; 
            state.pelet = p;
            document.getElementById('display-info').innerText = `${t} • ${p}`;
            showPage('page-daftar');
            if(state.data.length === 0) await fetchSantri();
            renderSantri();
        }

        async function fetchSantri() {
            const loading = document.getElementById('loading');
            loading.classList.remove('hidden');
            try {
                const res = await fetch(CONFIG.API);
                state.data = await res.json();
            } catch (e) { 
                alert("Gagal memuat data."); 
            } finally { 
                loading.classList.add('hidden'); 
            }
        }

        function renderSantri() {
            const grid = document.getElementById('santri-grid');
            const filtered = state.data.filter(s => s.Kampus === state.kampus && s.Pelet === state.pelet);
            
            if(filtered.length === 0) {
                grid.innerHTML = `<div class="text-center py-20"><i class="fas fa-ghost text-4xl text-slate-800 mb-4 block"></i><p class="text-slate-500 font-bold text-sm">Tidak ada data santri.</p></div>`;
                return;
            }
            
            grid.innerHTML = filtered.map(s => `
                <label class="check-card cursor-pointer block">
                    <input type="checkbox" value="${s.Nama}" class="hidden" onchange="updateUI()">
                    <div class="card-content glass p-4 rounded-2xl border border-transparent transition-all flex items-center justify-between">
                        <div class="flex items-center gap-4">
                            <div class="w-10 h-10 rounded-xl bg-slate-800 flex items-center justify-center text-slate-400 font-bold text-xs uppercase border border-white/5">${s.Nama.substring(0,2)}</div>
                            <span class="font-bold text-slate-200 text-sm uppercase tracking-tight">${s.Nama}</span>
                        </div>
                        <div class="w-6 h-6 rounded-lg border-2 border-slate-700 flex items-center justify-center text-[10px] text-transparent check-icon transition-all">
                            <i class="fas fa-check"></i>
                        </div>
                    </div>
                </label>`).join('');
            updateUI();
        }

        function filterSantri() {
            const query = document.getElementById('search-input').value.toLowerCase();
            document.querySelectorAll('.check-card').forEach(card => {
                const nama = card.querySelector('span').innerText.toLowerCase();
                card.style.display = nama.includes(query) ? 'block' : 'none';
            });
        }

        function toggleSelectAll() {
            const checkboxes = document.querySelectorAll('#santri-grid input[type="checkbox"]');
            const visible = Array.from(checkboxes).filter(cb => cb.closest('.check-card').style.display !== 'none');
            const allChecked = visible.every(cb => cb.checked);
            visible.forEach(cb => cb.checked = !allChecked);
            updateUI();
        }

        function updateUI() {
            const checked = document.querySelectorAll('#santri-grid input:checked').length;
            document.getElementById('check-count').innerText = checked;
        }

        function getDeviceLocation() {
            return new Promise((resolve) => {
                if (!navigator.geolocation) resolve("Tidak Didukung");
                else {
                    navigator.geolocation.getCurrentPosition(
                        (pos) => resolve(`${pos.coords.latitude},${pos.coords.longitude}`),
                        () => resolve("Izin Ditolak"),
                        { enableHighAccuracy: true, timeout: 8000 }
                    );
                }
            });
        }

        function confirmSubmit() {
            const count = document.querySelectorAll('#santri-grid input:checked').length;
            if(count === 0) return alert("Pilih minimal satu santri!");
            if(confirm(`Kirim absensi untuk ${count} santri?`)) submitAbsen();
        }

        async function submitAbsen() {
            const hadir = Array.from(document.querySelectorAll('#santri-grid input:checked')).map(cb => cb.value);
            const btn = document.getElementById('btn-submit');
            const btnText = document.getElementById('btn-text');
            const now = new Date();
            
            btn.disabled = true;
            btnText.innerHTML = `<i class="fas fa-spinner fa-spin"></i> LOKASI...`;

            const loc = await getDeviceLocation();
            btnText.innerHTML = `<i class="fas fa-circle-notch fa-spin"></i> MENGIRIM...`;

            const payload = {
                timestamp: now.toISOString(),
                hari: now.toLocaleDateString('id-ID', { weekday: 'long' }),
                tanggal: now.toLocaleDateString('id-ID', { day: '2-digit', month: '2-digit', year: 'numeric' }),
                jam: now.toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' }),
                kampus: state.kampus, 
                pelet: state.pelet, 
                hadir: hadir.join(", "), 
                lokasi: loc
            };

            try {
                await fetch(CONFIG.API, { 
                    method: 'POST', 
                    mode: 'no-cors', 
                    body: JSON.stringify(payload) 
                });
                alert("✅ ABSENSI BERHASIL DISIMPAN!");
                location.reload();
            } catch (e) {
                alert("Gagal mengirim data.");
                btn.disabled = false;
                btnText.innerText = "Simpan Absensi";
            }
        }
        // PROTEKSI HALAMAN: Jalankan sebelum konten dimuat
        if (sessionStorage.getItem('isLoggedIn') !== 'true') {
            window.location.href = "login.html"; // Alihkan ke file login Anda
        }
    </script>
</body>
</html>
