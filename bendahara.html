<!DOCTYPE html>
<html lang="id" class="scroll-smooth">
<head>
    <script>
    // SISTEM PROTEKSI HALAMAN
    (function() {
        const user = JSON.parse(localStorage.getItem('currentUserProfile'));
        if (!user || user.redirecturl !== 'bendahara.html') {
            alert("Silahkan Login Terlebih Dahulu.");
            window.location.href = 'login.html';
        }
    })();
    </script>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Brankas | PSNU PAGARNUSA UNUSIA</title>
    <link rel="icon" href="https://cdn3d.iconscout.com/3d/premium/thumb/privacy-3d-icon-png-download-8342338.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: { 
                extend: { 
                    colors: { 
                        primary: '#1B7548',
                        secondary: '#F59E0B',
                        danger: '#E11D48',
                        surface: '#ffffff'
                    },
                    fontFamily: { sans: ['Plus Jakarta Sans', 'sans-serif'] },
                    borderRadius: { '4xl': '2rem' }
                } 
            }
        }
    </script>

    <style type="text/css">
        body { font-family: 'Plus Jakarta Sans', sans-serif; letter-spacing: -0.01em; }
        
        .sidebar-link { transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1); }
        .sidebar-link.active { 
            background: linear-gradient(135deg, #1B7548 0%, #10b981 100%);
            color: white !important; 
            box-shadow: 0 15px 30px -10px rgba(27, 117, 72, 0.4);
            transform: translateX(8px);
        }

        .glass-card { 
            background: rgba(255, 255, 255, 0.9); 
            backdrop-filter: blur(16px);
            border: 1px solid rgba(226, 232, 240, 0.8);
            transition: all 0.3s ease;
        }
        
        .dark .glass-card {
            background: rgba(15, 23, 42, 0.8);
            border: 1px solid rgba(51, 65, 85, 0.5);
        }

        .glass-card:hover { transform: translateY(-4px); box-shadow: 0 20px 40px -15px rgba(0,0,0,0.05); }

        .tab-content { display: none; }
        .tab-content.active { display: block; animation: slideUp 0.6s cubic-bezier(0.16, 1, 0.3, 1); }

        @keyframes slideUp { 
            from { opacity: 0; transform: translateY(20px); filter: blur(10px); } 
            to { opacity: 1; transform: translateY(0); filter: blur(0); } 
        }

        #loader { 
            position: fixed; inset: 0; background: #0f172a; z-index: 9999; 
            display: none; flex-direction: column; align-items: center; justify-content: center;
        }

        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #e2e8f0; border-radius: 10px; }
        .dark .custom-scrollbar::-webkit-scrollbar-thumb { background: #334155; }
    </style>
</head>

<body class="bg-[#F1F5F9] dark:bg-[#020617] text-slate-800 dark:text-slate-100 min-h-screen transition-colors duration-500 custom-scrollbar">
    
    <div id="loader">
        <div class="relative w-24 h-24">
            <div class="absolute inset-0 border-4 border-primary/20 rounded-full"></div>
            <div class="absolute inset-0 border-4 border-primary border-t-transparent rounded-full animate-spin"></div>
            <div class="absolute inset-4 bg-primary/10 rounded-full animate-pulse flex items-center justify-center">
                <i class="fas fa-shield-halved text-primary text-xl"></i>
            </div>
        </div>
        <p class="mt-8 font-bold text-white tracking-[0.3em] text-sm animate-pulse">SYSTEM LOADING</p>
    </div>

    <header class="sticky top-0 z-40 bg-white/80 dark:bg-slate-900/80 backdrop-blur-2xl border-b border-slate-200/60 dark:border-slate-800/60">
        <div class="max-w-7xl mx-auto px-6 py-5 flex justify-between items-center">
            <div class="flex items-center space-x-4">
                <div class="relative">
                    <div class="absolute inset-0 bg-primary blur-lg opacity-20"></div>
                    <div class="relative bg-gradient-to-br from-primary to-emerald-600 p-3 rounded-2xl text-white shadow-xl">
                        <i class="fas fa-vault text-2xl"></i>
                    </div>
                </div>
                <div>
                    <h1 class="text-2xl font-black tracking-tight leading-none">Brankas<span class="text-primary font-medium">Cloud</span></h1>
                    <p class="text-[9px] font-black text-slate-400 uppercase tracking-[0.3em] mt-1">PSNU PAGARNUSA UNUSIA</p>
                </div>
            </div>

            <div class="flex items-center gap-4">
                <div class="hidden md:flex bg-slate-100 dark:bg-slate-800 p-1 rounded-xl">
                    <button onclick="initDashboard()" class="p-2.5 rounded-lg hover:bg-white dark:hover:bg-slate-700 transition-all text-slate-500 hover:text-primary">
                        <i class="fas fa-sync-alt"></i>
                    </button>
                    <button id="darkToggle" class="p-2.5 rounded-lg hover:bg-white dark:hover:bg-slate-700 text-slate-600 dark:text-amber-400 transition-all">
                        <i class="fas fa-moon dark:hidden"></i>
                        <i class="fas fa-sun hidden dark:block"></i>
                    </button>
                </div>
                <div class="h-8 w-[1px] bg-slate-200 dark:bg-slate-800 mx-2"></div>
                <button onclick="logoutBendahara()" class="flex items-center gap-2 px-5 py-3 bg-red-50 dark:bg-red-500/10 text-red-600 font-bold rounded-xl hover:bg-red-600 hover:text-white transition-all duration-300">
                    <i class="fas fa-power-off text-sm"></i>
                    <span class="text-xs uppercase tracking-widest">Logout</span>
                </button>
            </div>
        </div>
    </header>

    <div class="max-w-7xl mx-auto px-6 py-10 grid grid-cols-1 lg:grid-cols-12 gap-10">
        
        <aside class="lg:col-span-3">
            <nav class="space-y-3 sticky top-32">
                <div class="px-4 mb-6">
                    <p class="text-[10px] font-black text-slate-400 dark:text-slate-500 uppercase tracking-[0.4em]">Navigation</p>
                </div>
                <button data-target="ringkasan" class="sidebar-link active w-full flex items-center gap-4 px-6 py-4 rounded-2xl font-bold">
                    <i class="fas fa-grid-2 w-5"></i> Dashboard
                </button>
                <button data-target="transaksi" class="sidebar-link w-full flex items-center gap-4 px-6 py-4 rounded-2xl font-bold text-slate-500 dark:text-slate-400 hover:bg-white dark:hover:bg-slate-800">
                    <i class="fas fa-receipt w-5"></i> Buku Kas
                </button>
                <button data-target="iuran" class="sidebar-link w-full flex items-center gap-4 px-6 py-4 rounded-2xl font-bold text-slate-500 dark:text-slate-400 hover:bg-white dark:hover:bg-slate-800">
                    <i class="fas fa-user-check w-5"></i> Iuran Santri
                </button>
                <button data-target="statistik" class="sidebar-link w-full flex items-center gap-4 px-6 py-4 rounded-2xl font-bold text-slate-500 dark:text-slate-400 hover:bg-white dark:hover:bg-slate-800">
                    <i class="fas fa-chart-simple w-5"></i> Analitik
                </button>
                
                <div class="pt-8 mt-8 border-t border-slate-200 dark:border-slate-800">
                    <button onclick="exportExcel()" class="w-full group flex items-center justify-between px-6 py-5 bg-emerald-500/5 hover:bg-emerald-500 text-emerald-600 hover:text-white rounded-[2rem] transition-all border border-emerald-500/20">
                        <div class="flex items-center gap-3 text-xs font-black uppercase tracking-widest">
                            <i class="fas fa-file-excel text-lg"></i> Export Excel
                        </div>
                        <i class="fas fa-chevron-right text-[10px] opacity-50 group-hover:translate-x-1 transition-transform"></i>
                    </button>
                </div>
            </nav>
        </aside>

        <main class="lg:col-span-9 space-y-10">
            
            <section id="ringkasan" class="tab-content active space-y-10">
                <div class="grid grid-cols-1 sm:grid-cols-3 gap-6">
                    <div class="glass-card p-8 rounded-4xl group relative overflow-hidden">
                        <div class="absolute -right-6 -bottom-6 w-32 h-32 bg-emerald-500/5 rounded-full group-hover:scale-150 transition-transform duration-1000"></div>
                        <div class="flex justify-between items-start mb-6">
                            <div class="w-12 h-12 bg-emerald-100 dark:bg-emerald-500/20 text-emerald-600 rounded-2xl flex items-center justify-center">
                                <i class="fas fa-arrow-down-long"></i>
                            </div>
                            <span class="text-[10px] font-black text-emerald-500 bg-emerald-50 dark:bg-emerald-500/10 px-3 py-1 rounded-full uppercase">Pemasukan</span>
                        </div>
                        <p class="text-xs font-bold text-slate-400 uppercase tracking-widest">Total Masuk</p>
                        <h2 id="totalMasuk" class="text-3xl font-black mt-2 text-slate-800 dark:text-white">Rp 0</h2>
                    </div>

                    <div class="glass-card p-8 rounded-4xl group relative overflow-hidden">
                        <div class="absolute -right-6 -bottom-6 w-32 h-32 bg-rose-500/5 rounded-full group-hover:scale-150 transition-transform duration-1000"></div>
                        <div class="flex justify-between items-start mb-6">
                            <div class="w-12 h-12 bg-rose-100 dark:bg-rose-500/20 text-rose-600 rounded-2xl flex items-center justify-center">
                                <i class="fas fa-arrow-up-long"></i>
                            </div>
                            <span class="text-[10px] font-black text-rose-500 bg-rose-50 dark:bg-rose-500/10 px-3 py-1 rounded-full uppercase">Pengeluaran</span>
                        </div>
                        <p class="text-xs font-bold text-slate-400 uppercase tracking-widest">Total Keluar</p>
                        <h2 id="totalKeluar" class="text-3xl font-black mt-2 text-slate-800 dark:text-white">Rp 0</h2>
                    </div>

                    <div class="glass-card p-8 rounded-4xl bg-gradient-to-br from-primary to-emerald-900 text-white shadow-2xl shadow-primary/30 border-none relative overflow-hidden group">
                         <div class="absolute inset-0 bg-[url('https://www.transparenttextures.com/patterns/carbon-fibre.png')] opacity-10"></div>
                        <p class="text-xs font-black opacity-60 uppercase tracking-[0.2em]">Saldo Akhir Kas</p>
                        <h2 id="saldoAkhir" class="text-3xl font-black mt-4 tracking-tight">Rp 0</h2>
                        <div class="mt-8 flex items-center gap-2">
                            <div class="h-1.5 flex-1 bg-white/20 rounded-full overflow-hidden">
                                <div class="h-full bg-secondary w-full animate-pulse shadow-[0_0_15px_rgba(245,158,11,0.5)]"></div>
                            </div>
                            <i class="fas fa-circle-check text-secondary text-xs"></i>
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-10">
                    <div class="glass-card p-10 rounded-4xl">
                        <div class="flex justify-between items-center mb-10">
                            <div>
                                <h3 class="font-black text-lg tracking-tight">Aktivitas Terbaru</h3>
                                <p class="text-[10px] text-slate-400 font-bold uppercase tracking-widest mt-1">Data Real-time</p>
                            </div>
                            <button data-target="transaksi" class="sidebar-link w-10 h-10 rounded-xl bg-slate-50 dark:bg-slate-800 flex items-center justify-center text-primary hover:scale-110 transition-all">
                                <i class="fas fa-arrow-right text-sm"></i>
                            </button>
                        </div>
                        <div id="recentList" class="space-y-6">
                            <p class="text-center text-slate-400 py-10 font-medium italic">Belum ada aktivitas.</p>
                        </div>
                    </div>

                    <div class="glass-card p-10 rounded-4xl flex flex-col items-center justify-center text-center space-y-8 border-dashed border-2 border-primary/20 bg-emerald-500/[0.02]">
                        <div class="relative">
                            <div class="absolute inset-0 bg-primary blur-2xl opacity-20 animate-pulse"></div>
                            <div class="relative w-24 h-24 bg-gradient-to-br from-primary to-emerald-600 text-white rounded-[2.5rem] flex items-center justify-center text-4xl shadow-2xl rotate-6 hover:rotate-0 transition-transform duration-500">
                                <i class="fas fa-plus-circle"></i>
                            </div>
                        </div>
                        <div>
                            <h4 class="font-black text-2xl tracking-tight text-slate-800 dark:text-white">Input Transaksi</h4>
                            <p class="text-sm text-slate-500 dark:text-slate-400 mt-3 max-w-[250px] mx-auto leading-relaxed">Catat aliran dana masuk dan keluar secara instan ke database awan.</p>
                        </div>
                        <button onclick="openModal('modalTx')" class="w-full py-5 bg-slate-900 dark:bg-primary text-white rounded-3xl font-black text-xs uppercase tracking-[0.2em] shadow-xl hover:shadow-primary/40 hover:-translate-y-2 transition-all duration-300">
                            BUAT TRANSAKSI BARU
                        </button>
                    </div>
                </div>
            </section>

            <section id="transaksi" class="tab-content space-y-6">
                <div class="glass-card rounded-4xl overflow-hidden border-none shadow-xl">
                    <div class="p-10 bg-white dark:bg-slate-800/50 flex flex-col md:flex-row gap-8 justify-between items-center border-b border-slate-100 dark:border-slate-800">
                        <div>
                            <h2 class="font-black text-2xl tracking-tight">Buku Kas Umum</h2>
                            <p class="text-xs text-slate-400 font-bold uppercase tracking-widest mt-2 flex items-center gap-2">
                                <span class="w-2 h-2 bg-primary rounded-full animate-ping"></span>
                                Monitoring Seluruh Transaksi
                            </p>
                        </div>
                        <div class="flex gap-4 w-full md:w-auto">
                            <div class="relative flex-1">
                                <i class="fas fa-search absolute left-5 top-1/2 -translate-y-1/2 text-slate-400"></i>
                                <input type="text" id="searchTx" onkeyup="filterTable('searchTx', 'txBody')" placeholder="Cari..." class="w-full md:w-72 pl-14 pr-6 py-4 rounded-2xl bg-slate-50 dark:bg-slate-900 border-none text-sm font-bold focus:ring-2 focus:ring-primary outline-none transition-all">
                            </div>
                            <button onclick="openModal('modalTx')" class="px-8 py-4 bg-primary text-white rounded-2xl text-[10px] font-black uppercase tracking-widest shadow-lg hover:bg-emerald-700 transition-all">
                                <i class="fas fa-plus mr-2"></i> Tambah
                            </button>
                        </div>
                    </div>
                    <div class="overflow-x-auto custom-scrollbar">
                        <table class="w-full text-sm">
                            <thead>
                                <tr class="text-[10px] text-slate-400 uppercase tracking-[0.2em] bg-slate-50/50 dark:bg-slate-900/50">
                                    <th class="p-8 text-left">Tanggal</th>
                                    <th class="p-8 text-left">Deskripsi / Nama</th>
                                    <th class="p-8 text-center">Status</th>
                                    <th class="p-8 text-right">Nominal</th>
                                    <th class="p-8 text-center">Tindakan</th> 
                                </tr>
                            </thead>
                            <tbody id="txBody" class="divide-y divide-slate-100 dark:divide-slate-800"></tbody>
                        </table>
                    </div>
                </div>
            </section>

            <section id="iuran" class="tab-content space-y-8">
                <div class="glass-card rounded-4xl overflow-hidden border-none shadow-2xl">
                    <div class="p-10 bg-gradient-to-br from-emerald-600 to-teal-800 text-white relative overflow-hidden">
                        <div class="absolute top-0 right-0 p-10 opacity-10">
                            <i class="fas fa-hand-holding-dollar text-[120px] -rotate-12"></i>
                        </div>
                        <div class="relative z-10 flex flex-col md:flex-row justify-between items-center gap-8">
                            <div>
                                <h2 class="font-black text-3xl tracking-tight">Manajemen Iuran</h2>
                                <p class="text-xs opacity-70 mt-3 uppercase tracking-[0.3em] font-bold">Infaq & Iuran Bulanan Santri</p>
                            </div>
                            <button onclick="openModal('modalIuran')" class="px-10 py-5 bg-white text-emerald-800 rounded-[2rem] text-xs font-black uppercase tracking-widest shadow-2xl hover:scale-105 active:scale-95 transition-all">
                                INPUT PEMBAYARAN BARU
                            </button>
                        </div>
                    </div>
                    <div class="p-8 border-b border-slate-100 dark:border-slate-800 bg-white/50 dark:bg-slate-900/50">
                        <div class="relative max-w-xl mx-auto">
                            <i class="fas fa-filter absolute left-6 top-1/2 -translate-y-1/2 text-primary"></i>
                            <input type="text" id="searchIuran" onkeyup="filterTable('searchIuran', 'iuranBody')" placeholder="Cari Nama Santri..." class="w-full pl-16 pr-8 py-5 rounded-[2rem] bg-white dark:bg-slate-800 border-2 border-slate-100 dark:border-slate-700 text-sm font-bold outline-none focus:border-primary transition-all">
                        </div>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm">
                            <thead>
                                <tr class="text-[10px] text-slate-400 uppercase tracking-[0.2em] bg-slate-50/50 dark:bg-slate-900/50 font-black">
                                    <th class="p-8 text-left">Tgl Bayar</th>
                                    <th class="p-8 text-left">Nama Lengkap</th>
                                    <th class="p-8 text-left">Periode</th>
                                    <th class="p-8 text-right">Jumlah</th>
                                    <th class="p-8 text-center">Cetak / Aksi</th>
                                </tr>
                            </thead>
                            <tbody id="iuranBody" class="divide-y divide-slate-100 dark:divide-slate-800 font-medium"></tbody>
                        </table>
                    </div>
                </div>
            </section>

            <section id="statistik" class="tab-content space-y-10">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-10">
                    <div class="glass-card p-10 rounded-4xl">
                        <h3 class="font-black text-xs mb-10 uppercase tracking-[0.3em] text-slate-400">Visualisasi Cashflow</h3>
                        <div class="h-[350px]">
                            <canvas id="cashflowChart"></canvas>
                        </div>
                    </div>
                    <div class="glass-card p-10 rounded-4xl">
                        <h3 class="font-black text-xs mb-10 uppercase tracking-[0.3em] text-slate-400">Proporsi Pendapatan</h3>
                        <div class="h-[350px]">
                            <canvas id="pieChart"></canvas>
                        </div>
                    </div>
                </div>
            </section>

        </main>
    </div>

    <div id="modalTx" class="fixed inset-0 bg-slate-950/80 backdrop-blur-md z-[100] hidden items-center justify-center p-6">
        <div class="bg-white dark:bg-slate-900 w-full max-w-md rounded-[3rem] shadow-2xl overflow-hidden animate-fade border border-white/20">
            <div class="p-12 pb-6 flex justify-between items-center">
                <div>
                    <h3 class="text-3xl font-black tracking-tight">Data Kas</h3>
                    <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest mt-1">Form Transaksi Baru</p>
                </div>
                <button onclick="closeModal('modalTx')" class="w-12 h-12 rounded-2xl bg-slate-50 dark:bg-slate-800 text-slate-400 hover:text-red-500 transition-all"><i class="fas fa-times"></i></button>
            </div>
            <form id="txForm" class="p-12 pt-4 space-y-6">
                <div class="space-y-3">
                    <label class="text-[10px] font-black uppercase text-slate-400 tracking-widest ml-1">Keterangan / Deskripsi</label>
                    <input type="text" id="txDesc" required placeholder="Tujuan transaksi..." class="w-full px-6 py-5 rounded-2xl bg-slate-50 dark:bg-slate-800 border-none text-sm font-bold focus:ring-2 focus:ring-primary outline-none transition-all">
                </div>
                <div class="grid grid-cols-2 gap-6">
                    <div class="space-y-3">
                        <label class="text-[10px] font-black uppercase text-slate-400 tracking-widest ml-1">Kategori</label>
                        <select id="txType" class="w-full px-6 py-5 rounded-2xl bg-slate-50 dark:bg-slate-800 border-none text-sm font-bold focus:ring-2 focus:ring-primary outline-none appearance-none">
                            <option value="Masuk">Kas Masuk</option>
                            <option value="Keluar">Kas Keluar</option>
                        </select>
                    </div>
                    <div class="space-y-3">
                        <label class="text-[10px] font-black uppercase text-slate-400 tracking-widest ml-1">Nominal (Rp)</label>
                        <input type="number" id="txAmount" required placeholder="0" class="w-full px-6 py-5 rounded-2xl bg-slate-50 dark:bg-slate-800 border-none text-sm font-bold focus:ring-2 focus:ring-primary outline-none">
                    </div>
                </div>
                <div class="space-y-3">
                    <label class="text-[10px] font-black uppercase text-slate-400 tracking-widest ml-1">Tgl Transaksi</label>
                    <input type="date" id="txDate" required class="w-full px-6 py-5 rounded-2xl bg-slate-50 dark:bg-slate-800 border-none text-sm font-bold focus:ring-2 focus:ring-primary outline-none">
                </div>
                <button type="submit" class="w-full py-6 bg-primary text-white rounded-[2rem] font-black shadow-xl shadow-primary/30 mt-8 hover:scale-[1.02] active:scale-95 transition-all uppercase tracking-widest text-xs">Simpan Data</button>
            </form>
        </div>
    </div>

    <div id="modalIuran" class="fixed inset-0 bg-slate-950/80 backdrop-blur-md z-[100] hidden items-center justify-center p-6">
        <div class="bg-white dark:bg-slate-900 w-full max-w-md rounded-[3rem] shadow-2xl overflow-hidden animate-fade border border-white/20">
            <div class="p-12 pb-8 flex justify-between items-center border-b border-slate-50 dark:border-slate-800">
                <div>
                    <h3 class="text-3xl font-black text-emerald-600 tracking-tight">Kuitansi</h3>
                    <p class="text-[10px] text-slate-400 font-black uppercase mt-1 tracking-[0.2em]">Input Iuran Santri</p>
                </div>
                <button onclick="closeModal('modalIuran')" class="w-12 h-12 rounded-2xl hover:bg-slate-50 dark:hover:bg-slate-800 flex items-center justify-center transition-all text-slate-400"><i class="fas fa-times"></i></button>
            </div>
            <form id="iuranForm" class="p-12 space-y-6">
                <div class="space-y-3">
                    <label class="text-[10px] font-black uppercase text-slate-400 tracking-widest ml-1">Nama Lengkap</label>
                    <input type="text" id="santriName" required placeholder="Nama santri..." class="w-full px-6 py-5 rounded-2xl bg-slate-50 dark:bg-slate-800 border-none text-sm font-bold focus:ring-2 focus:ring-emerald-500 transition-all">
                </div>
                <div class="grid grid-cols-2 gap-6">
                    <div class="space-y-3">
                        <label class="text-[10px] font-black uppercase text-slate-400 tracking-widest ml-1">Bulan</label>
                        <select id="iuranMonth" class="w-full px-6 py-5 rounded-2xl bg-slate-50 dark:bg-slate-800 border-none text-sm font-bold outline-none">
                            <option>Januari</option><option>Februari</option><option>Maret</option><option>April</option><option>Mei</option><option>Juni</option><option>Juli</option><option>Agustus</option><option>September</option><option>Oktober</option><option>November</option><option>Desember</option>
                        </select>
                    </div>
                    <div class="space-y-3">
                        <label class="text-[10px] font-black uppercase text-slate-400 tracking-widest ml-1">Nominal</label>
                        <input type="number" id="iuranAmount" required value="5000" class="w-full px-6 py-5 rounded-2xl bg-slate-50 dark:bg-slate-800 border-none text-sm font-bold outline-none">
                    </div>
                </div>
                <button type="submit" class="w-full py-6 bg-emerald-600 text-white rounded-[2rem] font-black shadow-xl shadow-emerald-900/20 mt-8 hover:scale-[1.02] active:scale-95 transition-all uppercase tracking-widest text-xs">Konfirmasi & Simpan</button>
            </form>
        </div>
    </div>


    <script>
        const API_URL = "https://script.google.com/macros/s/AKfycbxNLsByaqUJMMEhNyGV9btVBHtDsGfGakQ197vUfw1uvWS-XGJEJLbx5URaKMCpslEI/exec"; 
        
        let transactions = [];
        let cashChart = null;
        let pChart = null;

        // --- Navigation Controller ---
        document.querySelectorAll('.sidebar-link').forEach(btn => {
            btn.addEventListener('click', () => {
                const target = btn.dataset.target;
                if(!target) return;

                document.querySelectorAll('.sidebar-link').forEach(l => {
                    l.classList.remove('active', 'text-white');
                    l.classList.add('text-slate-500');
                });
                btn.classList.add('active', 'text-white');
                btn.classList.remove('text-slate-500');

                document.querySelectorAll('.tab-content').forEach(s => s.classList.remove('active'));
                document.getElementById(target).classList.add('active');

                if(target === 'statistik') setTimeout(renderCharts, 100);
            });
        });

        // --- Initialize Dashboard ---
        window.onload = () => {
            initDashboard();
            document.getElementById('txDate').valueAsDate = new Date();
        };

        async function initDashboard() {
            if (API_URL === "URL_WEB_APP_ANDA_DISINI") {
                transactions = [
                    {tanggal: new Date(), keterangan: "Iuran: Ahmad Fauzi - Januari", tipe: "Masuk", jumlah: 50000},
                    {tanggal: new Date(), keterangan: "Pembelian Token Listrik", tipe: "Keluar", jumlah: 100000}
                ];
                updateUI();
                return;
            }

            toggleLoader(true);
            try {
                const res = await fetch(API_URL);
                const data = await res.json();
                transactions = Array.isArray(data) ? data : [];
                updateUI();
            } catch (e) {
                alert("Gagal terhubung ke Cloud. Pastikan API_URL benar.");
            } finally {
                setTimeout(() => toggleLoader(false), 500);
            }
        }

        function updateUI() {
            renderSummary();
            renderTableGeneral();
            renderTableIuran();
            renderRecent();
        }

        function renderSummary() {
            const masuk = transactions.filter(t => t.tipe === 'Masuk').reduce((s, t) => s + Number(t.jumlah), 0);
            const keluar = transactions.filter(t => t.tipe === 'Keluar').reduce((s, t) => s + Number(t.jumlah), 0);
            const saldo = masuk - keluar;

            document.getElementById('totalMasuk').innerText = formatIDR(masuk);
            document.getElementById('totalKeluar').innerText = formatIDR(keluar);
            document.getElementById('saldoAkhir').innerText = formatIDR(saldo);
        }

        function renderTableGeneral() {
            const body = document.getElementById('txBody');
            body.innerHTML = '';
            
            [...transactions].reverse().forEach((t, index) => {
                const isIuran = t.keterangan.includes('Iuran:');
                body.innerHTML += `
                    <tr class="hover:bg-slate-50 dark:hover:bg-slate-800/40 transition-colors group">
                        <td class="p-8 text-slate-400 font-bold text-xs">${formatDate(t.tanggal)}</td>
                        <td class="p-8">
                            <p class="font-black text-slate-700 dark:text-slate-200">${t.keterangan}</p>
                            <span class="text-[9px] ${isIuran ? 'text-emerald-500' : 'text-slate-400'} font-black uppercase tracking-widest mt-1 block">
                                <i class="fas ${isIuran ? 'fa-tag' : 'fa-folder'} mr-1"></i> ${isIuran ? 'ZONA IURAN' : 'KAS OPERASIONAL'}
                            </span>
                        </td>
                        <td class="p-8 text-center">
                            <span class="px-4 py-2 rounded-full text-[9px] font-black tracking-widest ${t.tipe === 'Masuk' ? 'bg-emerald-100 text-emerald-600 dark:bg-emerald-500/20' : 'bg-rose-100 text-rose-600 dark:bg-rose-500/20'}">
                                ${t.tipe.toUpperCase()}
                            </span>
                        </td>
                        <td class="p-8 text-right font-black text-base ${t.tipe === 'Masuk' ? 'text-emerald-600' : 'text-slate-700 dark:text-slate-200'}">
                            ${formatIDR(t.jumlah)}
                        </td>
                        <td class="p-8 text-center">
                            <button onclick="deleteTx('${t.keterangan}', ${t.jumlah})" class="w-10 h-10 rounded-xl text-slate-300 hover:text-rose-500 hover:bg-rose-50 dark:hover:bg-rose-900/20 transition-all">
                                <i class="fas fa-trash-can"></i>
                            </button>
                        </td>
                    </tr>`;
            });
        }

        function renderTableIuran() {
            const body = document.getElementById('iuranBody');
            body.innerHTML = '';
            
            transactions.filter(t => t.keterangan.startsWith('Iuran:')).reverse().forEach(t => {
                const parts = t.keterangan.replace('Iuran: ', '').split(' - ');
                const nama = parts[0] || 'Santri';
                const bulan = parts[1] || '-';

                body.innerHTML += `
                    <tr class="hover:bg-emerald-50/50 dark:hover:bg-emerald-900/10 transition-all">
                        <td class="p-8 text-slate-400 font-bold text-xs">${formatDate(t.tanggal)}</td>
                        <td class="p-8 font-black text-slate-700 dark:text-slate-200 uppercase tracking-tight">${nama}</td>
                        <td class="p-8"><span class="px-4 py-2 bg-slate-100 dark:bg-slate-800 rounded-xl text-[10px] font-black uppercase text-slate-500 dark:text-slate-400 tracking-widest">${bulan}</span></td>
                        <td class="p-8 text-right font-black text-emerald-600 text-base">${formatIDR(t.jumlah)}</td>
                        <td class="p-8">
                            <div class="flex items-center justify-center gap-3">
                                <button onclick="generatePDF('${nama}', '${bulan}', '${t.jumlah}')" class="w-10 h-10 bg-primary/10 text-primary rounded-xl hover:bg-primary hover:text-white transition-all shadow-sm" title="Cetak Kuitansi">
                                    <i class="fas fa-print text-xs"></i>
                                </button>
                                <button onclick="editIuran('${t.keterangan}', ${t.jumlah}, '${t.tanggal}')" class="w-10 h-10 bg-amber-100 text-amber-600 rounded-xl hover:bg-amber-500 hover:text-white transition-all shadow-sm" title="Edit">
                                    <i class="fas fa-pen-to-square text-xs"></i>
                                </button>
                                <button onclick="deleteTx('${t.keterangan}', ${t.jumlah})" class="w-10 h-10 bg-rose-100 text-rose-600 rounded-xl hover:bg-rose-500 hover:text-white transition-all shadow-sm" title="Hapus">
                                    <i class="fas fa-trash text-xs"></i>
                                </button>
                            </div>
                        </td>
                    </tr>`;
            });
        }

        function editIuran(fullDesc, amount, date) {
            const cleanDesc = fullDesc.replace('Iuran: ', '');
            const [nama, bulan] = cleanDesc.split(' - ');

            document.getElementById('santriName').value = nama;
            document.getElementById('iuranMonth').value = bulan;
            document.getElementById('iuranAmount').value = amount;

            openModal('modalIuran');

            const confirmEdit = confirm("Apakah Anda Yakin Ingin Mengedit Data Ini?");
            if (confirmEdit) {
                deleteTx(fullDesc, amount);
            } else {
                closeModal('modalIuran');
            }
        }

        function renderRecent() {
            const container = document.getElementById('recentList');
            const recent = transactions.slice(-5).reverse();
            
            if(recent.length === 0) return;
            container.innerHTML = '';
            
            recent.forEach(t => {
                const isMasuk = t.tipe === 'Masuk';
                container.innerHTML += `
                    <div class="flex items-center justify-between p-5 rounded-[1.5rem] bg-white dark:bg-slate-800 border border-slate-100 dark:border-slate-700 shadow-sm hover:shadow-md transition-all">
                        <div class="flex items-center gap-5">
                            <div class="w-12 h-12 rounded-2xl flex items-center justify-center ${isMasuk ? 'bg-emerald-500/10 text-emerald-600' : 'bg-rose-500/10 text-rose-600'} text-sm">
                                <i class="fas ${isMasuk ? 'fa-arrow-trend-up' : 'fa-arrow-trend-down'}"></i>
                            </div>
                            <div>
                                <p class="text-xs font-black truncate w-32 sm:w-48 text-slate-700 dark:text-slate-200 uppercase tracking-tight">${t.keterangan}</p>
                                <p class="text-[9px] text-slate-400 font-bold uppercase mt-1 tracking-widest">${formatDate(t.tanggal)}</p>
                            </div>
                        </div>
                        <p class="font-black text-sm ${isMasuk ? 'text-emerald-500' : 'text-rose-500'}">
                            ${isMasuk ? '+' : '-'} ${formatIDR(t.jumlah)}
                        </p>
                    </div>`;
            });
        }

        document.getElementById('txForm').onsubmit = (e) => {
            e.preventDefault();
            const payload = {
                date: document.getElementById('txDate').value,
                desc: document.getElementById('txDesc').value,
                type: document.getElementById('txType').value,
                amount: parseInt(document.getElementById('txAmount').value)
            };
            saveToCloud(payload, 'modalTx');
        };

        document.getElementById('iuranForm').onsubmit = (e) => {
            e.preventDefault();
            const payload = {
                date: new Date().toISOString().split('T')[0],
                desc: `Iuran: ${document.getElementById('santriName').value} - ${document.getElementById('iuranMonth').value}`,
                type: 'Masuk',
                amount: parseInt(document.getElementById('iuranAmount').value)
            };
            saveToCloud(payload, 'modalIuran');
        };

        async function saveToCloud(payload, modalId) {
            if (API_URL.includes("URL_WEB_APP")) {
                alert("Simpan gagal: API URL belum dikonfigurasi.");
                return;
            }

            toggleLoader(true);
            try {
                await fetch(API_URL, { method: 'POST', body: JSON.stringify(payload) });
                await initDashboard();
                closeModal(modalId);
                document.querySelector(`#${modalId} form`).reset();
            } catch (e) {
                alert("Terjadi kesalahan sistem.");
            } finally {
                toggleLoader(false);
            }
        }

        async function deleteTx(desc, amount) {
            if(!confirm("Hapus data ini secara permanen?")) return;
            toggleLoader(true);
            try {
                await fetch(API_URL, { method: 'POST', body: JSON.stringify({action: 'delete', desc, amount}) });
                await initDashboard();
            } catch (e) { alert("Gagal menghapus."); }
            finally { toggleLoader(false); }
        }

        function formatIDR(num) {
            return new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', maximumFractionDigits: 0 }).format(num);
        }

        function formatDate(dateStr) {
            return new Date(dateStr).toLocaleDateString('id-ID', { day: '2-digit', month: 'short', year: 'numeric' });
        }

        function filterTable(inputId, tableId) {
            const val = document.getElementById(inputId).value.toLowerCase();
            document.querySelectorAll(`#${tableId} tr`).forEach(tr => {
                tr.style.display = tr.innerText.toLowerCase().includes(val) ? '' : 'none';
            });
        }

        function renderCharts() {
            const ctx1 = document.getElementById('cashflowChart').getContext('2d');
            const ctx2 = document.getElementById('pieChart').getContext('2d');
            
            if(cashChart) cashChart.destroy();
            if(pChart) pChart.destroy();

            const last7 = transactions.slice(-7);
            cashChart = new Chart(ctx1, {
                type: 'line',
                data: {
                    labels: last7.map(t => formatDate(t.tanggal)),
                    datasets: [{
                        label: 'Transaksi',
                        data: last7.map(t => t.tipe === 'Masuk' ? t.jumlah : -t.jumlah),
                        borderColor: '#1B7548',
                        backgroundColor: 'rgba(27, 117, 72, 0.1)',
                        borderWidth: 4,
                        fill: true,
                        tension: 0.4,
                        pointRadius: 6,
                        pointBackgroundColor: '#fff',
                        pointBorderWidth: 3
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
            });

            const iuranCount = transactions.filter(t => t.keterangan.startsWith('Iuran:')).length;
            pChart = new Chart(ctx2, {
                type: 'doughnut',
                data: {
                    labels: ['Iuran Santri', 'Kas Umum'],
                    datasets: [{
                        data: [iuranCount, transactions.length - iuranCount],
                        backgroundColor: ['#10b981', '#6366f1'],
                        borderWidth: 0,
                        hoverOffset: 20
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false, cutout: '80%', plugins: { legend: { position: 'bottom' } } }
            });
        }

        async function generatePDF(nama, bulan, jumlah) {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            const totalIuran = transactions.filter(t => t.keterangan.startsWith('Iuran:')).length;
            const nomorUrut = String(totalIuran + 1).padStart(3, '0');
            const noReferensi = `K-ISPSNUPN/27091985${nomorUrut}`;

            doc.setFillColor(27, 117, 72);
            doc.rect(0, 0, 210, 55, 'F'); 

            doc.setTextColor(255, 255, 255);
            doc.setFontSize(22);
            doc.setFont(undefined, 'bold');
            doc.text("KUITANSI PEMBAYARAN", 105, 35, { align: 'center' }); 
            
            doc.setTextColor(40, 40, 40);
            doc.setFontSize(10);
            doc.setFont(undefined, 'normal');
            doc.text(`No. Referensi: ${noReferensi}`, 20, 70); 
            doc.text(`Tanggal Cetak: ${new Date().toLocaleString('id-ID')}`, 20, 77); 
            
            doc.setDrawColor(200, 200, 200);
            doc.line(20, 85, 190, 85);
            
            doc.setFontSize(12);
            doc.setFont(undefined, 'bold');
            doc.text("DITERIMA DARI:", 20, 100); 
            doc.setFont(undefined, 'normal');
            doc.text(nama.toUpperCase(), 20, 107); 
            
            doc.setFont(undefined, 'bold');
            doc.text("JENIS PEMBAYARAN:", 100, 100); 
            doc.setFont(undefined, 'normal');
            doc.text(`IURAN LATIHAN ${bulan.toUpperCase()}`, 100, 107); 
            
            doc.setFillColor(245, 245, 245);
            doc.rect(20, 125, 170, 30, 'F');
            doc.setFontSize(18);
            doc.setFont(undefined, 'bold');
            doc.text(`TOTAL: ${formatIDR(jumlah)}`, 105, 144, { align: 'center' }); 
            
            doc.setFontSize(10);
            doc.setFont(undefined, 'italic');
            doc.setTextColor(100, 100, 100);
            doc.text("Status: LUNAS - Terima kasih atas partisipasi Anda.", 105, 175, { align: 'center' }); 
            
            doc.save(`Kuitansi_${nama}_${bulan}.pdf`);
        }

        function exportExcel() {
            const worksheet = XLSX.utils.json_to_sheet(transactions);
            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, "Data Keuangan");
            XLSX.writeFile(workbook, `Laporan_Keuangan_${new Date().toISOString().split('T')[0]}.xlsx`);
        }

        function openModal(id) { 
            const m = document.getElementById(id);
            m.style.display = 'flex'; 
        }
        function closeModal(id) { document.getElementById(id).style.display = 'none'; }
        function toggleLoader(s) { document.getElementById('loader').style.display = s ? 'flex' : 'none'; }
        
        document.getElementById('darkToggle').onclick = () => {
            document.documentElement.classList.toggle('dark');
        };

        function logoutBendahara() {
            localStorage.removeItem('currentUserProfile');
            window.location.href = 'login.html';
        }
    </script>
</body>
</html>
