<!DOCTYPE html>
<html lang="id" class="scroll-smooth">
<head>
    <script>
    // SISTEM PROTEKSI HALAMAN
    (function() {
        const user = JSON.parse(localStorage.getItem('currentUserProfile'));
        
        // Cek: Apakah sudah login? Dan apakah redirecturl-nya adalah bendahara.html?
        if (!user || user.redirecturl !== 'bendahara.html') {
            alert("Silahkan Login Terlebih Dahulu.");
            window.location.href = 'login.html';
        }
    })();
    </script>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Brankas | PSNU PAGARNUSA UNUSIA</title>
    <link rel="icon" href="https://cdn3d.iconscout.com/3d/premium/thumb/privacy-3d-icon-png-download-8342338.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: { 
                extend: { 
                    colors: { 
                        primary: '#1B7548',
                        secondary: '#F59E0B',
                        danger: '#E11D48'
                    },
                    fontFamily: { sans: ['Plus Jakarta Sans', 'sans-serif'] }
                } 
            }
        }
    </script>

    <style type="text/css">
        body { font-family: 'Plus Jakarta Sans', sans-serif; }
        
        .sidebar-link.active { 
            background: #1B7548; 
            color: white !important; 
            box-shadow: 0 10px 20px -5px rgba(27, 117, 72, 0.4);
        }

        .glass-card { 
            background: rgba(255, 255, 255, 0.8); 
            backdrop-filter: blur(12px);
            border: 1px solid rgba(226, 232, 240, 0.7);
        }
        
        .dark .glass-card {
            background: rgba(30, 41, 59, 0.7);
            border: 1px solid rgba(51, 65, 85, 0.5);
        }

        .tab-content { display: none; }
        .tab-content.active { display: block; animation: fadeIn 0.5s ease; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        #loader { 
            display: none; 
            position: fixed; 
            inset: 0; 
            background: rgba(15, 23, 42, 0.8); 
            z-index: 9999; 
            backdrop-filter: blur(12px); 
        }

        input focus, select focus { ring: 2px; ring-color: #1B7548; outline: none; }
    </style>
</head>

<body class="bg-[#F8FAFC] dark:bg-slate-900 text-slate-800 dark:text-slate-100 min-h-screen transition-colors duration-300">
    
    <div id="loader" class="flex flex-col items-center justify-center">
        <div class="relative">
            <div class="w-20 h-20 border-4 border-primary/20 rounded-full"></div>
            <div class="w-20 h-20 border-4 border-primary border-t-transparent rounded-full animate-spin absolute top-0"></div>
        </div>
        <p class="mt-6 font-bold tracking-widest text-white animate-pulse">Memuat...</p>
    </div>

    <header class="sticky top-0 z-40 bg-white/70 dark:bg-slate-900/40 backdrop-blur-xl border-b border-white/20 dark:border-slate-800/50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 py-4 flex justify-between items-center">
            <div class="flex items-center space-x-3">
                <div class="bg-gradient-to-br from-primary to-emerald-700 p-2.5 rounded-2xl text-white shadow-lg shadow-primary/20">
                    <i class="fas fa-chart-line text-xl"></i>
                </div>
                <div>
                    <h1 class="text-xl font-extrabold tracking-tight">Database<span class="text-primary"> Keuangan</span></h1>
                    <p class="text-[10px] font-bold text-slate-400 uppercase tracking-[0.2em]">PSNU PAGARNUSA UNUSIA</p>
                </div>
            </div>

            <div class="flex items-center gap-3">
                <button onclick="initDashboard()" class="p-2.5 rounded-xl hover:bg-slate-100 dark:hover:bg-slate-800 transition-all text-slate-500" title="Refresh Data">
                    <i class="fas fa-sync-alt"></i>
                </button>
                <button id="darkToggle" class="p-2.5 rounded-xl bg-slate-100 dark:bg-slate-800 text-slate-600 dark:text-amber-400 transition-all">
                    <i class="fas fa-moon dark:hidden"></i>
                    <i class="fas fa-sun hidden dark:block"></i>
                </button>
                <button onclick="logoutBendahara()" class="flex items-center gap-3 px-6 py-3 text-red-500 font-bold hover:bg-red-50 rounded-xl transition-all">
                <i class="fas fa-power-off"></i>
                    <span>Logout</span>
                </button>
            </div>
        </div>
    </header>

    <div class="max-w-7xl mx-auto px-4 sm:px-6 py-8 grid grid-cols-1 lg:grid-cols-12 gap-8">
        
        <aside class="lg:col-span-3">
            <nav class="space-y-2 sticky top-28">
                <p class="text-[11px] font-bold text-slate-400 uppercase tracking-[0.2em] px-4 mb-4">Menu Utama</p>
                <button data-target="ringkasan" class="sidebar-link active w-full flex items-center gap-4 px-5 py-4 rounded-2xl transition-all font-semibold">
                    <i class="fas fa-home w-5"></i> Dashboard
                </button>
                <button data-target="transaksi" class="sidebar-link w-full flex items-center gap-4 px-5 py-4 rounded-2xl transition-all font-semibold text-slate-500 hover:bg-slate-100 dark:hover:bg-slate-800">
                    <i class="fas fa-book w-5"></i> Buku Kas Umum
                </button>
                <button data-target="iuran" class="sidebar-link w-full flex items-center gap-4 px-5 py-4 rounded-2xl transition-all font-semibold text-slate-500 hover:bg-slate-100 dark:hover:bg-slate-800">
                    <i class="fas fa-user-graduate w-5"></i> Iuran Santri
                </button>
                <button data-target="statistik" class="sidebar-link w-full flex items-center gap-4 px-5 py-4 rounded-2xl transition-all font-semibold text-slate-500 hover:bg-slate-100 dark:hover:bg-slate-800">
                    <i class="fas fa-chart-pie w-5"></i> Laporan Analitik
                </button>
                    <div class="pt-6 mt-6 border-t border-slate-200 dark:border-slate-800">
                    <button onclick="exportExcel()" class="w-full flex items-center gap-4 px-5 py-4 text-sm font-bold text-emerald-600 hover:bg-emerald-50 dark:hover:bg-emerald-900/20 rounded-2xl transition-all">
                        <i class="fas fa-file-excel w-5 text-lg"></i> Export
                    </button>

                </div>
            </nav>
        </aside>

        <main class="lg:col-span-9 space-y-8">
            
            <section id="ringkasan" class="tab-content active space-y-8">
                <div class="grid grid-cols-1 sm:grid-cols-3 gap-6">
                    <div class="glass-card p-7 rounded-[2rem] relative overflow-hidden group">
                        <div class="absolute -right-4 -top-4 w-24 h-24 bg-emerald-500/10 rounded-full group-hover:scale-150 transition-transform duration-700"></div>
                        <p class="text-xs font-bold text-slate-400 uppercase tracking-wider">Total Pemasukan</p>
                        <h2 id="totalMasuk" class="text-3xl font-extrabold mt-3 text-emerald-600">Rp 0</h2>
                        <div class="mt-4 flex items-center text-[11px] text-emerald-500 font-bold bg-emerald-50 dark:bg-emerald-900/20 w-fit px-3 py-1 rounded-full">
                            <i class="fas fa-arrow-trend-up mr-2"></i> Akumulasi Kas
                        </div>
                    </div>

                    <div class="glass-card p-7 rounded-[2rem] relative overflow-hidden group">
                        <div class="absolute -right-4 -top-4 w-24 h-24 bg-rose-500/10 rounded-full group-hover:scale-150 transition-transform duration-700"></div>
                        <p class="text-xs font-bold text-slate-400 uppercase tracking-wider">Total Pengeluaran</p>
                        <h2 id="totalKeluar" class="text-3xl font-extrabold mt-3 text-rose-600">Rp 0</h2>
                        <div class="mt-4 flex items-center text-[11px] text-rose-500 font-bold bg-rose-50 dark:bg-rose-900/20 w-fit px-3 py-1 rounded-full">
                            <i class="fas fa-arrow-trend-down mr-2"></i> Operasional
                        </div>
                    </div>

                    <div class="glass-card p-7 rounded-[2rem] bg-gradient-to-br from-primary to-emerald-800 text-white shadow-xl shadow-primary/20">
                        <p class="text-xs font-bold opacity-80 uppercase tracking-wider">TOTAL (Saat Ini)</p>
                        <h2 id="saldoAkhir" class="text-3xl font-extrabold mt-3">Rp 0</h2>
                        <div class="mt-4 h-1.5 w-full bg-white/20 rounded-full overflow-hidden">
                            <div class="h-full bg-secondary animate-pulse" style="width: 100%"></div>
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                    <div class="glass-card p-8 rounded-[2.5rem]">
                        <div class="flex justify-between items-center mb-8">
                            <h3 class="font-bold text-base tracking-tight"><i class="fas fa-history mr-3 text-primary"></i> Aktivitas Terbaru</h3>
                            <button data-target="transaksi" class="sidebar-link text-xs font-bold text-primary hover:underline">Lihat Semua</button>
                        </div>
                        <div id="recentList" class="space-y-5">
                            <p class="text-center text-slate-400 py-10">Belum ada aktivitas.</p>
                        </div>
                    </div>

                    <div class="glass-card p-10 rounded-[2.5rem] flex flex-col items-center justify-center text-center space-y-6 border-dashed border-2 border-primary/30 bg-primary/5">
                        <div class="w-20 h-20 bg-primary text-white rounded-3xl flex items-center justify-center text-3xl shadow-2xl shadow-primary/40 rotate-3">
                            <i class="fas fa-plus"></i>
                        </div>
                        <div>
                            <h4 class="font-extrabold text-xl">Input Data Cepat</h4>
                            <p class="text-sm text-slate-500 mt-2">Mencatat transaksi kas masuk atau keluar secara instan ke sistem cloud.</p>
                        </div>
                        <button onclick="openModal('modalTx')" class="w-full py-4 bg-primary text-white rounded-2xl font-bold shadow-lg shadow-primary/30 hover:bg-emerald-700 transition-all hover:-translate-y-1">
                            BUAT TRANSAKSI BARU
                        </button>
                    </div>
                </div>
            </section>

            <section id="transaksi" class="tab-content space-y-6">
                <div class="glass-card rounded-[2.5rem] overflow-hidden">
                    <div class="p-8 border-b border-slate-100 dark:border-slate-800 flex flex-col md:flex-row gap-6 justify-between items-center">
                        <div>
                            <h2 class="font-extrabold text-xl">Buku Kas Umum</h2>
                            <p class="text-xs text-slate-400 mt-1">Daftar keseluruhan aliran dana organisasi</p>
                        </div>
                        <div class="flex gap-3 w-full md:w-auto">
                            <div class="relative flex-1">
                                <i class="fas fa-search absolute left-4 top-1/2 -translate-y-1/2 text-slate-400"></i>
                                <input type="text" id="searchTx" onkeyup="filterTable('searchTx', 'txBody')" placeholder="Cari transaksi..." class="w-full md:w-64 pl-11 pr-4 py-3 rounded-2xl border dark:bg-slate-800 dark:border-slate-700 text-sm focus:ring-2 focus:ring-primary outline-none">
                            </div>
                            <button onclick="openModal('modalTx')" class="px-6 py-3 bg-primary text-white rounded-2xl text-sm font-bold shadow-lg hover:bg-emerald-700 transition-all shrink-0">
                                <i class="fas fa-plus mr-2"></i> TAMBAH
                            </button>
                        </div>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm">
                            <thead>
                                <tr>
                                    <th class="p-4 text-left">Tanggal</th>
                                    <th class="p-4 text-left">Nama Santri</th>
                                    <th class="p-4 text-left">Masuk/Keluar</th>
                                    <th class="p-4 text-right">Jumlah</th>
                                    <th class="p-4 text-center">Aksi</th> </tr>
                            </thead>
                            <tbody id="txBody" class="divide-y divide-slate-100 dark:divide-slate-800">
                                </tbody>
                        </table>
                    </div>
                </div>
            </section>

            <section id="iuran" class="tab-content space-y-6">
                <div class="glass-card rounded-[2.5rem] overflow-hidden">
                    <div class="p-8 bg-gradient-to-r from-emerald-600 to-teal-600 text-white flex flex-col md:flex-row justify-between items-center gap-6">
                        <div>
                            <h2 class="font-extrabold text-2xl">Manajemen Iuran</h2>
                            <p class="text-sm opacity-80 mt-1 uppercase tracking-widest font-medium">Pembayaran Iuran & Dana Infaq</p>
                        </div>
                        <button onclick="openModal('modalIuran')" class="px-8 py-4 bg-white text-emerald-600 rounded-2xl text-sm font-extrabold shadow-xl hover:scale-105 transition-all">
                            INPUT PEMBAYARAN BARU
                        </button>
                    </div>
                    <div class="p-6 border-b border-slate-100 dark:border-slate-800">
                        <div class="relative">
                            <i class="fas fa-filter absolute left-4 top-1/2 -translate-y-1/2 text-slate-400"></i>
                            <input type="text" id="searchIuran" onkeyup="filterTable('searchIuran', 'iuranBody')" placeholder="Cari Nama Santri atau Periode..." class="w-full pl-11 pr-6 py-4 rounded-2xl border dark:bg-slate-800 dark:border-slate-700 text-sm outline-none focus:ring-2 focus:ring-emerald-500">
                        </div>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm">
                            <thead>
                                <tr class="text-[11px] text-slate-400 uppercase tracking-widest bg-slate-50/50 dark:bg-slate-800/50">
                                    <th class="p-6 text-left">Tanggal</th>
                                    <th class="p-6 text-left">Nama Lengkap</th>
                                    <th class="p-6 text-left">Bulan / Periode</th>
                                    <th class="p-6 text-right">Jumlah</th>
                                    <th class="p-6 text-center">Aksi</th>
                                </tr>
                            </thead>
                            <tbody id="iuranBody" class="divide-y divide-slate-100 dark:divide-slate-800">
                                </tbody>
                        </table>
                    </div>
                </div>
            </section>

            <section id="statistik" class="tab-content space-y-8">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                    <div class="glass-card p-8 rounded-[2.5rem]">
                        <h3 class="font-bold text-sm mb-8 uppercase tracking-widest text-slate-400">Visualisasi Arus Kas</h3>
                        <div class="h-[300px]">
                            <canvas id="cashflowChart"></canvas>
                        </div>
                    </div>
                    <div class="glass-card p-8 rounded-[2.5rem]">
                        <h3 class="font-bold text-sm mb-8 uppercase tracking-widest text-slate-400">Distribusi Sumber Dana</h3>
                        <div class="h-[300px]">
                            <canvas id="pieChart"></canvas>
                        </div>
                    </div>
                </div>
            </section>

        </main>
    </div>

    <div id="modalTx" class="fixed inset-0 bg-slate-900/60 backdrop-blur-md z-[100] hidden items-center justify-center p-4">
        <div class="bg-white dark:bg-slate-800 w-full max-w-md rounded-[3rem] shadow-2xl overflow-hidden animate-fade">
            <div class="p-10 pb-6 flex justify-between items-center">
                <h3 class="text-2xl font-extrabold tracking-tight">Data Kas</h3>
                <button onclick="closeModal('modalTx')" class="w-12 h-12 rounded-2xl hover:bg-slate-100 dark:hover:bg-slate-700 flex items-center justify-center transition-all text-slate-400"><i class="fas fa-times"></i></button>
            </div>
            <form id="txForm" class="p-10 pt-2 space-y-5">
                <div class="space-y-2">
                    <label class="text-[11px] font-bold uppercase text-slate-400 ml-1">Keterangan / Keperluan</label>
                    <input type="text" id="txDesc" required placeholder="Contoh: Belanja ATK Kantor" class="w-full px-5 py-4 rounded-2xl border dark:bg-slate-900 dark:border-slate-700 text-sm focus:ring-2 focus:ring-primary outline-none">
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div class="space-y-2">
                        <label class="text-[11px] font-bold uppercase text-slate-400 ml-1">Jenis Kas</label>
                        <select id="txType" class="w-full px-5 py-4 rounded-2xl border dark:bg-slate-900 dark:border-slate-700 text-sm focus:ring-2 focus:ring-primary outline-none appearance-none">
                            <option value="Masuk">Pemasukan (+)</option>
                            <option value="Keluar">Pengeluaran (-)</option>
                        </select>
                    </div>
                    <div class="space-y-2">
                        <label class="text-[11px] font-bold uppercase text-slate-400 ml-1">Nominal (Rp)</label>
                        <input type="number" id="txAmount" required placeholder="0" class="w-full px-5 py-4 rounded-2xl border dark:bg-slate-900 dark:border-slate-700 text-sm focus:ring-2 focus:ring-primary outline-none">
                    </div>
                </div>
                <div class="space-y-2">
                    <label class="text-[11px] font-bold uppercase text-slate-400 ml-1">Tanggal Transaksi</label>
                    <input type="date" id="txDate" required class="w-full px-5 py-4 rounded-2xl border dark:bg-slate-900 dark:border-slate-700 text-sm focus:ring-2 focus:ring-primary outline-none">
                </div>
                <button type="submit" class="w-full py-5 bg-primary text-white rounded-[1.5rem] font-bold shadow-xl shadow-primary/30 mt-6 hover:bg-emerald-700 transition-all active:scale-95 uppercase tracking-widest text-xs">Simpan Transaksi</button>
            </form>
        </div>
    </div>

    <div id="modalIuran" class="fixed inset-0 bg-slate-900/60 backdrop-blur-md z-[100] hidden items-center justify-center p-4">
        <div class="bg-white dark:bg-slate-800 w-full max-w-md rounded-[3rem] shadow-2xl overflow-hidden animate-fade">
            <div class="p-10 pb-6 flex justify-between items-center border-b border-slate-50 dark:border-slate-700">
                <div>
                    <h3 class="text-2xl font-extrabold text-emerald-600 tracking-tight">Kuitansi Digital</h3>
                    <p class="text-[10px] text-slate-400 font-bold uppercase mt-1 tracking-widest">Penerimaan Dana Iuran</p>
                </div>
                <button onclick="closeModal('modalIuran')" class="w-12 h-12 rounded-2xl hover:bg-slate-100 flex items-center justify-center transition-all text-slate-400"><i class="fas fa-times"></i></button>
            </div>
            <form id="iuranForm" class="p-10 space-y-5">
                <div class="space-y-2">
                    <label class="text-[11px] font-bold uppercase text-slate-400 ml-1">Nama Lengkap Santri</label>
                    <input type="text" id="santriName" required placeholder="Masukkan Nama..." class="w-full px-5 py-4 rounded-2xl border dark:bg-slate-900 dark:border-slate-700 text-sm focus:ring-2 focus:ring-emerald-500 outline-none transition-all">
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div class="space-y-2">
                        <label class="text-[11px] font-bold uppercase text-slate-400 ml-1">Periode Bulan</label>
                        <select id="iuranMonth" class="w-full px-5 py-4 rounded-2xl border dark:bg-slate-900 dark:border-slate-700 text-sm outline-none">
                            <option>Januari</option><option>Februari</option><option>Maret</option><option>April</option><option>Mei</option><option>Juni</option><option>Juli</option><option>Agustus</option><option>September</option><option>Oktober</option><option>November</option><option>Desember</option>
                        </select>
                    </div>
                    <div class="space-y-2">
                        <label class="text-[11px] font-bold uppercase text-slate-400 ml-1">Nominal</label>
                        <input type="number" id="iuranAmount" required value="50000" class="w-full px-5 py-4 rounded-2xl border dark:bg-slate-900 dark:border-slate-700 text-sm outline-none">
                    </div>
                </div>
                <button type="submit" class="w-full py-5 bg-emerald-600 text-white rounded-[1.5rem] font-bold shadow-xl shadow-emerald-900/20 mt-6 hover:bg-emerald-700 transition-all uppercase tracking-widest text-xs">Konfirmasi & Simpan</button>
            </form>
        </div>
    </div>


    <script>
        /**
         * PENTING: GANTI DENGAN URL WEB APP GOOGLE APPS SCRIPT ANDA
         */
        const API_URL = "https://script.google.com/macros/s/AKfycbxNLsByaqUJMMEhNyGV9btVBHtDsGfGakQ197vUfw1uvWS-XGJEJLbx5URaKMCpslEI/exec"; 
        
        let transactions = [];
        let cashChart = null;
        let pChart = null;

        // --- Navigation Controller ---
        document.querySelectorAll('.sidebar-link').forEach(btn => {
            btn.addEventListener('click', () => {
                const target = btn.dataset.target;
                if(!target) return;

                // Update Sidebar
                document.querySelectorAll('.sidebar-link').forEach(l => {
                    l.classList.remove('active', 'text-white');
                    l.classList.add('text-slate-500');
                });
                btn.classList.add('active', 'text-white');
                btn.classList.remove('text-slate-500');

                // Update Tab Content
                document.querySelectorAll('.tab-content').forEach(s => s.classList.remove('active'));
                document.getElementById(target).classList.add('active');

                // Trigger Chart Refresh
                if(target === 'statistik') setTimeout(renderCharts, 100);
            });
        });

        // --- Initialize Dashboard ---
        window.onload = () => {
            initDashboard();
            // Set default date for input
            document.getElementById('txDate').valueAsDate = new Date();
        };

        async function initDashboard() {
            if (API_URL === "URL_WEB_APP_ANDA_DISINI") {
                console.warn("API URL belum diatur. Menampilkan data dummy untuk demo.");
                transactions = [
                    {tanggal: new Date(), keterangan: "Iuran: Ahmad Fauzi - Januari", tipe: "Masuk", jumlah: 50000},
                    {tanggal: new Date(), keterangan: "Pembelian Token Listrik", tipe: "Keluar", jumlah: 100000}
                ];
                updateUI();
                return;
            }

            toggleLoader(true);
            try {
                const res = await fetch(API_URL);
                const data = await res.json();
                transactions = Array.isArray(data) ? data : [];
                updateUI();
            } catch (e) {
                alert("Gagal terhubung ke Cloud. Pastikan API_URL benar.");
            } finally {
                toggleLoader(false);
            }
        }

        function updateUI() {
            renderSummary();
            renderTableGeneral();
            renderTableIuran();
            renderRecent();
        }

        // --- Renderers ---
        function renderSummary() {
            const masuk = transactions.filter(t => t.tipe === 'Masuk').reduce((s, t) => s + Number(t.jumlah), 0);
            const keluar = transactions.filter(t => t.tipe === 'Keluar').reduce((s, t) => s + Number(t.jumlah), 0);
            const saldo = masuk - keluar;

            document.getElementById('totalMasuk').innerText = formatIDR(masuk);
            document.getElementById('totalKeluar').innerText = formatIDR(keluar);
            document.getElementById('saldoAkhir').innerText = formatIDR(saldo);
        }

        function renderTableGeneral() {
            const body = document.getElementById('txBody');
            body.innerHTML = '';
            
            [...transactions].reverse().forEach((t, index) => {
                const isIuran = t.keterangan.includes('Iuran:');
                body.innerHTML += `
                    <tr class="hover:bg-slate-50 dark:hover:bg-slate-800/40 transition-colors group">
                        <td class="p-6 text-slate-500 font-medium">${formatDate(t.tanggal)}</td>
                        <td class="p-6">
                            <p class="font-bold text-slate-700 dark:text-slate-200">${t.keterangan}</p>
                            <span class="text-[10px] ${isIuran ? 'text-emerald-500' : 'text-slate-400'} font-bold uppercase tracking-tighter">
                                <i class="fas ${isIuran ? 'fa-tag' : 'fa-folder'} mr-1"></i> ${isIuran ? 'IURAN' : 'Kas Umum'}
                            </span>
                        </td>
                        <td class="p-6 text-center">
                            <span class="px-3 py-1.5 rounded-xl text-[10px] font-black tracking-widest ${t.tipe === 'Masuk' ? 'bg-emerald-100 text-emerald-600 dark:bg-emerald-900/30' : 'bg-rose-100 text-rose-600 dark:bg-rose-900/30'}">
                                ${t.tipe.toUpperCase()}
                            </span>
                        </td>
                        <td class="p-6 text-right font-extrabold text-base ${t.tipe === 'Masuk' ? 'text-emerald-600' : 'text-slate-700 dark:text-slate-200'}">
                            ${formatIDR(t.jumlah)}
                        </td>
                        <td class="p-6 text-center">
                            <button onclick="deleteTx('${t.keterangan}', ${t.jumlah})" class="w-10 h-10 rounded-xl text-slate-300 hover:text-rose-500 hover:bg-rose-50 dark:hover:bg-rose-900/20 transition-all">
                                <i class="fas fa-trash-alt"></i>
                            </button>
                        </td>
                    </tr>`;
            });
        }

function renderTableIuran() {
    const body = document.getElementById('iuranBody');
    body.innerHTML = '';
    
    transactions.filter(t => t.keterangan.startsWith('Iuran:')).reverse().forEach(t => {
        const parts = t.keterangan.replace('Iuran: ', '').split(' - ');
        const nama = parts[0] || 'Santri';
        const bulan = parts[1] || '-';

        body.innerHTML += `
            <tr class="hover:bg-emerald-50/30 dark:hover:bg-emerald-900/10 transition-all">
                <td class="p-6 text-slate-500">${formatDate(t.tanggal)}</td>
                <td class="p-6 font-bold text-slate-700 dark:text-slate-200">${nama}</td>
                <td class="p-6"><span class="px-3 py-1 bg-slate-100 dark:bg-slate-800 rounded-lg text-xs font-semibold">${bulan}</span></td>
                <td class="p-6 text-right font-black text-emerald-600">${formatIDR(t.jumlah)}</td>
                <td class="p-6">
                    <div class="flex items-center justify-center gap-2">
                        <button onclick="generatePDF('${nama}', '${bulan}', '${t.jumlah}')" class="w-8 h-8 bg-primary/10 text-primary rounded-lg hover:bg-primary hover:text-white transition-all" title="Cetak Kuitansi">
                            <i class="fas fa-file-invoice text-xs"></i>
                        </button>
                        <button onclick="editIuran('${t.keterangan}', ${t.jumlah}, '${t.tanggal}')" class="w-8 h-8 bg-amber-100 text-amber-600 rounded-lg hover:bg-amber-500 hover:text-white transition-all" title="Edit">
                            <i class="fas fa-edit text-xs"></i>
                        </button>
                        <button onclick="deleteTx('${t.keterangan}', ${t.jumlah})" class="w-8 h-8 bg-rose-100 text-rose-600 rounded-lg hover:bg-rose-500 hover:text-white transition-all" title="Hapus">
                            <i class="fas fa-trash text-xs"></i>
                        </button>
                    </div>
                </td>
            </tr>`;
    });
}
function editIuran(fullDesc, amount, date) {
    // Memecah kembali "Iuran: Nama - Bulan"
    const cleanDesc = fullDesc.replace('Iuran: ', '');
    const [nama, bulan] = cleanDesc.split(' - ');

    // Isi form modal iuran dengan data lama
    document.getElementById('santriName').value = nama;
    document.getElementById('iuranMonth').value = bulan;
    document.getElementById('iuranAmount').value = amount;

    // Tampilkan modal
    openModal('modalIuran');

    /** * Hapus data lama terlebih dahulu agar saat disimpan 
     * tidak duplikat (Logic: Delete then Re-add)
     */
    const confirmEdit = confirm("Apakah Anda Yakin Ingin Mengedit Data Ini?");
    if (confirmEdit) {
        deleteTx(fullDesc, amount);
    } else {
        closeModal('modalIuran');
    }
}

        function renderRecent() {
            const container = document.getElementById('recentList');
            const recent = transactions.slice(-5).reverse();
            
            if(recent.length === 0) return;
            container.innerHTML = '';
            
            recent.forEach(t => {
                const isMasuk = t.tipe === 'Masuk';
                container.innerHTML += `
                    <div class="flex items-center justify-between p-4 rounded-2xl bg-slate-50 dark:bg-slate-900/40 border border-slate-100 dark:border-slate-800">
                        <div class="flex items-center gap-4">
                            <div class="w-12 h-12 rounded-2xl flex items-center justify-center ${isMasuk ? 'bg-emerald-500' : 'bg-rose-500'} text-white shadow-lg">
                                <i class="fas ${isMasuk ? 'fa-arrow-down-long' : 'fa-arrow-up-long'}"></i>
                            </div>
                            <div>
                                <p class="text-sm font-bold truncate w-32 sm:w-48">${t.keterangan}</p>
                                <p class="text-[10px] text-slate-400 font-medium">${formatDate(t.tanggal)}</p>
                            </div>
                        </div>
                        <p class="font-extrabold text-sm ${isMasuk ? 'text-emerald-500' : 'text-rose-500'}">
                            ${isMasuk ? '+' : '-'} ${formatIDR(t.jumlah)}
                        </p>
                    </div>`;
            });
        }

        // --- Logic: Save Data ---
        document.getElementById('txForm').onsubmit = (e) => {
            e.preventDefault();
            const payload = {
                date: document.getElementById('txDate').value,
                desc: document.getElementById('txDesc').value,
                type: document.getElementById('txType').value,
                amount: parseInt(document.getElementById('txAmount').value)
            };
            saveToCloud(payload, 'modalTx');
        };

        document.getElementById('iuranForm').onsubmit = (e) => {
            e.preventDefault();
            const payload = {
                date: new Date().toISOString().split('T')[0],
                desc: `Iuran: ${document.getElementById('santriName').value} - ${document.getElementById('iuranMonth').value}`,
                type: 'Masuk',
                amount: parseInt(document.getElementById('iuranAmount').value)
            };
            saveToCloud(payload, 'modalIuran');
        };

        async function saveToCloud(payload, modalId) {
            if (API_URL.includes("URL_WEB_APP")) {
                alert("Simpan gagal: API URL belum dikonfigurasi.");
                return;
            }

            toggleLoader(true);
            try {
                await fetch(API_URL, { method: 'POST', body: JSON.stringify(payload) });
                await initDashboard();
                closeModal(modalId);
                document.querySelector(`#${modalId} form`).reset();
            } catch (e) {
                alert("Terjadi kesalahan sistem.");
            } finally {
                toggleLoader(false);
            }
        }

        async function deleteTx(desc, amount) {
            if(!confirm("Apakah Anda Yakin Ingin Menghapus Data ini?")) return;
            toggleLoader(true);
            try {
                await fetch(API_URL, { method: 'POST', body: JSON.stringify({action: 'delete', desc, amount}) });
                await initDashboard();
            } catch (e) { alert("Gagal menghapus."); }
            finally { toggleLoader(false); }
        }

        // --- Helper: Visual & Format ---
        function formatIDR(num) {
            return new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', maximumFractionDigits: 0 }).format(num);
        }

        function formatDate(dateStr) {
            return new Date(dateStr).toLocaleDateString('id-ID', { day: '2-digit', month: 'short', year: 'numeric' });
        }

        function filterTable(inputId, tableId) {
            const val = document.getElementById(inputId).value.toLowerCase();
            document.querySelectorAll(`#${tableId} tr`).forEach(tr => {
                tr.style.display = tr.innerText.toLowerCase().includes(val) ? '' : 'none';
            });
        }

        function renderCharts() {
            const ctx1 = document.getElementById('cashflowChart').getContext('2d');
            const ctx2 = document.getElementById('pieChart').getContext('2d');
            
            if(cashChart) cashChart.destroy();
            if(pChart) pChart.destroy();

            const last7 = transactions.slice(-7);
            cashChart = new Chart(ctx1, {
                type: 'line',
                data: {
                    labels: last7.map(t => formatDate(t.tanggal)),
                    datasets: [{
                        label: 'Nilai Transaksi',
                        data: last7.map(t => t.tipe === 'Masuk' ? t.jumlah : -t.jumlah),
                        borderColor: '#1B7548',
                        backgroundColor: 'rgba(27, 117, 72, 0.1)',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
            });

            const iuranCount = transactions.filter(t => t.keterangan.startsWith('Iuran:')).length;
            pChart = new Chart(ctx2, {
                type: 'doughnut',
                data: {
                    labels: ['Iuran Santri', 'Kas Umum'],
                    datasets: [{
                        data: [iuranCount, transactions.length - iuranCount],
                        backgroundColor: ['#10b981', '#6366f1'],
                        borderWidth: 0
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false, cutout: '70%' }
            });
        }

        async function generatePDF(nama, bulan, jumlah) {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            // 1. Logika Nomor Urut Berdasarkan Jumlah Transaksi
            // Mengambil semua transaksi iuran dan menambah 1 untuk urutan berikutnya
            const totalIuran = transactions.filter(t => t.keterangan.startsWith('Iuran:')).length;
            const nomorUrut = String(totalIuran + 1).padStart(3, '0');
            const noReferensi = `K-ISPSNUPN/27091985${nomorUrut}`;

            const logoUrl = "logopn.png"; 

            // Header Background: Hijau Pagar Nusa
            doc.setFillColor(27, 117, 72);
            doc.rect(0, 0, 210, 55, 'F'); // Tinggi disesuaikan untuk logo rata tengah

            try {
                const img = new Image();
                img.src = logoUrl;
                
                await new Promise((resolve, reject) => {
                    img.onload = resolve;
                    img.onerror = () => reject(new Error("File logopn.png tidak ditemukan"));
                });
                
                // Logo Rata Tengah
                doc.addImage(img, 'PNG', 92.5, 5, 25, 25);
            } catch (e) {
                console.warn("Logo tidak muncul:", e.message);
            }
            
            // Judul Rata Tengah [cite: 1, 2]
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(20);
            doc.setFont(undefined, 'bold');
            doc.text("KUITANSI PEMBAYARAN", 105, 42, { align: 'center' }); 
            
            // Info Referensi Custom & Tanggal [cite: 3]
            doc.setTextColor(40, 40, 40);
            doc.setFontSize(10);
            doc.setFont(undefined, 'normal');
            doc.text(`No. Referensi: ${noReferensi}`, 20, 70); 
            doc.text(`Tanggal Cetak: ${new Date().toLocaleString('id-ID')}`, 20, 77); 
            
            doc.setDrawColor(200, 200, 200);
            doc.line(20, 85, 190, 85);
            
            // Detail Pembayar [cite: 4]
            doc.setFontSize(12);
            doc.setFont(undefined, 'bold');
            doc.text("DITERIMA DARI:", 20, 100); 
            doc.setFont(undefined, 'normal');
            doc.text(nama.toUpperCase(), 20, 107); 
            
            // Detail Peruntukan [cite: 5]
            doc.setFont(undefined, 'bold');
            doc.text("JENIS PEMBAYARAN:", 100, 100); 
            doc.setFont(undefined, 'normal');
            doc.text(`IURAN LATIHAN ${bulan.toUpperCase()}`, 100, 107); 
            
            // Kotak Total [cite: 6]
            doc.setFillColor(245, 245, 245);
            doc.rect(20, 125, 170, 25, 'F');
            doc.setFontSize(16);
            doc.setFont(undefined, 'bold');
            doc.text(`TOTAL: ${formatIDR(jumlah)}`, 105, 141, { align: 'center' }); 
            
            // Footer [cite: 7]
            doc.setFontSize(10);
            doc.setFont(undefined, 'italic');
            doc.setTextColor(100, 100, 100);
            doc.text("Status: LUNAS - Terima kasih atas partisipasi Anda.", 105, 165, { align: 'center' }); 
            
            doc.save(`Kuitansi_${nama}_${bulan}.pdf`);
        }

        function exportExcel() {
            const worksheet = XLSX.utils.json_to_sheet(transactions);
            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, "Data Keuangan");
            XLSX.writeFile(workbook, `Laporan_Keuangan_${new Date().toISOString().split('T')[0]}.xlsx`);
        }

        function openModal(id) { 
            const m = document.getElementById(id);
            m.style.display = 'flex'; 
        }
        function closeModal(id) { document.getElementById(id).style.display = 'none'; }
        function toggleLoader(s) { document.getElementById('loader').style.display = s ? 'flex' : 'none'; }
        
        document.getElementById('darkToggle').onclick = () => {
            document.documentElement.classList.toggle('dark');
        };
        function logoutBendahara() {
    // Hapus data login dari browser
    localStorage.removeItem('currentUserProfile');
    // Arahkan kembali ke login
    window.location.href = 'login.html';
}
    </script>
</body>

</html>



