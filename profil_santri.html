<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>PROFIL SANTRI | PAGAR NUSA UNUSIA</title>
    <link rel="icon" href="logopn.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: { pnGreen: '#1B7548', pnDark: '#0b3d26', pnLight: '#f1f5f9' },
                    borderRadius: { 'xl': '1rem', '2xl': '1.5rem', '3xl': '2rem' },
                    animation: { 'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite' }
                }
            }
        }
    </script>
<style>
    /* Google Fonts */
    @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap');

    body {
        font-family: 'Plus Jakarta Sans', sans-serif;
        background: #f8fafc;
        color: #1e293b;
        -webkit-tap-highlight-color: transparent;
    }
    @keyframes shimmer {
            100% { transform: translateX(100%); }
        }

    /* Glassmorphism Effect */
    .glass-card {
        background: rgba(255, 255, 255, 0.9);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.2);
        box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.07);
    }

    /* Custom Scrollbar */
    ::-webkit-scrollbar { width: 5px; }
    ::-webkit-scrollbar-track { background: #f1f1f1; }
    ::-webkit-scrollbar-thumb { background: #1B7548; border-radius: 10px; }

    /* Animated Button */
    .btn-primary {
        background: linear-gradient(135deg, #1B7548 0%, #145c38 100%);
        transition: all 0.3s ease;
    }
    .btn-primary:active { transform: scale(0.95); }

    /* Bottom Nav Shadow */
    .nav-shadow { box-shadow: 0 -4px 20px rgba(0,0,0,0.05); }

    /* Avatar Glow */
    .avatar-container {
        position: relative;
        padding: 4px;
        background: linear-gradient(135deg, #1B7548, #fbbf24);
        border-radius: 50%;
    }
</style>
</head>
<body class="min-h-screen pb-24 md:pb-0 text-slate-900">
    <div class="flex flex-col md:flex-row min-h-screen">
        
        <aside class="no-print fixed bottom-0 left-0 w-full z-40 glass-nav border-t border-slate-200 md:static md:w-80 md:h-screen md:border-r md:p-8 md:space-y-8 shadow-2xl md:shadow-none">
            <div class="hidden md:flex items-center gap-4 px-2 mb-10">
                <div class="p-3 bg-pnGreen/10 rounded-2xl">
                    <img src="logopn.png" alt="Logo" class="h-12 w-12 object-contain">
                </div>
                <div>
                    <h2 class="font-black text-pnDark leading-none text-2xl tracking-tighter ">SANTRI <span class="text-pnGreen"></span></h2>
                    <p class="text-[10px] font-bold text-slate-400 tracking-[0.1em] uppercase">PSNU PAGARNUSA UNUSIA</p>
                </div>
            </div>

            <nav class="flex justify-around items-center md:block md:space-y-3 px-2 py-4 md:py-0">
                <p class="hidden md:block text-[10px] font-black text-slate-400 uppercase tracking-[0.2em] mb-4 px-4">Dashboard Menu</p>
                
                <a href="#" class="sidebar-active flex flex-col md:flex-row items-center gap-1 md:gap-4 px-4 py-3 md:rounded-2xl font-black text-[10px] md:text-sm transition-all group">
                    <i class="fas fa-grid-2 text-xl md:text-lg"></i> 
                    <span>Profil Saya</span>
                </a>

                <a href="#" id="menuMateri" onclick="aksesMateri(event)" class="flex flex-col md:flex-row items-center gap-1 md:gap-4 px-4 py-3 text-slate-400 md:rounded-2xl font-bold text-[10px] md:text-sm transition-all cursor-not-allowed opacity-50 relative group">
                    <i class="fas fa-book-open text-xl md:text-lg"></i>
                    <span>Materi Silat</span>
                    <i id="lockIconDesktop" class="fas fa-lock text-[10px] ml-auto hidden md:block opacity-50"></i>
                </a>
                
                <a href="#" onclick="openModal()" class="flex flex-col md:flex-row items-center gap-1 md:gap-4 px-4 py-3 text-emerald-600 hover:bg-emerald-50 md:rounded-2xl font-black text-[10px] md:text-sm transition-all">
                    <i class="fas fa-wallet text-xl md:text-lg"></i> <span>Bayar Iuran</span>
                </a>
                
                <a href="#" onclick="window.print()" class="flex flex-col md:flex-row items-center gap-1 md:gap-4 px-4 py-3 text-slate-500 hover:bg-slate-50 md:rounded-2xl font-bold text-[10px] md:text-sm transition-all">
                    <i class="fas fa-print text-xl md:text-lg"></i> <span>Cetak KHI</span>
                </a>
                
                <button onclick="logout()" class="flex flex-col md:flex-row items-center gap-1 md:gap-4 px-4 py-3 text-red-500 hover:bg-red-50 md:rounded-2xl font-bold text-[10px] md:text-sm md:mt-20 transition-all w-full text-left">
                    <i class="fas fa-power-off text-xl md:text-lg"></i> <span>Keluar Akun</span>
                </button>
            </nav>
        </aside>

        <main class="flex-1 p-5 md:p-14 space-y-10 max-w-7xl mx-auto w-full">
            
            <header class="flex flex-col md:flex-row md:items-center justify-between gap-8">
                <div class="space-y-2">
                    <div class="flex items-center gap-3 mb-1">
                        <span class="h-1.5 w-10 bg-pnGreen rounded-full"></span>
                        <p class="text-[10px] font-black text-pnGreen uppercase tracking-[0.3em]">Portal Digital Santri</p>
                    </div>
                    <h1 class="text-4xl md:text-5xl font-black text-slate-900 tracking-tighter">PSNU PAGARNUSA <span class="text-pnGreen">UNUSIA</span></h1>
                    <p id="dateNow" class="text-xs text-slate-400 font-bold tracking-wide uppercase"></p>
                </div>
                
                <div class="flex items-center gap-4">
                    <button onclick="openModal()" class="hidden md:flex bg-pnDark hover:bg-black text-white px-10 py-5 rounded-[2rem] font-black text-xs shadow-2xl shadow-emerald-200 transition-all hover:-translate-y-1 active:scale-95 items-center gap-4">
                        <i class="fas fa-plus-circle text-lg"></i> BAYAR IURAN KAS
                    </button>

                    <div class="flex items-center gap-4 bg-white p-2.5 pr-8 rounded-[2rem] shadow-xl border border-slate-100">
                        <div id="avatarSmall" class="w-14 h-14 bg-gradient-to-br from-pnGreen to-pnDark text-white rounded-2xl flex items-center justify-center font-black text-xl shadow-inner border-4 border-white">..</div>
                        <div class="hidden sm:block">
                            <p id="userSmall" class="text-sm font-black text-slate-800 italic truncate max-w-[150px]">Memuat...</p>
                            <span class="inline-flex items-center gap-2 text-[9px] text-emerald-600 font-black uppercase tracking-widest mt-1">
                                <span class="w-2 h-2 bg-emerald-500 rounded-full animate-ping"></span> Terverifikasi
                            </span>
                        </div>
                    </div>
                </div>
            </header>

            <div class="grid grid-cols-1 sm:grid-cols-3 gap-8">
                <div class="bg-white p-10 rounded-[3rem] card-modern shadow-xl shadow-slate-200/40 relative overflow-hidden group">
                    <div class="relative z-10">
                        <p class="text-[10px] font-black text-slate-400 tracking-widest mb-3">Persentase Pembayaran</p>
                        <h3 id="scoreIuran" class="text-5xl font-black text-pnDark tracking-tighter">0%</h3>
                        <div class="w-full bg-slate-100 h-4 rounded-full mt-6 overflow-hidden p-1 border border-slate-200/50">
                            <div id="progressBar" class="bg-gradient-to-r from-emerald-500 to-pnGreen h-full rounded-full transition-all duration-1000 shadow-sm" style="width: 0%"></div>
                        </div>
                    </div>
                    <i class="fas fa-bolt-lightning absolute -right-6 -bottom-6 text-slate-50 text-8xl rotate-12 group-hover:rotate-0 transition-all duration-700"></i>
                </div>

                <div class="bg-white p-10 rounded-[3rem] card-modern shadow-xl shadow-slate-200/40 relative overflow-hidden group">
                    <div class="relative z-10">
                        <p class="text-[10px] font-black text-slate-400 tracking-widest mb-3 text-pnGreen">Total Kas Saya</p>
                        <h3 id="totalBayar" class="text-5xl font-black text-pnDark leading-none tracking-tighter">Rp 0</h3>
                        <p class="text-[10px] text-slate-400 mt-4 font-black tracking-widest">Saldo Terverifikasi</p>
                    </div>
                    <i class="fas fa-shield-check absolute -right-6 -bottom-6 text-pnGreen/[0.03] text-9xl"></i>
                </div>

                <div class="bg-pnDark p-10 rounded-[3rem] shadow-[0_20px_50px_rgba(11,61,38,0.25)] text-white relative overflow-hidden group hover:scale-[1.03] transition-all duration-500 cursor-default">
                    <div class="relative z-10">
                        <p class="text-[10px] font-black text-emerald-200/60 tracking-[0.1em] mb-3">Tagihan Bulan Ini</p>
                        <h3 id="currentMonthPay" class="text-5xl font-black tracking-tighter">Rp 0</h3>
                        <div class="mt-4 flex items-center gap-2">
                            <span id="currentMonthName" class="px-5 py-1.5 bg-white/10 rounded-full text-[10px] font-black uppercase tracking-widest border border-white/10">---</span>
                        </div>
                    </div>
                    <div class="absolute -right-8 -bottom-8 bg-white/5 w-40 h-40 rounded-full blur-3xl"></div>
                    <i class="fas fa-receipt absolute -right-4 -bottom-4 text-white/10 text-9xl rotate-12"></i>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-12 gap-10">
                <div class="lg:col-span-4">
                    <div class="bg-white rounded-[3.5rem] p-10 border border-slate-100 shadow-2xl relative overflow-hidden">
                        <div class="relative z-10 text-center">
                            <div id="avatarLarge" class="w-36 h-36 bg-slate-50 text-pnGreen rounded-[2.5rem] mx-auto mb-8 flex items-center justify-center text-5xl font-black uppercase border-8 border-white shadow-2xl shadow-emerald-100">..</div>
                            <h4 id="disp-nama" class="font-black text-slate-900 uppercase tracking-tight text-xl mb-2">---</h4>
                            <div class="inline-block px-6 py-2 bg-pnGreen text-white rounded-full shadow-lg shadow-emerald-100">
                                <p id="disp-angkatan" class="text-[10px] font-black tracking-widest">Angkatan ---</p>
                            </div>
                            
                            <div class="space-y-6 text-left mt-10 pt-10 border-t-2 border-dashed border-slate-100">
                                <div class="flex items-center gap-5">
                                    <div class="w-12 h-12 bg-slate-50 rounded-2xl flex items-center justify-center text-pnGreen shadow-sm"><i class="fas fa-envelope"></i></div>
                                    <div class="flex-1 overflow-hidden">
                                        <p class="text-[9px] font-black text-slate-400 tracking-widest mb-1">Email Resmi</p>
                                        <p id="disp-email" class="text-sm font-bold text-slate-700 truncate">---</p>
                                    </div>
                                </div>
                                <div class="flex items-center gap-5">
                                    <div class="w-12 h-12 bg-slate-50 rounded-2xl flex items-center justify-center text-pnGreen shadow-sm"><i class="fab fa-whatsapp"></i></div>
                                    <div>
                                        <p class="text-[9px] font-black text-slate-400 tracking-widest mb-1">WhatsApp</p>
                                        <p id="disp-wa" class="text-sm font-bold text-slate-700 tracking-tighter">---</p>
                                    </div>
                                </div>
                                <div class="flex items-center gap-5">
                                    <div class="w-12 h-12 bg-slate-50 rounded-2xl flex items-center justify-center text-pnGreen shadow-sm"><i class="fas fa-map-pin"></i></div>
                                    <div>
                                        <p class="text-[9px] font-black text-slate-400 tracking-widest mb-1">Tempat Tanggal Lahir</p>
                                        <p id="disp-ttl" class="text-sm font-bold text-slate-700">---</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="lg:col-span-8 space-y-10">
                    <div class="bg-white rounded-[3.5rem] p-10 border border-slate-100 shadow-2xl">
                        <div class="flex flex-col sm:flex-row sm:items-center justify-between gap-4 mb-10">
                            <h3 class="font-black text-slate-900 uppercase tracking-tighter text-2xl flex items-center gap-4">
                                <span class="w-3 h-10 bg-pnGreen rounded-full shadow-lg shadow-emerald-200"></span> Kartu Hasil Iuran
                            </h3>
                            <div class="flex items-center gap-2 px-6 py-2 bg-slate-50 rounded-2xl border border-slate-200">
                                <i class="fas fa-calendar-alt text-pnGreen text-xs"></i>
                                <span class="text-[10px] font-black text-slate-600 uppercase tracking-widest">Periode 2026</span>
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-5" id="khiGrid">
                            </div>

                        <div class="mt-14 space-y-6">
                            <h3 class="font-black text-slate-900 uppercase tracking-widest text-xs italic flex items-center gap-3 opacity-30">
                                <i class="fas fa-history"></i> Riwayat Transaksi
                            </h3>
                            <div class="overflow-hidden rounded-[2.5rem] border border-slate-100 shadow-inner bg-slate-50/50">
                                <div class="overflow-x-auto">
                                    <table class="w-full text-left text-xs border-collapse">
                                        <thead>
                                            <tr class="text-slate-400 font-black uppercase tracking-[0.2em] border-b border-slate-100">
                                                <th class="p-6">Bulan</th>
                                                <th class="p-6 text-center">Tanggal</th>
                                                <th class="p-6 text-center">Bukti</th>
                                                <th class="p-6 text-center">Status</th>
                                                <th class="p-6 text-right">Nominal</th>
                                            </tr>
                                        </thead>
                                        <tbody id="riwayatBody" class="font-bold text-slate-700 italic bg-white/50">
                                            </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <div id="paymentModal" class="fixed inset-0 bg-slate-900/90 backdrop-blur-xl hidden z-50 flex items-end md:items-center justify-center p-0 md:p-8 transition-all duration-500">
        <div class="bg-white rounded-t-[4rem] md:rounded-[4rem] w-full max-w-2xl overflow-hidden shadow-[0_0_100px_rgba(0,0,0,0.5)] transform transition-all translate-y-full md:translate-y-0 md:scale-95 border-t md:border border-white/20" id="modalContent">
            
            <div class="bg-pnDark p-10 text-white flex justify-between items-start relative overflow-hidden">
                <div class="relative z-10 flex items-center gap-6">
                    <div class="w-16 h-16 bg-white/10 rounded-3xl flex items-center justify-center backdrop-blur-md border border-white/10">
                        <i class="fas fa-paper-plane text-3xl text-emerald-400"></i>
                    </div>
                    <div>
                        <h3 class="font-black italic uppercase tracking-tighter text-3xl leading-none">Konfirmasi</h3>
                        <p class="text-[10px] text-emerald-400 font-black tracking-[0.3em] uppercase mt-2 opacity-80">Pembayaran Iuran Kas Santri</p>
                    </div>
                </div>
                <button onclick="closeModal()" class="relative z-10 w-12 h-12 flex items-center justify-center rounded-2xl bg-white/5 hover:bg-white/10 transition-all border border-white/5"><i class="fas fa-times text-2xl"></i></button>
                <div class="absolute -right-10 -bottom-10 bg-pnGreen/20 w-64 h-64 rounded-full blur-3xl"></div>
            </div>
            
            <form id="payForm" class="p-8 md:p-12 space-y-8 max-h-[75vh] overflow-y-auto no-scrollbar bg-white">
                
                <div class="bg-slate-50 border-2 border-slate-100 rounded-[3rem] p-8 space-y-6">
                    <p class="text-[10px] font-black text-slate-400 uppercase tracking-[0.3em] text-center">Metode Transfer Rekomendasi</p>
                    <div class="flex items-center justify-between bg-white p-6 rounded-[2rem] border border-slate-200 shadow-sm group hover:border-pnGreen transition-all">
                        <div class="flex items-center gap-5">
                            <div class="h-14 w-14 bg-[#118EEA] rounded-2xl flex items-center justify-center shadow-2xl shadow-blue-200">
                                <img src="https://1000logos.net/wp-content/uploads/2021/03/Dana-logo.jpg" class="h-5 grayscale brightness-[10]" alt="DANA">
                            </div>
                            <div>
                                <p class="text-lg font-black text-slate-800 tracking-tighter italic">081366203248</p>
                                <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest mt-1">Syifa Ulya Setiawan</p>
                            </div>
                        </div>
                        <button type="button" onclick="navigator.clipboard.writeText('081366203248'); Swal.fire('Tersalin!', 'Nomor Dana berhasil disalin ke papan klip.', 'success')" class="px-6 py-3 bg-slate-100 hover:bg-pnDark hover:text-white rounded-2xl text-[10px] font-black uppercase transition-all shadow-sm">Salin</button>
                    </div>
                        <a href="https://link.dana.id/minta?full_url=https://qr.dana.id/v1/281012092026012507613151" 
                        target="_blank" 
                        class="flex items-center justify-center gap-4 w-full bg-gradient-to-br from-blue-600 to-blue-400 hover:from-blue-500 hover:to-blue-300 text-white py-6 rounded-[2rem] text-[11px] font-black shadow-xl shadow-blue-200/50 transition-all active:scale-95 uppercase italic tracking-[0.2em] relative overflow-hidden group">
                            
                            <div class="absolute inset-0 w-full h-full bg-gradient-to-r from-transparent via-white/20 to-transparent -translate-x-full group-hover:animate-[shimmer_1.5s_infinite]"></div>
                            
                            <i class="fas fa-bolt text-lg animate-pulse"></i> 
                            <span class="relative z-10">Kirim Langsung (DANA)</span>
                        </a>
                </div>

                <div class="grid grid-cols-1 sm:grid-cols-2 gap-6">
                    <div>
                        <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest block mb-3 px-2">Periode Iuran</label>
                        <div class="relative">
                            <select id="payBulan" required class="w-full bg-slate-50 border-2 border-slate-100 rounded-[1.5rem] px-6 py-5 text-sm font-black outline-none focus:border-pnGreen transition-all appearance-none cursor-pointer italic shadow-sm"></select>
                            <i class="fas fa-chevron-down absolute right-6 top-1/2 -translate-y-1/2 text-slate-300 pointer-events-none"></i>
                        </div>
                    </div>
                    <div>
                        <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest block mb-3 px-2">Besaran (IDR)</label>
                        <input type="number" id="payNominal" required value="3000" class="w-full bg-slate-50 border-2 border-slate-100 rounded-[1.5rem] px-6 py-5 text-sm font-black outline-none focus:border-pnGreen transition-all italic shadow-sm">
                    </div>
                </div>

                <div>
                    <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest block mb-3 px-2">Bukti Transaksi (Wajib JPG/PNG)</label>
                    <div class="relative">
                        <input type="file" id="payBukti" accept="image/*" required class="hidden" onchange="previewImage(this)">
                        <label for="payBukti" class="flex flex-col items-center justify-center w-full h-44 border-2 border-dashed border-slate-200 rounded-[3rem] cursor-pointer bg-slate-50 hover:bg-emerald-50 hover:border-pnGreen transition-all group overflow-hidden shadow-sm">
                            <div id="previewContainer" class="flex flex-col items-center justify-center text-center p-6">
                                <div class="w-14 h-14 bg-white rounded-2xl flex items-center justify-center shadow-xl mb-4 group-hover:scale-110 transition-transform">
                                    <i class="fas fa-cloud-upload-alt text-2xl text-slate-300 group-hover:text-pnGreen"></i>
                                </div>
                                <p class="text-[10px] font-black text-slate-400 uppercase tracking-[0.2em]">Klik untuk Pilih Berkas</p>
                                <p class="text-[9px] text-slate-300 mt-2 font-bold uppercase tracking-tighter italic">Maksimal Ukuran 2MB</p>
                            </div>
                            <img id="imgPreview" class="hidden h-full w-full object-cover">
                        </label>
                    </div>
                </div>
                
                <div class="p-6 bg-amber-50 rounded-[2rem] border-2 border-amber-100/50 flex items-start gap-4">
                    <div class="w-8 h-8 bg-amber-100 rounded-full flex items-center justify-center shrink-0"><i class="fas fa-info text-amber-600 text-[10px]"></i></div>
                    <p class="text-[10px] text-amber-900 font-bold uppercase leading-relaxed italic opacity-80">
                        Pastikan nominal dan bukti sudah sesuai. Kesalahan input dapat menghambat proses verifikasi administrasi oleh pengurus.
                    </p>
                </div>

                <button type="submit" id="btnSubmitPay" class="w-full bg-pnDark text-white font-black py-7 rounded-[2rem] shadow-[0_20px_40px_rgba(11,61,38,0.2)] hover:bg-black transition-all uppercase tracking-[0.3em] text-xs flex items-center justify-center gap-4 active:scale-95 shadow-inner italic border-t border-white/10">
                    <i class="fab fa-whatsapp text-2xl"></i> Kirim Konfirmasi WhatsApp
                </button>
            </form>
        </div>
    </div>
<script>
    // --- KONFIGURASI GLOBAL ---
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzkOhlAKxKqRJWYgZ5ajptbx1J0QstJ4jdFcJEbcrA2lTdwgEZ63JTuBC8GHNP1nZkcyQ/exec";
    const NOMOR_BENDAHARA = "6281366203248"; 
    const TARGET_IURAN = 20000; // Target minimal per bulan untuk dianggap Lunas
    const daftarBulan = ["Januari", "Februari", "Maret", "April", "Mei", "Juni", "Juli", "Agustus", "September", "Oktober", "November", "Desember"];
    
    let isLunasBulanIni = false;
    let currentIuranData = []; 

    // --- INISIALISASI HALAMAN ---
    window.onload = async () => {
        const elDate = document.getElementById('dateNow');
        if(elDate) elDate.innerText = new Date().toLocaleDateString('id-ID', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });

        const session = JSON.parse(localStorage.getItem('currentUserProfile'));
        if (!session || !session.nama) { 
            window.location.href = "login.html"; 
            return; 
        }

        const payBulanSelect = document.getElementById('payBulan');
        if (payBulanSelect) {
            payBulanSelect.innerHTML = '';
            daftarBulan.forEach((b, index) => {
                const opt = document.createElement('option');
                opt.value = b;
                opt.innerText = b;
                if(index === new Date().getMonth()) opt.selected = true;
                payBulanSelect.appendChild(opt);
            });
        }

        await fetchData();
    };

    // --- LOGIKA AMBIL DATA ---
    async function fetchData() {
        try {
            const session = JSON.parse(localStorage.getItem('currentUserProfile'));
            const response = await fetch(`${SCRIPT_URL}?action=read`);
            const result = await response.json();

            const profil = result.santri.find(s => s.nama.trim().toLowerCase() === session.nama.trim().toLowerCase());
            currentIuranData = result.iuran.filter(i => i.nama.trim().toLowerCase() === session.nama.trim().toLowerCase());

            renderUI(profil, currentIuranData, session.nama);

        } catch (err) {
            console.error("Fetch Error:", err);
            alert("Gagal memuat data. Periksa koneksi internet Anda.");
        }
    }

    // --- RENDER SEMUA KOMPONEN UI ---
    function renderUI(profil, iuran, namaAsli) {
        const initials = namaAsli.substring(0, 2).toUpperCase();
        document.getElementById('userSmall').innerText = namaAsli;
        document.getElementById('avatarSmall').innerText = initials;
        document.getElementById('avatarLarge').innerText = initials;
        document.getElementById('disp-nama').innerText = namaAsli;

        if (profil) {
            document.getElementById('disp-angkatan').innerText = "ANGKATAN " + (profil.angkatan || "---");
            document.getElementById('disp-email').innerText = (profil.email || "---");
            document.getElementById('disp-wa').innerText = (profil.wa || "---");
            document.getElementById('disp-ttl').innerText = (profil.ttl || "---");
        }

        let rekapBulan = {};
        let totalSeluruhnya = 0;
        iuran.forEach(t => {
            if(t.status === "SUCCESS") { 
                const nominal = Number(t.nominal) || 0;
                rekapBulan[t.bulan] = (rekapBulan[t.bulan] || 0) + nominal;
                totalSeluruhnya += nominal;
            }
        });
    
        document.getElementById('totalBayar').innerText = "Rp " + totalSeluruhnya.toLocaleString('id-ID');

        const khiGrid = document.getElementById('khiGrid');
        if (khiGrid) {
            khiGrid.innerHTML = '';
            let bulanLunasCount = 0;
            
            daftarBulan.forEach(bln => {
                const totalBayarBulanIni = rekapBulan[bln] || 0;
                const statusLunas = totalBayarBulanIni >= TARGET_IURAN;
                if(statusLunas) bulanLunasCount++;

                khiGrid.insertAdjacentHTML('beforeend', `
                    <div class="p-4 rounded-3xl border ${statusLunas ? 'bg-emerald-50/50 border-emerald-100 shadow-sm' : 'bg-slate-50/50 border-slate-100'} text-center transition-all hover:scale-105">
                        <p class="text-[8px] font-black uppercase ${statusLunas ? 'text-emerald-400' : 'text-slate-400'} tracking-widest mb-1">${bln.substring(0,3)}</p>
                        <p class="text-[11px] font-black ${statusLunas ? 'text-emerald-700' : 'text-slate-600'} italic">Rp ${totalBayarBulanIni.toLocaleString('id-ID')}</p>
                        <div class="mt-2">
                            <i class="fas ${statusLunas ? 'fa-check-circle text-emerald-500' : 'fa-clock text-slate-300'} text-xs"></i>
                        </div>
                    </div>
                `);
            });

            const persentase = Math.round((bulanLunasCount / 12) * 100);
            document.getElementById('scoreIuran').innerText = persentase + "%";
            document.getElementById('progressBar').style.width = persentase + "%";
        }

        const blnSekarang = daftarBulan[new Date().getMonth()];
        const sudahBayarBlnIni = rekapBulan[blnSekarang] || 0;
        const sisaTagihan = TARGET_IURAN - sudahBayarBlnIni;
        isLunasBulanIni = sudahBayarBlnIni >= TARGET_IURAN;

        const elStatusText = document.getElementById('currentMonthName');
        const elStatusNominal = document.getElementById('currentMonthPay');

        if (isLunasBulanIni) {
            elStatusText.innerText = "STATUS " + blnSekarang.toUpperCase();
            elStatusNominal.innerText = "LUNAS";
            elStatusNominal.className = "text-2xl font-black text-emerald-500";
        } else {
            elStatusText.innerText = "TAGIHAN " + blnSekarang.toUpperCase();
            elStatusNominal.innerText = "Rp " + (sisaTagihan > 0 ? sisaTagihan.toLocaleString('id-ID') : "0");
            elStatusNominal.className = "text-2xl font-black text-amber-500";
        }

        // 4. VERSI FINAL TABEL RIWAYAT
        const tbody = document.getElementById('riwayatBody');
        if (tbody) {
            tbody.innerHTML = ''; 
            iuran.sort((a,b) => new Date(b.date || b.tanggal) - new Date(a.date || a.tanggal)).forEach(tr => {
                
                // Pesan WA Otomatis berdasarkan baris data
                const teksWA = `Assalamualaikum Kang/Mbak%0AMohon izin untuk meminta Kwitansi Pembayaran Iuran saya atas nama:%0A*${namaAsli.toUpperCase()}*%0A%0A*Detail Transaksi:*%0A- Bulan: ${tr.bulan}%0A- Nominal: Rp ${Number(tr.nominal).toLocaleString('id-ID')}%0A%0ATerimakasih`;

                // Logika Tombol: Hanya muncul jika SUCCESS
                const tombolKwitansi = tr.status === 'SUCCESS' 
                    ? `<a href="https://api.whatsapp.com/send?phone=${NOMOR_BENDAHARA}&text=${teksWA}" 
                          target="_blank" 
                          class="text-emerald-600 hover:text-emerald-700 text-[10px] font-black flex items-center justify-center gap-1 bg-emerald-50 py-1 px-2 rounded-lg transition-all border border-emerald-100">
                          <i class="fas fa-image"></i> LIHAT
                       </a>`
                    : `<span class="text-slate-400 text-[9px] italic">Menunggu Verifikasi</span>`;

                tbody.insertAdjacentHTML('beforeend', `
                    <tr class="hover:bg-slate-50 transition-colors border-b border-slate-50">
                        <td class="p-5 uppercase text-xs font-bold tracking-tighter text-slate-700">${tr.bulan}</td>
                        <td class="p-5 text-center text-slate-400 text-xs font-medium">${tr.tanggal || tr.date}</td>
                        <td class="p-5 text-center">${tombolKwitansi}</td>
                        <td class="p-5 text-center">
                            <span class="px-2 py-1 rounded-md text-[9px] font-black uppercase ${tr.status === 'SUCCESS' ? 'bg-emerald-100 text-emerald-600' : 'bg-amber-100 text-amber-600'}">
                                ${tr.status}
                            </span>
                        </td>
                        <td class="p-5 text-right text-pnGreen font-black text-sm">Rp ${Number(tr.nominal).toLocaleString('id-ID')}</td>
                    </tr>
                `);
            });
        }

        updateMateriAccess();
    }

    // --- SISTEM UNLOCK MATERI ---
    function updateMateriAccess() {
        const mtrBtn = document.getElementById('menuMateri');
        if (!mtrBtn) return;

        if (isLunasBulanIni) {
            mtrBtn.classList.remove('text-slate-400', 'cursor-not-allowed', 'opacity-50');
            mtrBtn.classList.add('text-slate-600', 'hover:bg-slate-50');
            mtrBtn.style.cursor = 'pointer';
            
            const icons = ['lockIcon', 'lockIconDesktop'];
            icons.forEach(id => {
                const el = document.getElementById(id);
                if(el) el.className = (id === 'lockIcon') 
                    ? "fas fa-check-circle absolute -top-1 -right-2 text-[8px] text-emerald-500 md:hidden"
                    : "fas fa-check-circle text-[10px] ml-auto hidden md:block text-emerald-500 opacity-100";
            });
        }
    }

    function aksesMateri(e) {
        if (!isLunasBulanIni) {
            e.preventDefault();
            alert(`AKSES TERKUNCI!\n\nTotal iuran bulan ${daftarBulan[new Date().getMonth()]} Anda belum mencapai Rp ${TARGET_IURAN.toLocaleString('id-ID')}.\nSilakan lakukan pembayaran untuk membuka materi.`);
        } else {
            window.location.href = "materi.html";
        }
    }

    // --- LOGIKA PEMBAYARAN ---
    function previewImage(input) {
        const container = document.getElementById('previewContainer');
        const img = document.getElementById('imgPreview');
        if (input.files && input.files[0]) {
            const reader = new FileReader();
            reader.onload = function(e) {
                if(container) container.classList.add('hidden');
                if(img) {
                    img.src = e.target.result;
                    img.classList.remove('hidden');
                }
            }
            reader.readAsDataURL(input.files[0]);
        }
    }

    document.getElementById('payForm').onsubmit = async function(e) {
        e.preventDefault();
        const btn = document.getElementById('btnSubmitPay');
        const session = JSON.parse(localStorage.getItem('currentUserProfile'));
        const fileInput = document.getElementById('payBukti');
        const bulan = document.getElementById('payBulan').value;
        const nominal = document.getElementById('payNominal').value;

        if(!fileInput.files[0]) { alert("Harap unggah bukti transfer!"); return; }

        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-circle-notch fa-spin text-xl"></i> Memproses...';

        const toBase64 = file => new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = () => resolve(reader.result);
            reader.onerror = error => reject(error);
        });

        try {
            const imageBase64 = await toBase64(fileInput.files[0]);
            const payload = {
                action: "insert",
                data: {
                    id: "TRX-" + Date.now(),
                    date: new Date().toISOString().split('T')[0],
                    v1: session.nama,
                    v2: bulan,
                    v3: parseInt(nominal),
                    imageRaw: imageBase64,
                    imageName: `BUKTI_${bulan.toUpperCase()}_${session.nama.replace(/\s+/g, '_')}.jpg`,
                    status: "PENDING"
                }
            };

            const response = await fetch(SCRIPT_URL, { method: "POST", body: JSON.stringify(payload) });

            if (response.ok) {
                const tglSekarang = new Date().toLocaleDateString('id-ID', { day: '2-digit', month: '2-digit', year: 'numeric' });
                const pesanWA = `*KONFIRMASI PEMBAYARAN IURAN*%0A----------------------------------%0A*Nama:* ${session.nama}%0A*Bulan:* ${bulan}%0A*Nominal:* Rp ${Number(nominal).toLocaleString('id-ID')}%0A*Tanggal:* ${tglSekarang}%0A----------------------------------%0A_Bukti sudah diupload ke sistem. Mohon dicek._`;

                alert("Pembayaran Berhasil Dikirim!");
                window.location.href = `https://api.whatsapp.com/send?phone=${NOMOR_BENDAHARA}&text=${pesanWA}`;
            }
        } catch (err) {
            console.error(err);
            alert("Terjadi kesalahan saat mengirim data.");
        } finally {
            btn.disabled = false;
            btn.innerHTML = '<i class="fab fa-whatsapp text-xl"></i> Kirim Konfirmasi';
        }
    };

    // --- MODAL & LOGOUT ---
    function openModal() {
        const modal = document.getElementById('paymentModal');
        const content = document.getElementById('modalContent');
        modal.classList.remove('hidden');
        setTimeout(() => {
            content.classList.remove('translate-y-full', 'md:scale-90');
            content.classList.add('translate-y-0', 'md:scale-100');
        }, 10);
    }

    function closeModal() {
        const modal = document.getElementById('paymentModal');
        const content = document.getElementById('modalContent');
        content.classList.add('translate-y-full', 'md:scale-90');
        content.classList.remove('translate-y-0', 'md:scale-100');
        setTimeout(() => { modal.classList.add('hidden'); }, 300);
    }

    function logout() { 
        if(confirm("Apakah Anda yakin ingin keluar?")) {
            localStorage.clear(); 
            window.location.href = "login.html"; 
        }
    }
</script>
</body>
</html>

