<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>PROFIL SANTRI | PAGAR NUSA UNUSIA</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: { pnGreen: '#1B7548', pnDark: '#0b3d26', pnLight: '#f1f5f9' },
                    borderRadius: { 'xl': '1rem', '2xl': '1.5rem', '3xl': '2rem' }
                }
            }
        }
    </script>
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; -webkit-tap-highlight-color: transparent; }
        .sidebar-active { border-left: 4px solid #1B7548; background: #f0fdf4; color: #1B7548; }
        @media (max-width: 768px) {
            .sidebar-active { border-left: none; border-top: 3px solid #1B7548; background: transparent; }
            .no-print-mobile { display: none; }
        }
        @media print { .no-print { display: none; } }
        .modal-enter { opacity: 0; transform: scale(0.95); }
        .modal-active { opacity: 1; transform: scale(1); transition: all 0.3s ease-out; }
        
        /* Custom Scrollbar for better look */
        ::-webkit-scrollbar { width: 4px; height: 4px; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
    </style>
</head>
<body class="min-h-screen pb-20 md:pb-0">

    <div class="flex flex-col md:flex-row">
        <aside class="no-print fixed bottom-0 left-0 w-full z-40 bg-white border-t border-slate-200 md:static md:w-64 md:min-h-screen md:border-r md:p-6 md:space-y-8 shadow-[0_-2px_10px_rgba(0,0,0,0.05)] md:shadow-sm">
            <div class="hidden md:flex items-center gap-3 px-2">
                <img src="logopn.png" alt="Logo" class="h-10">
                <div>
                    <h2 class="font-extrabold text-pnDark leading-none text-lg text-emerald-800">SANTRI</h2>
                    <p class="text-[10px] font-bold text-slate-400 tracking-tighter uppercase">Pagar Nusa UNUSIA</p>
                </div>
            </div>

            <nav class="flex justify-around items-center md:block md:space-y-1">
                <p class="hidden md:block text-[10px] font-black text-slate-400 uppercase tracking-widest mb-4 px-2">Menu Utama</p>
                
                <a href="#" class="sidebar-active flex flex-col md:flex-row items-center gap-1 md:gap-3 px-4 py-3 md:rounded-xl font-bold text-[10px] md:text-sm transition-all">
                    <i class="fas fa-user-circle text-lg md:text-base md:w-5 text-center"></i> <span>Profil</span>
                </a>

                <a href="#" id="menuMateri" onclick="aksesMateri(event)" class="flex flex-col md:flex-row items-center gap-1 md:gap-3 px-4 py-3 text-slate-400 md:rounded-xl font-bold text-[10px] md:text-sm transition-all cursor-not-allowed opacity-50">
                    <div class="relative">
                        <i class="fas fa-book-open text-lg md:text-base md:w-5 text-center"></i>
                        <i id="lockIcon" class="fas fa-lock absolute -top-1 -right-1 text-[7px] text-red-500 md:hidden"></i>
                    </div>
                    <span>Materi</span>
                    <i id="lockIconDesktop" class="fas fa-lock text-[8px] ml-auto hidden md:block text-slate-400"></i>
                </a>
                
                <a href="#" onclick="openModal()" class="flex flex-col md:flex-row items-center gap-1 md:gap-3 px-4 py-3 text-emerald-600 hover:bg-emerald-50 md:rounded-xl font-bold text-[10px] md:text-sm transition-all">
                    <i class="fas fa-wallet text-lg md:text-base md:w-5 text-center"></i> <span>Bayar</span>
                </a>
                
                <a href="#" onclick="window.print()" class="flex flex-col md:flex-row items-center gap-1 md:gap-3 px-4 py-3 text-slate-500 hover:bg-slate-50 md:rounded-xl font-bold text-[10px] md:text-sm transition-all">
                    <i class="fas fa-print text-lg md:text-base md:w-5 text-center"></i> <span>Cetak</span>
                </a>
                
                <button onclick="logout()" class="flex flex-col md:flex-row items-center gap-1 md:gap-3 px-4 py-3 text-red-500 hover:bg-red-50 md:rounded-xl font-bold text-[10px] md:text-sm md:mt-10 transition-all">
                    <i class="fas fa-sign-out-alt text-lg md:text-base md:w-5 text-center"></i> <span>Keluar</span>
                </button>
            </nav>
        </aside>

        <main class="flex-1 p-4 md:p-10 space-y-6">
            <header class="flex flex-col md:flex-row md:items-center justify-between gap-4">
                <div class="text-center md:text-left">
                    <h1 class="text-xl md:text-2xl font-black text-slate-800 tracking-tight">PROFIL SANTRI</h1>
                    <p id="dateNow" class="text-[11px] md:text-sm text-slate-400 font-medium"></p>
                </div>
                
                <div class="flex items-center justify-center md:justify-end gap-4">
                    <button onclick="openModal()" class="hidden md:flex bg-pnGreen hover:bg-pnDark text-white px-5 py-2.5 rounded-full font-bold text-xs shadow-lg shadow-emerald-100 transition-all items-center gap-2">
                        <i class="fas fa-plus-circle"></i> BAYAR SEKARANG
                    </button>

                    <div class="flex items-center gap-3 bg-white p-1.5 pr-4 md:pr-6 rounded-full shadow-sm border border-slate-100">
                        <div id="avatarSmall" class="w-8 h-8 md:w-10 md:h-10 bg-pnGreen text-white rounded-full flex items-center justify-center font-bold text-xs md:text-base uppercase italic">..</div>
                        <div>
                            <p id="userSmall" class="text-[11px] md:text-xs font-bold text-slate-700 italic truncate max-w-[120px]">Memuat...</p>
                            <p class="text-[9px] text-pnGreen font-bold uppercase italic leading-none">Anggota Aktif</p>
                        </div>
                    </div>
                </div>
            </header>

            <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                <div class="bg-white p-5 rounded-3xl border border-slate-100 shadow-sm relative overflow-hidden">
                    <p class="text-[9px] font-black text-slate-400 uppercase tracking-widest mb-1">Persentase</p>
                    <h3 id="scoreIuran" class="text-2xl font-black text-pnDark italic">0%</h3>
                    <div class="w-full bg-slate-100 h-1.5 rounded-full mt-2 overflow-hidden">
                        <div id="progressBar" class="bg-pnGreen h-full transition-all duration-1000" style="width: 0%"></div>
                    </div>
                </div>

                <div class="bg-white p-5 rounded-3xl border border-slate-100 shadow-sm">
                    <p class="text-[9px] font-black text-slate-400 uppercase tracking-widest mb-1">Total Iuran</p>
                    <h3 id="totalBayar" class="text-2xl font-black text-pnGreen italic">Rp 0</h3>
                </div>

                <div class="bg-pnDark p-5 rounded-3xl shadow-lg text-white relative overflow-hidden">
                    <div class="relative z-10">
                        <p class="text-[9px] font-black text-slate-300 uppercase tracking-widest mb-1">Bulan Ini</p>
                        <h3 id="currentMonthPay" class="text-2xl font-black italic">Rp 0</h3>
                        <p id="currentMonthName" class="text-[9px] text-emerald-400 font-bold mt-1 uppercase"></p>
                    </div>
                    <i class="fas fa-coins absolute -right-3 -bottom-3 text-white/10 text-5xl rotate-12"></i>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <div class="lg:col-span-1">
                    <div class="bg-white rounded-3xl p-6 border border-slate-100 shadow-sm text-center">
                        <div id="avatarLarge" class="w-20 h-20 bg-slate-100 text-pnGreen rounded-full mx-auto mb-4 flex items-center justify-center text-2xl font-black uppercase border-4 border-slate-50">..</div>
                        <h4 id="disp-nama" class="font-black text-slate-800 uppercase tracking-tight text-sm">---</h4>
                        <p id="disp-angkatan" class="text-[10px] font-bold text-pnGreen mb-5 uppercase tracking-wider">---</p>
                        
                        <div class="space-y-3 text-left border-t pt-5">
                            <div class="flex flex-col">
                                <span class="text-[8px] font-black text-slate-400 uppercase tracking-tighter">Email</span>
                                <span id="disp-email" class="text-[11px] font-bold text-slate-700 truncate">---</span>
                            </div>
                            <div class="flex flex-col">
                                <span class="text-[8px] font-black text-slate-400 uppercase tracking-tighter">WhatsApp</span>
                                <span id="disp-wa" class="text-[11px] font-bold text-slate-700">---</span>
                            </div>
                            <div class="flex flex-col">
                                <span class="text-[8px] font-black text-slate-400 uppercase tracking-tighter">TTL</span>
                                <span id="disp-ttl" class="text-[11px] font-bold text-slate-700">---</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="lg:col-span-2 space-y-6">
                    <div class="bg-white rounded-3xl p-6 md:p-8 border border-slate-100 shadow-sm">
                        <h3 class="font-black text-slate-800 uppercase tracking-tighter mb-4 italic text-sm md:text-base border-l-4 border-pnGreen pl-3">Kartu Hasil Iuran (KHI)</h3>
                        <div class="grid grid-cols-3 sm:grid-cols-4 gap-2 md:gap-4" id="khiGrid"></div>

                        <div class="mt-10">
                            <h3 class="font-black text-slate-800 uppercase tracking-tighter text-[11px] md:text-sm mb-4 italic">Riwayat Pembayaran</h3>
                            <div class="overflow-x-auto rounded-2xl border border-slate-100">
                                <table class="w-full text-left text-[10px] md:text-xs">
                                    <thead class="bg-slate-50 text-slate-400 font-black uppercase">
                                        <tr>
                                            <th class="p-3 md:p-4">Bulan</th>
                                            <th class="p-3 md:p-4 text-center">Tanggal</th>
                                            <th class="p-3 md:p-4 text-right">Nominal</th>
                                        </tr>
                                    </thead>
                                    <tbody id="riwayatBody" class="divide-y divide-slate-100 font-bold text-slate-700 italic"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

<div id="paymentModal" class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm hidden z-50 flex items-end md:items-center justify-center p-0 md:p-4">
    <div class="bg-white rounded-t-3xl md:rounded-3xl w-full max-w-md overflow-hidden shadow-2xl transform transition-all">
        <div class="bg-pnGreen p-5 text-white flex justify-between items-center">
            <div class="flex items-center gap-3">
                <i class="fas fa-file-invoice-dollar text-lg"></i>
                <h3 class="font-black italic uppercase tracking-tighter text-sm">Konfirmasi Iuran</h3>
            </div>
            <button onclick="closeModal()" class="text-white/50 hover:text-white p-2 transition-colors"><i class="fas fa-times text-xl"></i></button>
        </div>
        
        <form id="payForm" class="p-6 md:p-8 space-y-4 max-h-[85vh] overflow-y-auto">
            <div class="bg-emerald-50 border border-emerald-100 rounded-2xl p-4 space-y-2">
                <p class="text-[10px] font-black text-emerald-800 uppercase tracking-widest">Metode Pembayaran:</p>
                <div class="flex items-center justify-between bg-white p-3 rounded-xl border border-emerald-200">
                    <div class="flex items-center gap-2">
                        <img src="https://1000logos.net/wp-content/uploads/2021/03/Dana-logo.jpg" class="h-4 object-contain" alt="DANA">
                        <span class="text-xs font-bold text-slate-700 tracking-tight">081366203248</span>
                    </div>
                    <button type="button" onclick="navigator.clipboard.writeText('081366203248'); alert('Nomor disalin!')" class="text-[10px] font-bold text-pnGreen uppercase">Salin</button>
                </div>
                <a href="https://link.dana.id/minta?full_url=https://qr.dana.id/v1/281012092026012507613151" target="_blank" class="flex items-center justify-center gap-2 w-full bg-[#118EEA] text-white py-2.5 rounded-xl text-[10px] font-bold shadow-sm">
                    <i class="fas fa-bolt"></i> KIRIM INSTAN VIA DANA
                </a>
            </div>

            <hr class="border-slate-100">

            <div>
                <label class="text-[9px] font-black text-slate-400 uppercase tracking-widest block mb-1.5">Pilih Bulan</label>
                <select id="payBulan" required class="w-full bg-slate-50 border border-slate-200 rounded-xl px-4 py-3 text-sm font-bold outline-none transition-all focus:ring-2 focus:ring-pnGreen"></select>
            </div>
            <div>
                <label class="text-[9px] font-black text-slate-400 uppercase tracking-widest block mb-1.5">Nominal (Rp)</label>
                <input type="number" id="payNominal" required value="5000" class="w-full bg-slate-50 border border-slate-200 rounded-xl px-4 py-3 text-sm font-bold outline-none transition-all focus:ring-2 focus:ring-pnGreen">
            </div>
            <div>
                <label class="text-[9px] font-black text-slate-400 uppercase tracking-widest block mb-1.5">Upload Bukti Transfer</label>
                <div class="relative group">
                    <input type="file" id="payBukti" accept="image/*" required class="hidden" onchange="previewImage(this)">
                    <label for="payBukti" class="flex flex-col items-center justify-center w-full h-24 border-2 border-dashed border-slate-200 rounded-2xl cursor-pointer bg-slate-50 hover:bg-slate-100 transition-all">
                        <div id="previewContainer" class="flex flex-col items-center justify-center text-center p-2">
                            <i class="fas fa-cloud-upload-alt text-lg text-slate-400 mb-1"></i>
                            <p class="text-[8px] font-bold text-slate-500 uppercase">Ketuk untuk pilih gambar bukti</p>
                        </div>
                        <img id="imgPreview" class="hidden h-full w-full object-cover rounded-2xl">
                    </label>
                </div>
            </div>
            
            <div class="bg-amber-50 p-3 rounded-2xl border border-amber-100">
                <p class="text-[9px] text-amber-700 font-bold uppercase leading-relaxed text-center">
                    <i class="fas fa-info-circle mr-1"></i> Data akan diverifikasi oleh Bendahara sebelum muncul di profil.
                </p>
            </div>

            <button type="submit" id="btnSubmitPay" class="w-full bg-pnDark text-white font-black py-4 rounded-2xl shadow-xl hover:bg-black transition-all uppercase tracking-widest text-[10px] flex items-center justify-center gap-2">
                <i class="fab fa-whatsapp text-lg"></i> KIRIM KE BENDAHARA
            </button>
        </form>
    </div>
</div>

<script>
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycby4KcQwRiUVLXhf5dEd1ZGMxTXfjJQQ_XzcDfLw2ikPca7VYDZZr3hE4vcjZYibbMT-zw/exec";
    const daftarBulan = ["Januari", "Februari", "Maret", "April", "Mei", "Juni", "Juli", "Agustus", "September", "Oktober", "November", "Desember"];
    const NOMOR_BENDAHARA = "6285715232441"; 
    
    // Variabel kontrol akses materi
    let isLunasBulanIni = false;

    window.onload = async () => {
        document.getElementById('dateNow').innerText = new Date().toLocaleDateString('id-ID', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
        const session = JSON.parse(localStorage.getItem('currentUserProfile'));
        if (!session || !session.nama) { window.location.href = "login.html"; return; }
        const payBulanSelect = document.getElementById('payBulan');
        if (payBulanSelect) {
            payBulanSelect.innerHTML = '';
            daftarBulan.forEach(b => {
                const opt = document.createElement('option');
                opt.value = b;
                opt.innerText = b;
                if(b === daftarBulan[new Date().getMonth()]) opt.selected = true;
                payBulanSelect.appendChild(opt);
            });
        }
        fetchData();
    };

    async function fetchData() {
        const session = JSON.parse(localStorage.getItem('currentUserProfile'));
        const userNama = session.nama.trim().toLowerCase();
        try {
            const response = await fetch(`${SCRIPT_URL}?action=read&nocache=${new Date().getTime()}`);
            const result = await response.json(); 
            const profil = result.santri.find(s => s.nama.trim().toLowerCase() === userNama);
            const iuran = result.iuran.filter(i => i.nama.trim().toLowerCase() === userNama && i.status !== "PENDING");
            renderData(profil, iuran, session.nama);
        } catch (err) {
            console.error("Fetch Error:", err);
            alert("Gagal memuat data terbaru.");
        }
    }

    function renderData(profil, iuran, namaAsli) {
        document.getElementById('userSmall').innerText = namaAsli;
        document.getElementById('avatarSmall').innerText = namaAsli.substring(0,2).toUpperCase();
        document.getElementById('avatarLarge').innerText = namaAsli.substring(0,2).toUpperCase();
        document.getElementById('disp-nama').innerText = namaAsli;
        if(profil) {
            document.getElementById('disp-angkatan').innerText = "ANGKATAN " + (profil.angkatan || "---");
            document.getElementById('disp-email').innerText = (profil.email || "---");
            document.getElementById('disp-wa').innerText = (profil.wa || "---");
            document.getElementById('disp-ttl').innerText = (profil.ttl || "---");
        }
        let rekap = {};
        let totalDiterima = 0;
        iuran.forEach(t => {
            rekap[t.bulan] = (rekap[t.bulan] || 0) + Number(t.nominal);
            totalDiterima += Number(t.nominal);
        });
        document.getElementById('totalBayar').innerText = "Rp " + totalDiterima.toLocaleString('id-ID');
        let bulanLunas = 0;
        const khiGrid = document.getElementById('khiGrid');
        khiGrid.innerHTML = '';
        daftarBulan.forEach(bln => {
            let bayar = rekap[bln] || 0;
            let status = bayar >= 5000;
            if(status) bulanLunas++;
            khiGrid.insertAdjacentHTML('beforeend', `
                <div class="p-2 md:p-3 rounded-2xl border ${status ? 'bg-emerald-50 border-emerald-100' : 'bg-slate-50 border-slate-100'} text-center transition-all">
                    <p class="text-[7px] md:text-[8px] font-black uppercase text-slate-400 tracking-tighter">${bln.substring(0,3)}</p>
                    <p class="text-[9px] md:text-[11px] font-black ${status ? 'text-emerald-700' : 'text-slate-600'}">Rp ${bayar.toLocaleString('id-ID')}</p>
                    <i class="fas ${status ? 'fa-check-circle text-emerald-500' : 'fa-clock text-slate-300'} text-[8px] md:text-[10px] mt-1"></i>
                </div>
            `);
        });
        const persentase = Math.round((bulanLunas / 12) * 100);
        document.getElementById('scoreIuran').innerText = persentase + "%";
        document.getElementById('progressBar').style.width = persentase + "%";
        const blnIni = daftarBulan[new Date().getMonth()];
        document.getElementById('currentMonthName').innerText = "Status " + blnIni;
        document.getElementById('currentMonthPay').innerText = "Rp " + (rekap[blnIni] || 0).toLocaleString('id-ID');
        
        // --- UPDATE LOGIKA AKSES MATERI ---
        isLunasBulanIni = (rekap[blnIni] || 0) >= 5000;
        const mtrBtn = document.getElementById('menuMateri');
        if (mtrBtn && isLunasBulanIni) {
            mtrBtn.classList.remove('text-slate-400', 'cursor-not-allowed', 'opacity-50');
            mtrBtn.classList.add('text-slate-600', 'hover:bg-slate-50');
            mtrBtn.style.cursor = 'pointer';
            const lkMob = document.getElementById('lockIcon');
            const lkDesk = document.getElementById('lockIconDesktop');
            if(lkMob) lkMob.className = "fas fa-check-circle absolute -top-1 -right-1 text-[7px] text-emerald-500 md:hidden";
            if(lkDesk) lkDesk.className = "fas fa-check-circle text-[8px] ml-auto hidden md:block text-emerald-500";
        }
        // ----------------------------------

        const tbody = document.getElementById('riwayatBody');
        tbody.innerHTML = '';
        [...iuran].reverse().forEach(tr => {
            tbody.insertAdjacentHTML('beforeend', `
                <tr class="hover:bg-slate-50 transition-colors">
                    <td class="p-3 md:p-4 uppercase">${tr.bulan}</td>
                    <td class="p-3 md:p-4 text-center text-slate-400 font-medium">${tr.tanggal}</td>
                    <td class="p-3 md:p-4 text-right text-pnGreen font-black">Rp ${Number(tr.nominal).toLocaleString('id-ID')}</td>
                </tr>
            `);
        });
    }

    // Fungsi Handler Klik Materi
    function aksesMateri(e) {
        if (!isLunasBulanIni) {
            e.preventDefault();
            alert("Akses Terkunci! Silakan lunasi iuran bulan " + daftarBulan[new Date().getMonth()] + " terlebih dahulu.");
        } else {
            window.location.href = "materi.html";
        }
    }

    function previewImage(input) {
        const container = document.getElementById('previewContainer');
        const img = document.getElementById('imgPreview');
        if (input.files && input.files[0]) {
            const reader = new FileReader();
            reader.onload = function(e) {
                if(container) container.classList.add('hidden');
                if(img) {
                    img.src = e.target.result;
                    img.classList.remove('hidden');
                }
            }
            reader.readAsDataURL(input.files[0]);
        }
    }

    function openModal() {
        const modal = document.getElementById('paymentModal');
        modal.classList.remove('hidden');
        setTimeout(() => { modal.firstElementChild.classList.add('modal-active'); }, 10);
    }

    function closeModal() {
        const modal = document.getElementById('paymentModal');
        modal.firstElementChild.classList.remove('modal-active');
        setTimeout(() => { modal.classList.add('hidden'); }, 300);
    }

    document.getElementById('payForm').onsubmit = async function(e) {
        e.preventDefault();
        const btn = document.getElementById('btnSubmitPay');
        const session = JSON.parse(localStorage.getItem('currentUserProfile'));
        const bulan = document.getElementById('payBulan').value;
        const nominal = document.getElementById('payNominal').value;
        const fileInput = document.getElementById('payBukti');
        if (!fileInput.files[0]) { alert("Mohon upload bukti pembayaran."); return; }
        btn.disabled = true;
        btn.innerHTML = `<i class="fas fa-circle-notch fa-spin"></i> MEMPROSES...`;
        const payload = {
            action: "insert",
            data: {
                v1: session.nama,
                v2: bulan,
                v3: nominal,
                date: new Date().toISOString().split('T')[0],
                status: "PENDING"
            }
        };
        try {
            await fetch(SCRIPT_URL, { method: "POST", mode: "no-cors", body: JSON.stringify(payload) });
            const tglSekarang = new Date().toLocaleDateString('id-ID', { day: '2-digit', month: '2-digit', year: 'numeric' });
            const pesanText = `*KONFIRMASI PEMBAYARAN IURAN*%0A` +
                              `----------------------------------%0A` +
                              `*Nama Santri:* ${session.nama}%0A` +
                              `*Pembayaran Bulan:* ${bulan}%0A` +
                              `*Nominal:* Rp ${Number(nominal).toLocaleString('id-ID')}%0A` +
                              `*Tanggal:* ${tglSekarang}%0A` +
                              `----------------------------------%0A` +
                              `_Data sudah masuk ke sistem dengan status PENDING._`;
            window.open(`https://wa.me/${NOMOR_BENDAHARA}?text=${pesanText}`, '_blank');
            alert("Data berhasil dikirim!");
            this.reset();
            document.getElementById('imgPreview').classList.add('hidden');
            document.getElementById('previewContainer').classList.remove('hidden');
            closeModal();
            fetchData();
        } catch (err) {
            alert("Terjadi kesalahan koneksi.");
        } finally {
            btn.disabled = false;
            btn.innerText = "Kirim ke Bendahara";
        }
    };

    function logout() { localStorage.clear(); window.location.href = "login.html"; }
</script>
</body>

</html>
